<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>SpringCloud Alibaba 之 Sentinel（三） | BETTER LATE THAN NEVER</title><meta name="description" content="SpringCloud Alibaba 之 Sentinel（三）"><meta name="keywords" content="JAVA,Spring Cloud Alibaba,Sentinel,框架"><meta name="author" content="Frosro"><meta name="copyright" content="Frosro"><meta name="format-detection" content="telephone=no"><link rel="shortcut icon" href="/img/favicon.png"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="https://fonts.googleapis.com" crossorigin="crossorigin"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><meta name="twitter:card" content="summary"><meta name="twitter:title" content="SpringCloud Alibaba 之 Sentinel（三）"><meta name="twitter:description" content="SpringCloud Alibaba 之 Sentinel（三）"><meta name="twitter:image" content="https://frosro.github.io/img/post.jpg"><meta property="og:type" content="article"><meta property="og:title" content="SpringCloud Alibaba 之 Sentinel（三）"><meta property="og:url" content="https://frosro.github.io/2022/02/26/SpringCloudAlibaba%E4%B9%8BSentinel-3/"><meta property="og:site_name" content="BETTER LATE THAN NEVER"><meta property="og:description" content="SpringCloud Alibaba 之 Sentinel（三）"><meta property="og:image" content="https://frosro.github.io/img/post.jpg"><script src="https://cdn.jsdelivr.net/npm/js-cookie/dist/js.cookie.min.js"></script><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><link rel="canonical" href="https://frosro.github.io/2022/02/26/SpringCloudAlibaba%E4%B9%8BSentinel-3/"><link rel="next" title="SpringCloud Alibaba 之 Sentinel（二）" href="https://frosro.github.io/2022/02/10/SpringCloudAlibaba%E4%B9%8BSentinel-2/"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容:${query}"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"cookieDomain":"https://xxx/","msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  bookmark: {
    message_prev: '按',
    message_next: '键将本页加入书签'
  },
  runtime_unit: '天',
  runtime: true,
  copyright: undefined,
  ClickShowText: undefined,
  medium_zoom: false,
  fancybox: true,
  Snackbar: undefined,
  baiduPush: true,
  highlightCopy: true,
  highlightLang: true,
  highlightShrink: 'true',
  isFontAwesomeV5: false,
  isPhotoFigcaption: false
  
}</script><script>var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isSidebar: true  
  }</script><noscript><style>
#page-header {
  opacity: 1
}
.justified-gallery img{
  opacity: 1
}
</style></noscript><meta name="generator" content="Hexo 4.2.0"><link rel="alternate" href="/atom.xml" title="BETTER LATE THAN NEVER" type="application/atom+xml">
</head><body><canvas class="fireworks"></canvas><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="avatar-img" src="/img/avatar.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="mobile_post_data"><div class="mobile_data_item is-center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">文章</div><div class="length_num">32</div></a></div></div><div class="mobile_data_item is-center">      <div class="mobile_data_link"><a href="/tags/"><div class="headline">标签</div><div class="length_num">40</div></a></div></div><div class="mobile_data_item is-center">     <div class="mobile_data_link"><a href="/categories/"><div class="headline">分类</div><div class="length_num">3</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> 清单</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fa fa-music"></i><span> Music</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fa fa-film"></i><span> Movie</span></a></li></ul></div></div></div></div><i class="fa fa-arrow-right on" id="toggle-sidebar" aria-hidden="true">     </i><div id="sidebar"><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#五、Spring-Cloud-集成Sentinel实践"><span class="toc-number">1.</span> <span class="toc-text">五、Spring Cloud 集成Sentinel实践</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1、Sentinel接入Spring-Cloud"><span class="toc-number">1.1.</span> <span class="toc-text">1、Sentinel接入Spring Cloud</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2、基于Sentinel-Dashboard-来实现流控配置"><span class="toc-number">1.2.</span> <span class="toc-text">2、基于Sentinel Dashboard 来实现流控配置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3、自定义URL限流异常"><span class="toc-number">1.3.</span> <span class="toc-text">3、自定义URL限流异常</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4、URL-资源清洗"><span class="toc-number">1.4.</span> <span class="toc-text">4、URL 资源清洗</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#六、Sentinel-集成-Nacos-实现动态流控规则"><span class="toc-number">2.</span> <span class="toc-text">六、Sentinel 集成 Nacos 实现动态流控规则</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#七、-Sentinel-Dashboard-集成Nacos实现规则同步"><span class="toc-number">3.</span> <span class="toc-text">七、 Sentinel Dashboard 集成Nacos实现规则同步</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1、-Sentinel-Dashboard-源码修改"><span class="toc-number">3.1.</span> <span class="toc-text">1、 Sentinel Dashboard 源码修改</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2、Sentinel-Dashboard-规则数据同步"><span class="toc-number">3.2.</span> <span class="toc-text">2、Sentinel Dashboard 规则数据同步</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#八、Dubbo-集成-Sentinel-实现限流"><span class="toc-number">4.</span> <span class="toc-text">八、Dubbo 集成 Sentinel 实现限流</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1、Dubbo服务接入Sentinel-Dashborad"><span class="toc-number">4.1.</span> <span class="toc-text">1、Dubbo服务接入Sentinel Dashborad</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2、Dubbo-服务限流规则配置"><span class="toc-number">4.2.</span> <span class="toc-text">2、Dubbo 服务限流规则配置</span></a></li></ol></li></ol></div></div></div><div id="body-wrap"><div class="post-bg" id="nav" style="background-image: url(/img/post.jpg)"><div id="page-header"><span class="pull_left" id="blog_name"><a class="blog_title" id="site-name" href="/">BETTER LATE THAN NEVER</a></span><span class="pull_right menus"><div id="search_button"><a class="site-page social-icon search"><i class="fa fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> 清单</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fa fa-music"></i><span> Music</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fa fa-film"></i><span> Movie</span></a></li></ul></div></div><span class="toggle-menu close"><a class="site-page"><i class="fa fa-bars fa-fw" aria-hidden="true"></i></a></span></span></div><div id="post-info"><div id="post-title"><div class="posttitle">SpringCloud Alibaba 之 Sentinel（三）</div></div><div id="post-meta"><div class="meta-firstline"><time class="post-meta__date"><span class="post-meta__date-created" title="发表于 2022-02-26 07:42:50"><i class="fa fa-calendar" aria-hidden="true"></i> 发表于 2022-02-26</span><span class="post-meta__separator">|</span><span class="post-meta__date-updated" title="更新于 2022-03-08 07:53:46"><i class="fa fa-history" aria-hidden="true"></i> 更新于 2022-03-08</span></time><span class="post-meta__categories"><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/%F0%9F%90%82%E6%A1%86%E6%9E%B6/">🐂框架</a></span></div><div class="meta-secondline"> </div><div class="meta-thirdline"><span class="post-meta-pv-cv"><i class="fa fa-eye post-meta__icon" aria-hidden="true"> </i><span>阅读量:</span><span id="busuanzi_value_page_pv"></span></span><span class="post-meta-commentcount"></span></div></div></div></div><main class="layout_post" id="content-inner"><article id="post"><div id="article-container"><h3 id="五、Spring-Cloud-集成Sentinel实践"><a href="#五、Spring-Cloud-集成Sentinel实践" class="headerlink" title="五、Spring Cloud 集成Sentinel实践"></a>五、Spring Cloud 集成Sentinel实践</h3><h4 id="1、Sentinel接入Spring-Cloud"><a href="#1、Sentinel接入Spring-Cloud" class="headerlink" title="1、Sentinel接入Spring Cloud"></a>1、Sentinel接入Spring Cloud</h4><ul>
<li><p>创建一个基于Spring Boot的项目</p>
</li>
<li><p>添加Sentinel依赖包</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-sentinel<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.2.0.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>创建一个REST接口，并通过@SentinelResource 配置限流保护资源</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@SentinelResource</span>(value = <span class="string">"hello"</span>,blockHandler = <span class="string">"blockHandlerHello"</span>)</span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/say"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">hello</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"hello cs-go"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">blockHandlerHello</span><span class="params">(BlockException e)</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"被限流了"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>Sentinel starter 在默认情况下会为所有的HTTP服务提供限流埋点，所有如果只想对HTTP服务进行限流，那么只需要添加依赖即可，不需要修改任何代码。</li>
<li>如果想要对特定的方法进行限流或者降级，则需要通过@SentinelResouce注解来实现限流资源的定义</li>
<li>可以通过 SphU.entry()方法来配置资源</li>
</ul>
</li>
<li><p>手动配置流控规则，可以借用Sentinel的InitFunc SPI 扩展接口来实现</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FlowRuleInitFunc</span> <span class="keyword">implements</span> <span class="title">InitFunc</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        List&lt;FlowRule&gt; flowRuleList = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        FlowRule rule = <span class="keyword">new</span> FlowRule();</span><br><span class="line">        rule.setCount(<span class="number">1</span>);</span><br><span class="line">        rule.setResource(<span class="string">"hello"</span>);</span><br><span class="line">        rule.setGrade(RuleConstant.FLOW_GRADE_QPS);</span><br><span class="line">        rule.setLimitApp(<span class="string">"default"</span>);</span><br><span class="line">        flowRuleList.add(rule);</span><br><span class="line">        FlowRuleManager.loadRules(flowRuleList);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>SPI 是扩展点机制，如果需要被Sentinel加载，要么还要在resouce目录下创建 <code>META-INF\services\com.alibaba.csp.sentinel.init.InitFunc</code>按照上述配置好后，在初次访问任何资源的时候，Sentinel就会自动加载hello资源的流控规则</strong></p>
</li>
<li><p>启动服务后，访问localhost:8080/say方法， 当访问频率超过设定阈值时，就会触发限流。</p>
</li>
</ul>
<h4 id="2、基于Sentinel-Dashboard-来实现流控配置"><a href="#2、基于Sentinel-Dashboard-来实现流控配置" class="headerlink" title="2、基于Sentinel Dashboard 来实现流控配置"></a>2、基于Sentinel Dashboard 来实现流控配置</h4><ul>
<li><p>启动 Sentinel Dashboard</p>
</li>
<li><p>在application.properties添加配置：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">spring.application.name</span>=<span class="string">spring-cloud-sentinel-sample</span></span><br><span class="line"><span class="comment"># 指的是Sentinel Dashboard的服务器地址，可以实现流控数据的监控和流控规则的分发</span></span><br><span class="line"><span class="meta">spring.cloud.sentinel.transport.dashboard</span>=<span class="string">localhost:8080</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>提供一个REST接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DashboardController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 此处不需要添加任何的资源埋点，在默认情况下Sentinel Starter会对所有Http请求进行限流。</span></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/dash"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">dash</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"hello dash"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>启动服务后，此时访问 /dash接口，由于没有配置流控规则，所有不存在流控行为。</p>
<p>集成Sentinel就配置完成了，接下来，进入Sentinel Dashboard来实现流控规则的配置</p>
</li>
<li><p>访问 Sentinel Dashboard的地址</p>
</li>
<li><p>点击”簇点链接“，点击“流控”，设置单机阈值为1</p>
</li>
<li><p>添加完成后，访问对应接口，当QPS超过1时，就可以看到限流的效果</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Blocked by <span class="title">Sentinel</span><span class="params">(flow limiting)</span></span></span><br></pre></td></tr></table></figure>



</li>
</ul>
<h4 id="3、自定义URL限流异常"><a href="#3、自定义URL限流异常" class="headerlink" title="3、自定义URL限流异常"></a>3、自定义URL限流异常</h4><p>在默认情况下，URL触发限流后会直接返回。</p>
<figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Blocked by Sentinel(flow limiting)</span><br></pre></td></tr></table></figure>

<p>在实际应用中，大都采用 JSON 格式的数据，所以如果希望修改触发限流之后的返回结果形式，则可以通过自定义限流异常来处理，实现BlockExceptionHandler接口并重写handle方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomUrlBlockHandler</span> <span class="keyword">implements</span> <span class="title">BlockExceptionHandler</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handle</span><span class="params">(HttpServletRequest httpServletRequest, HttpServletResponse httpServletResponse, BlockException e)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        httpServletResponse.setHeader(<span class="string">"Content-Type"</span>,<span class="string">"application/json;charset=UTF-8"</span>);</span><br><span class="line">        String message = <span class="string">"&#123;\"code\":999,\"msg\":\"访问人数过多\"&#125;"</span>;</span><br><span class="line">        httpServletResponse.getWriter().write(message);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>还有一个场景时，当触发限流之后，我们希望直接跳转到一个降级页面，可以通过下面这个配置来实现</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">spring.cloud.sentinel.block-page</span>=<span class="string">&#123;url&#125;</span></span><br></pre></td></tr></table></figure>

<h4 id="4、URL-资源清洗"><a href="#4、URL-资源清洗" class="headerlink" title="4、URL 资源清洗"></a>4、URL 资源清洗</h4><p>Sentinel中的HTTP服务限流默认由Sentinel-Web-Servlet 包中的CommonFilter 来实现，从代码中可以看到，这个Filter会把每个URL 都作为不同的资源来处理。</p>
<p>但如果是携带{id}参数的 REST 风格 API （例如：@GetMapping(“clean/{id}”)），对于每一个不同的{id}，URL 也都是不一样的，所以默认情况下 Sentinel  会把所有的URL都当作资源来进行流控。</p>
<p>这样会导致两个问题</p>
<ul>
<li>限流统计的不准确，实际需求是控制clean方法总的QPS，结果统计的是每个URL的QPS。</li>
<li>导致Sentinel中的资源数量过多，默认资源数量的阈值是6000，对于多出来的资源规则将不会生效。</li>
</ul>
<p>针对这个问题可以通过 UrlCleaner 接口来实现资源清洗，也就是对于/clean/{id} 这个Url我们可以统一归集到/clean/* 资源下，具体配置代码如下，实现UrlCleaner 接口，并重写clean方法即可。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomerUrlCleaner</span> <span class="keyword">implements</span> <span class="title">UrlCleaner</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">clean</span><span class="params">(String originUrl)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (StringUtil.isEmpty(originUrl))&#123;</span><br><span class="line">            <span class="keyword">return</span> originUrl;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (originUrl.startsWith(<span class="string">"/clean/"</span>))&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"/clean/*"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> originUrl;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="六、Sentinel-集成-Nacos-实现动态流控规则"><a href="#六、Sentinel-集成-Nacos-实现动态流控规则" class="headerlink" title="六、Sentinel 集成 Nacos 实现动态流控规则"></a>六、Sentinel 集成 Nacos 实现动态流控规则</h3><p>Sentinel的理念是只需要开发者关注资源的定义，他会默认对资源进行流控，当然，我们还需要对定义的资源设置流控规则：</p>
<ul>
<li>通过FlowRuleManager.loadRules (List rules) 手动加载流控规则。</li>
<li>在Sentinel Dashboard 上针对资源动态创建流控规则。</li>
</ul>
<p><strong>基于Sentinel Dashboard所配置的流控规则，都是保存在内存中的，一旦重启，这些规则就会被清除。</strong></p>
<p>Sentinel还支持很多数据源的扩展，下面演示Spring Cloud Sentinel 集成 Nacos 实现动态流控规则：</p>
<ul>
<li><p>添加数据源的依赖包</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">&lt;dependency&gt;</span></span><br><span class="line">    <span class="attr">&lt;groupId&gt;com.alibaba.csp&lt;/groupId&gt;</span></span><br><span class="line">    <span class="attr">&lt;artifactId&gt;sentinel-datasource-nacos&lt;/artifactId&gt;</span></span><br><span class="line">    <span class="attr">&lt;version&gt;1.7.0&lt;/version&gt;</span></span><br><span class="line"><span class="attr">&lt;/dependency&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>创建REST接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DynamicController</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/dynamic"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">dynamic</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"HELLO Dynamic Rule"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>添加数据源配置</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">spring.cloud.sentinel.datasource[0].nacos.server-addr</span>=<span class="string">localhost:8848</span></span><br><span class="line"><span class="meta">spring.cloud.sentinel.datasource[0].nacos.data-id</span>=<span class="string">$&#123;spring.application.name&#125;-sentinel</span></span><br><span class="line"><span class="meta">spring.cloud.sentinel.datasource[0].nacos.group-id</span>=<span class="string">DEFAULT_GROUP</span></span><br><span class="line"><span class="meta">spring.cloud.sentinel.datasource[0].nacos.data-type</span>=<span class="string">json</span></span><br><span class="line"><span class="meta">spring.cloud.sentinel.datasource[0].nacos.rule-type</span>=<span class="string">flow</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>登录Nacos 控制台，创建流控配置规则</p>
</li>
<li><p>登录 Sentinel Dashboard ,找到执行项目名称菜单下的“流控规则”，就可以看到在Nacos上所配置的流控规则已经被加载了</p>
</li>
<li><p>当我们在Nacos上修改流控规则后，可以同步在Sentinel Dashboard 上看到流控规则的变化</p>
</li>
</ul>
<p><strong>问题</strong>：在Nacos控制台上修改流控规则，虽然可以同步到Sentinel Dashboard ,但是Nacos此时应该作为一个流控规则的持久化平台，所以正常的操作过程应该是开发者在Sentinel Dashboard 上修改流控规则后同步到Nacos上，遗憾的是，目前Sentinel Dashboard没有这个功能。直接在Nacos上修改流控规则，这种修改方式的危险系数很高，毕竟Sentinel Dashboard的 UI 才是专门负责流控规则维护的。</p>
<p>所以我们需要实现Sentinel Dashboard来动态维护流控规则并同步到Nacos上，目前官方没有提供支持，但是大家可以自己来实现。</p>
<hr>
<h3 id="七、-Sentinel-Dashboard-集成Nacos实现规则同步"><a href="#七、-Sentinel-Dashboard-集成Nacos实现规则同步" class="headerlink" title="七、 Sentinel Dashboard 集成Nacos实现规则同步"></a>七、 Sentinel Dashboard 集成Nacos实现规则同步</h3><p>Sentinel Dashboard 的”流控规则“下的所有操作，都会调用 Sentinel Dashboard源码中的 <strong>FlowControllerV1</strong>这个类，这个类中包含流控规则本地化的CRUD操作。</p>
<p>另外，包下还存在一个<strong>FlowControllerV2</strong>类，这个类同样提供流控规则的CRUD，和V1版本不同的是，它可以实现指定数据源的规则拉取和发布，下面是部分代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(value = <span class="string">"/v2/flow"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FlowControllerV2</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Logger logger = LoggerFactory.getLogger(FlowControllerV2<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> InMemoryRuleRepositoryAdapter&lt;FlowRuleEntity&gt; repository;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="meta">@Qualifier</span>(<span class="string">"flowRuleDefaultProvider"</span>)</span><br><span class="line">    <span class="comment">// 动态规则的拉取，从指定数据源中获取流控规则后在Sentinel Dashboard 中展示。</span></span><br><span class="line">    <span class="keyword">private</span> DynamicRuleProvider&lt;List&lt;FlowRuleEntity&gt;&gt; ruleProvider;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="meta">@Qualifier</span>(<span class="string">"flowRuleDefaultPublisher"</span>)</span><br><span class="line">    <span class="comment">// 动态规则的发布，将Sentinel Dashboard中修改的规则同步到指定数据源中。</span></span><br><span class="line">    <span class="keyword">private</span> DynamicRulePublisher&lt;List&lt;FlowRuleEntity&gt;&gt; rulePublisher;</span><br></pre></td></tr></table></figure>

<p>这里我们扩展这两个类，然后集成Nacos来实现Sentinel Dashboard 规则的同步。</p>
<h4 id="1、-Sentinel-Dashboard-源码修改"><a href="#1、-Sentinel-Dashboard-源码修改" class="headerlink" title="1、 Sentinel Dashboard 源码修改"></a>1、 Sentinel Dashboard 源码修改</h4><ul>
<li><p>下载    Sentinel Dashboard 源码并打开工程</p>
</li>
<li><p>在pom.xml文件中把sentinel-datasource-nacos依赖的<scope>注释掉</scope></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.csp<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>sentinel-datasource-nacos<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--            &lt;scope&gt;test&lt;/scope&gt;--&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>修改 src\main\webapp\resources\app\scripts\directives\sidebar\sidebar.html 文件下的如下代码，将dashboard.flowV1 改为 dashboard.flow</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">li</span> <span class="attr">ui-sref-active</span>=<span class="string">"active"</span> <span class="attr">ng-if</span>=<span class="string">"!entry.isGateway"</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--            &lt;a ui-sref="dashboard.flowV1(&#123;app: entry.app&#125;)"&gt;--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">a</span> <span class="attr">ui-sref</span>=<span class="string">"dashboard.flow(&#123;app: entry.app&#125;)"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">"glyphicon glyphicon-filter"</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span><span class="symbol">&amp;nbsp;</span><span class="symbol">&amp;nbsp;</span>流控规则</span><br><span class="line">    <span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>修改之后，会调用FlowControllerV2中的接口</p>
</li>
<li><p>在com.alibaba.csp.sentinel.dashboard.rule 包中创建一个nacos包，并创建一个类用来加载外部化配置。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.alibaba.csp.sentinel.dashboard.rule.nacos;</span><br><span class="line"></span><br><span class="line"><span class="meta">@ConfigurationProperties</span>(prefix = <span class="string">"sentinel.nacos"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NacosPropertiesConfiguration</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> String serverAddr;</span><br><span class="line">    <span class="keyword">private</span> String dataId;</span><br><span class="line">    <span class="keyword">private</span> String groupId = <span class="string">"DEFAULT_GROUP"</span>;</span><br><span class="line">    <span class="keyword">private</span> String namespace;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getServerAddr</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> serverAddr;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setServerAddr</span><span class="params">(String serverAddr)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.serverAddr = serverAddr;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getDataId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> dataId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setDataId</span><span class="params">(String dataId)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.dataId = dataId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getGroupId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> groupId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setGroupId</span><span class="params">(String groupId)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.groupId = groupId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getNamespace</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> namespace;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setNamespace</span><span class="params">(String namespace)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.namespace = namespace;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建一个Nacos配置类NacosConfiguration</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableConfigurationProperties</span>(NacosPropertiesConfiguration<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">@<span class="title">Configuration</span></span></span><br><span class="line"><span class="class"><span class="title">public</span> <span class="title">class</span> <span class="title">NacosConfiguration</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Converter&lt;List&lt;FlowRuleEntity&gt;,String&gt; flowRuleEntityEncoder()&#123;</span><br><span class="line">        <span class="keyword">return</span> JSON::toJSONString;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Converter&lt;String,List&lt;FlowRuleEntity&gt;&gt; flowRuleEntityDecoder()&#123;</span><br><span class="line">        <span class="keyword">return</span> s -&gt; JSON.parseArray(s,FlowRuleEntity<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ConfigService <span class="title">nacosConfigService</span><span class="params">(NacosPropertiesConfiguration nacosPropertiesConfiguration)</span> <span class="keyword">throws</span> NacosException </span>&#123;</span><br><span class="line">        Properties properties = <span class="keyword">new</span> Properties();</span><br><span class="line">        properties.put(PropertyKeyConst.SERVER_ADDR,nacosPropertiesConfiguration.getServerAddr());</span><br><span class="line">        properties.put(PropertyKeyConst.NAMESPACE,nacosPropertiesConfiguration.getNamespace());</span><br><span class="line">        <span class="keyword">return</span> ConfigFactory.createConfigService(properties);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>注入Converter 转换器，将FlowRuleEntity 转化为 FlowRule，以及反向转化</p>
</li>
<li><p>注入Nacos配置服务ConfigService</p>
</li>
</ul>
</li>
</ul>
<ul>
<li><p>创建一个常量类 NacosConstants ，分别表示默认的 GROUP_ID 和 DATA_ID 的后缀</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NacosConstants</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String DATA_ID_POSTFIX = <span class="string">"-sentinel-flow"</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String GROUP_ID = <span class="string">"DEFAULT_GROUP"</span>;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>实现动态从Nacos配置中心获取流控规则</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FlowRuleNacosProvider</span> <span class="keyword">implements</span> <span class="title">DynamicRuleProvider</span>&lt;<span class="title">List</span>&lt;<span class="title">FlowRuleEntity</span>&gt;&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Logger logger = LoggerFactory.getLogger(FlowRuleNacosProvider<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> NacosPropertiesConfiguration nacosConfigProperties;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ConfigService configService;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> Converter&lt;String, List&lt;FlowRuleEntity&gt;&gt; converter;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;FlowRuleEntity&gt; <span class="title">getRules</span><span class="params">(String appName)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">        String dataID = <span class="keyword">new</span> StringBuilder(appName).append(NacosConstants.DATA_ID_POSTFIX).toString();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 通过该方法从Nacos Config Server中读取指定配置信息，并通过converter转化为FlowRule 规则</span></span><br><span class="line">        String rules = configService.getConfig(dataID,</span><br><span class="line">                nacosConfigProperties.getGroupId(), <span class="number">3000</span>);</span><br><span class="line">        logger.info(<span class="string">"pull FlowRule from Nacos Config:&#123;&#125;"</span>,rules);</span><br><span class="line">        <span class="keyword">if</span> (StringUtil.isEmpty(rules)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> converter.convert(rules);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建一个流控规则发布类，在Sentinel Dashboard上修改完配置之后，需要调用该发布方法将数据持久化到Nacos中。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FlowRuleNacosPublisher</span> <span class="keyword">implements</span> <span class="title">DynamicRulePublisher</span>&lt;<span class="title">List</span>&lt;<span class="title">FlowRuleEntity</span>&gt;&gt; </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> NacosPropertiesConfiguration nacosPropertiesConfiguration;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ConfigService configService;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> Converter&lt;List&lt;FlowRuleEntity&gt;, String&gt; converter;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">publish</span><span class="params">(String appName, List&lt;FlowRuleEntity&gt; rules)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        AssertUtil.notEmpty(appName, <span class="string">"appName cannot be empty"</span>);</span><br><span class="line">        <span class="keyword">if</span> (rules == <span class="keyword">null</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        String dataID = <span class="keyword">new</span> StringBuilder(appName).append(NacosConstants.DATA_ID_POSTFIX).toString();</span><br><span class="line">        configService.publishConfig(dataID,nacosPropertiesConfiguration.getGroupId(),converter.convert(rules));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>修改FlowControllerV2类，将上面配置的两个类注入进来，表示规则的拉取和规则的发布统一用我们之前自定义的两个实例</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line"><span class="comment">//    @Qualifier("flowRuleDefaultProvider")</span></span><br><span class="line">    <span class="meta">@Qualifier</span>(<span class="string">"flowRuleNacosProvider"</span>)</span><br><span class="line">    <span class="keyword">private</span> DynamicRuleProvider&lt;List&lt;FlowRuleEntity&gt;&gt; ruleProvider;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line"><span class="comment">//    @Qualifier("flowRuleDefaultPublisher")</span></span><br><span class="line">    <span class="meta">@Qualifier</span>(<span class="string">"flowRuleNacosPublisher"</span>)</span><br><span class="line">    <span class="keyword">private</span> DynamicRulePublisher&lt;List&lt;FlowRuleEntity&gt;&gt; rulePublisher;</span><br></pre></td></tr></table></figure>
</li>
<li><p>在application.properties 文件中添加Nacos服务端的配置信息</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">sentinel.nacos.serverAddr</span>=<span class="string">localhost:8848</span></span><br><span class="line"><span class="meta">sentinel.nacos.namespace</span>=<span class="string"></span></span><br><span class="line"><span class="meta">sentinel.nacos.group-id</span>=<span class="string">DEFAULT_GROUP</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>使用以下命令将代码打包成一个 fat jar ，根据前面介绍的操作方法启动服务。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mvn clean package</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h4 id="2、Sentinel-Dashboard-规则数据同步"><a href="#2、Sentinel-Dashboard-规则数据同步" class="headerlink" title="2、Sentinel Dashboard 规则数据同步"></a>2、Sentinel Dashboard 规则数据同步</h4><p>应用程序改动极少，只需要把配置文件中data-id的命名要以<strong>-sentinel-flow</strong>结尾就行，因为在Sentinel Dashboard中我们写了一个固定的后缀</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">spring.cloud.sentinel.datasource[0].nacos.data-id</span>=<span class="string">$&#123;spring.application.name&#125;-sentinel-flow</span></span><br></pre></td></tr></table></figure>

<p>后面就可以通过在Sentinel Dashboard 修改流控规则，会同步到nacos控制台了。</p>
<h3 id="八、Dubbo-集成-Sentinel-实现限流"><a href="#八、Dubbo-集成-Sentinel-实现限流" class="headerlink" title="八、Dubbo 集成 Sentinel 实现限流"></a>八、Dubbo 集成 Sentinel 实现限流</h3><p>Sentinel 提供了与Dubbo 整合的模块 sentinel-apache-dubbo-adapter，可以针对服务提供方和服务消费方进行流控，在使用的时候，只需要添加依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.csp<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>sentinel-apache-dubbo-adapter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.7.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>添加好依赖后，Dubbo服务中的接口和方法（包括服务端和消费端）就会成为Sentinel中的资源，只需针对指定资源配置流控规则就可以实现Sentinel流控功能。</p>
<p>sentinel-apache-dubbo-adapter实现限流的核心原理是：<strong>基于Dubbo的SPI机制实现Filter扩展，Dubbo的Filter机制是专门为服务提供方和服务消费方调用过程进行拦截设计的，每次执行远程方法，该拦截都会被执行。</strong></p>
<p>同时，sentinel-apache-dubbo-adapter还可以自定义开启或关闭某个过滤器的功能，下面这段代码表示关闭消费端的过滤器。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> ComsumerConfig <span class="title">comsumerConfig</span><span class="params">()</span></span>&#123;</span><br><span class="line">    ConsumerConfig consumerConfig = <span class="keyword">new</span> ConsumerConfig();</span><br><span class="line">    consumerConfig.setFilter(<span class="string">"-sentinel.dubbo.filter"</span>);</span><br><span class="line">    <span class="keyword">return</span> consumerConfig;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="1、Dubbo服务接入Sentinel-Dashborad"><a href="#1、Dubbo服务接入Sentinel-Dashborad" class="headerlink" title="1、Dubbo服务接入Sentinel Dashborad"></a>1、Dubbo服务接入Sentinel Dashborad</h4><p>spring-cloud-starter-alibaba-sentinel 目前无法支持Dubbo服务的限流，所以针对Dubbo服务的限流只能使用 sentinel-apache-dubbo-adapter。这个适配组件需要手动接入 Sentinel Dashborad。</p>
<ul>
<li><p>引入依赖，这个依赖可以上报应用相关信息到控制台。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.csp<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>sentinel-transport-simple-http<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.7.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>添加启动参数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">-Djava.net.preferIPv4Stack&#x3D;true 表示只支持IPv4。</span><br><span class="line">-Dcsp.sentinel.api.port&#x3D;8720    客户端的port,用于上报应用的信息</span><br><span class="line">-Dscp.sentinel.dashborad.server&#x3D;192.168.215.128：7777     Sentinel Dashborad地址</span><br><span class="line">-Dproject.name&#x3D;spring-cloud.sentinel-dubbo.provider		应用名称，会在Sentinel Dashboard 右侧展示</span><br></pre></td></tr></table></figure>
</li>
<li><p>登录 Sentinel Dashboard后，进入“簇点链路” ，就可以看到Dbbo资源信息。</p>
</li>
<li><p>注意：限流可以通过服务接口或服务方法设置</p>
<ul>
<li>服务接口：resourceName 为接口的全限定名。</li>
<li>服务方法：resourceName 为接口全限定名：方法名。</li>
</ul>
</li>
</ul>
<h4 id="2、Dubbo-服务限流规则配置"><a href="#2、Dubbo-服务限流规则配置" class="headerlink" title="2、Dubbo 服务限流规则配置"></a>2、Dubbo 服务限流规则配置</h4><p>略</p>
</div><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">Frosro</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://frosro.github.io/2022/02/26/SpringCloudAlibaba%E4%B9%8BSentinel-3/">https://frosro.github.io/2022/02/26/SpringCloudAlibaba%E4%B9%8BSentinel-3/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://frosro.github.io" target="_blank">BETTER LATE THAN NEVER</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/JAVA/">JAVA</a><a class="post-meta__tags" href="/tags/Spring-Cloud-Alibaba/">Spring Cloud Alibaba</a><a class="post-meta__tags" href="/tags/Sentinel/">Sentinel</a><a class="post-meta__tags" href="/tags/%E6%A1%86%E6%9E%B6/">框架</a></div><div class="post_share"><div class="social-share" data-image="/img/post.jpg" data-sites="wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"/><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js"></script></div></div><div class="post-reward"><a class="reward-button button--primary button--animated"> <i class="fa fa-qrcode"></i> 打赏<div class="reward-main"><ul class="reward-all"><li class="reward-item"><img class="lazyload post-qr-code__img" src="/img/wechat.jpg" alt="微信"/><div class="post-qr-code__desc">微信</div></li><li class="reward-item"><img class="lazyload post-qr-code__img" src="/img/alipay.jpg" alt="支付宝"/><div class="post-qr-code__desc">支付宝</div></li></ul></div></a></div><nav class="pagination_post" id="pagination"><div class="next-post pull-full"><a href="/2022/02/10/SpringCloudAlibaba%E4%B9%8BSentinel-2/"><img class="next_cover lazyload" data-src="/img/post.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">SpringCloud Alibaba 之 Sentinel（二）</div></div></a></div></nav><div class="relatedPosts"><div class="relatedPosts_headline"><i class="fa fa-fw fa-thumbs-up" aria-hidden="true"></i><span> 相关推荐</span></div><div class="relatedPosts_list"><div class="relatedPosts_item"><a href="/2022/02/08/SpringCloudAlibaba之Sentinel/" title="SpringCloud Alibaba 之 Sentinel（一）"><img class="relatedPosts_cover lazyload"data-src="/img/post.jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2022-02-08</div><div class="relatedPosts_title">SpringCloud Alibaba 之 Sentinel（一）</div></div></a></div><div class="relatedPosts_item"><a href="/2022/02/10/SpringCloudAlibaba之Sentinel-2/" title="SpringCloud Alibaba 之 Sentinel（二）"><img class="relatedPosts_cover lazyload"data-src="/img/post.jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2022-02-10</div><div class="relatedPosts_title">SpringCloud Alibaba 之 Sentinel（二）</div></div></a></div><div class="relatedPosts_item"><a href="/2020/07/19/java网络知识检验/" title="java网络知识检验"><img class="relatedPosts_cover lazyload"data-src="/img/post.jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-07-19</div><div class="relatedPosts_title">java网络知识检验</div></div></a></div><div class="relatedPosts_item"><a href="/2020/07/06/Java虚拟机/" title="Java虚拟机"><img class="relatedPosts_cover lazyload"data-src="/img/post.jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-07-06</div><div class="relatedPosts_title">Java虚拟机</div></div></a></div><div class="relatedPosts_item"><a href="/2020/03/29/JAVA集合的多种遍历方式总结/" title="JAVA集合的多种遍历方式总结"><img class="relatedPosts_cover lazyload"data-src="https://i.loli.net/2020/03/29/183Bi4j9ctYagso.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-03-29</div><div class="relatedPosts_title">JAVA集合的多种遍历方式总结</div></div></a></div><div class="relatedPosts_item"><a href="/2020/07/26/Java-synchronized原理总结/" title="Java synchronized原理总结"><img class="relatedPosts_cover lazyload"data-src="/img/post.jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-07-26</div><div class="relatedPosts_title">Java synchronized原理总结</div></div></a></div></div><div class="clear_both"></div></div><hr><div id="post-comment"><div class="comment_headling"><i class="fa fa-comments fa-fw" aria-hidden="true"></i><span> 评论</span></div><div id="lv-container" data-id="city" data-uid="MTAyMC80OTMzNS8yNTgyNw=="><script>(function(d, s) {
    var j, e = d.getElementsByTagName(s)[0];
    if (typeof LivereTower === 'function') { return; }
    j = d.createElement(s);
    j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
    j.async = true;
    e.parentNode.insertBefore(j, e);
})(document, 'script');</script></div></div></article></main><footer id="footer" data-type="color"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2022 By Frosro</div><div class="framework-info"><span>驱动 </span><a href="https://hexo.io" target="_blank" rel="noopener"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 </span><a href="https://github.com/jerryc127/hexo-theme-butterfly" target="_blank" rel="noopener"><span>Butterfly</span></a></div><div class="footer_custom_text">-------------非常欢迎 <i class="fa fa-paw"></i> 来到我的博客-------------</div></div></footer></div><section class="rightside" id="rightside"><div id="rightside-config-hide"><i class="fa fa-book" id="readmode" title="阅读模式"></i><i class="fa fa-plus" id="font_plus" title="放大字体"></i><i class="fa fa-minus" id="font_minus" title="缩小字体"></i><a class="translate_chn_to_cht" id="translateLink" href="javascript:translatePage();" title="简繁转换" target="_self">繁</a></div><div id="rightside-config-show"><div id="rightside_config" title="设置"><i class="fa fa-cog" aria-hidden="true"></i></div><a id="to_comment" href="#post-comment" title="直达评论"><i class="scroll_to_comment fa fa-comments">  </i></a><i class="fa fa-list-ul close" id="mobile-toc-button" title="目录" aria-hidden="true"></i><i class="fa fa-arrow-up" id="go-up" title="回到顶部" aria-hidden="true"></i></div></section><div class="search-dialog" id="local-search"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div></div><hr/><div id="local-search-results"><div id="local-hits"></div><div id="local-stats"><div class="local-search-stats__hr" id="hr"><span>由</span> <a href="https://github.com/wzpan/hexo-generator-search" target="_blank" rel="noopener" style="color:#49B1F5;">hexo-generator-search</a>
 <span>提供支持</span></div></div></div><span class="search-close-button"><i class="fa fa-times"></i></span></div><div class="search-mask"></div><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="/js/third-party/fireworks.js"></script><script id="ribbon_piao" mobile="false" src="/js/third-party/piao.js"></script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page@latest/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/lazysizes@latest/lazysizes.min.js" async=""></script><script src="/js/search/local-search.js"></script></body></html>