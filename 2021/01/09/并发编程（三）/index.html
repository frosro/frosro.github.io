<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>å¹¶å‘ç¼–ç¨‹ï¼ˆä¸‰ï¼‰ | BETTER LATE THAN NEVER</title><meta name="description" content="å¹¶å‘ç¼–ç¨‹ï¼ˆä¸‰ï¼‰"><meta name="author" content="Frosro"><meta name="copyright" content="Frosro"><meta name="format-detection" content="telephone=no"><link rel="shortcut icon" href="/img/favicon.png"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="https://fonts.googleapis.com" crossorigin="crossorigin"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><meta name="twitter:card" content="summary"><meta name="twitter:title" content="å¹¶å‘ç¼–ç¨‹ï¼ˆä¸‰ï¼‰"><meta name="twitter:description" content="å¹¶å‘ç¼–ç¨‹ï¼ˆä¸‰ï¼‰"><meta name="twitter:image" content="https://frosro.github.io/img/post.jpg"><meta property="og:type" content="article"><meta property="og:title" content="å¹¶å‘ç¼–ç¨‹ï¼ˆä¸‰ï¼‰"><meta property="og:url" content="https://frosro.github.io/2021/01/09/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%EF%BC%88%E4%B8%89%EF%BC%89/"><meta property="og:site_name" content="BETTER LATE THAN NEVER"><meta property="og:description" content="å¹¶å‘ç¼–ç¨‹ï¼ˆä¸‰ï¼‰"><meta property="og:image" content="https://frosro.github.io/img/post.jpg"><script src="https://cdn.jsdelivr.net/npm/js-cookie/dist/js.cookie.min.js"></script><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><link rel="canonical" href="https://frosro.github.io/2021/01/09/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%EF%BC%88%E4%B8%89%EF%BC%89/"><link rel="next" title="å¹¶å‘ç¼–ç¨‹ï¼ˆäºŒï¼‰" href="https://frosro.github.io/2021/01/08/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%EF%BC%88%E4%BA%8C%EF%BC%89/"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"æ‰¾ä¸åˆ°æ‚¨æŸ¥è¯¢çš„å†…å®¹:${query}"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"cookieDomain":"https://xxx/","msgToTraditionalChinese":"ç¹","msgToSimplifiedChinese":"ç°¡"},
  copy: {
    success: 'å¤åˆ¶æˆåŠŸ',
    error: 'å¤åˆ¶é”™è¯¯',
    noSupport: 'æµè§ˆå™¨ä¸æ”¯æŒ'
  },
  bookmark: {
    message_prev: 'æŒ‰',
    message_next: 'é”®å°†æœ¬é¡µåŠ å…¥ä¹¦ç­¾'
  },
  runtime_unit: 'å¤©',
  runtime: true,
  copyright: undefined,
  ClickShowText: undefined,
  medium_zoom: false,
  fancybox: true,
  Snackbar: undefined,
  baiduPush: true,
  highlightCopy: true,
  highlightLang: true,
  highlightShrink: 'true',
  isFontAwesomeV5: false,
  isPhotoFigcaption: false
  
}</script><script>var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isSidebar: true  
  }</script><noscript><style>
#page-header {
  opacity: 1
}
.justified-gallery img{
  opacity: 1
}
</style></noscript><meta name="generator" content="Hexo 4.2.0"><link rel="alternate" href="/atom.xml" title="BETTER LATE THAN NEVER" type="application/atom+xml">
</head><body><canvas class="fireworks"></canvas><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="avatar-img" src="/img/avatar.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="mobile_post_data"><div class="mobile_data_item is-center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">æ–‡ç« </div><div class="length_num">31</div></a></div></div><div class="mobile_data_item is-center">      <div class="mobile_data_link"><a href="/tags/"><div class="headline">æ ‡ç­¾</div><div class="length_num">39</div></a></div></div><div class="mobile_data_item is-center">     <div class="mobile_data_link"><a href="/categories/"><div class="headline">åˆ†ç±»</div><div class="length_num">3</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> é¦–é¡µ</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> æ—¶é—´è½´</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> æ ‡ç­¾</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> åˆ†ç±»</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> æ¸…å•</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fa fa-music"></i><span> Music</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fa fa-film"></i><span> Movie</span></a></li></ul></div></div></div></div><i class="fa fa-arrow-right on" id="toggle-sidebar" aria-hidden="true">     </i><div id="sidebar"><div class="sidebar-toc"><div class="sidebar-toc__title">ç›®å½•</div><div class="sidebar-toc__progress"><span class="progress-notice">ä½ å·²ç»è¯»äº†</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#ä¸‰ã€JUC-java-util-concurrent"><span class="toc-number">1.</span> <span class="toc-text">ä¸‰ã€JUC:java.util.concurrent</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#3-1-é›†åˆ"><span class="toc-number">1.1.</span> <span class="toc-text">3.1 é›†åˆ</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#3-1-1-BlockingQueue"><span class="toc-number">1.1.1.</span> <span class="toc-text">3.1.1 BlockingQueue</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-1-2-ArrayBlockingQueue"><span class="toc-number">1.1.2.</span> <span class="toc-text">3.1.2 ArrayBlockingQueue</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-1-3-PriorityBlockingQueue"><span class="toc-number">1.1.3.</span> <span class="toc-text">3.1.3 PriorityBlockingQueue</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-1-4-DelayQueue"><span class="toc-number">1.1.4.</span> <span class="toc-text">3.1.4 DelayQueue</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-1-5-LinkedBlockingQueue"><span class="toc-number">1.1.5.</span> <span class="toc-text">3.1.5 LinkedBlockingQueue</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-1-6-LinkedBlockingDeque"><span class="toc-number">1.1.6.</span> <span class="toc-text">3.1.6 LinkedBlockingDeque</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-1-7-SynchronousQueue"><span class="toc-number">1.1.7.</span> <span class="toc-text">3.1.7 SynchronousQueue</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-1-8-LinkedTransferQueue"><span class="toc-number">1.1.8.</span> <span class="toc-text">3.1.8 LinkedTransferQueue</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-1-9-ConcurrentHashMap"><span class="toc-number">1.1.9.</span> <span class="toc-text">3.1.9 ConcurrentHashMap</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#HashMapå®¹é‡"><span class="toc-number">1.1.9.1.</span> <span class="toc-text">HashMapå®¹é‡</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#æ•ˆç‡ä½ä¸‹çš„-HashTable-å®¹å™¨"><span class="toc-number">1.1.9.2.</span> <span class="toc-text">æ•ˆç‡ä½ä¸‹çš„ HashTable å®¹å™¨</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-1-10-ConcurrentSkipListMap"><span class="toc-number">1.1.10.</span> <span class="toc-text">3.1.10 ConcurrentSkipListMap</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-1-11-ConcurrentSkipListSet"><span class="toc-number">1.1.11.</span> <span class="toc-text">3.1.11 ConcurrentSkipListSet</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-1-12-CopyOnWriteArrayList"><span class="toc-number">1.1.12.</span> <span class="toc-text">3.1.12 CopyOnWriteArrayList</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-1-13-CopyOnWriteArraySet"><span class="toc-number">1.1.13.</span> <span class="toc-text">3.1.13 CopyOnWriteArraySet</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2-åŸå­æ“ä½œç±»"><span class="toc-number">1.2.</span> <span class="toc-text">3.2 åŸå­æ“ä½œç±»</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#3-2-1-åŸå­åŸºæœ¬æ•°æ®ç±»å‹"><span class="toc-number">1.2.1.</span> <span class="toc-text">3.2.1 åŸå­åŸºæœ¬æ•°æ®ç±»å‹</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-2-2-åŸå­æ•°ç»„"><span class="toc-number">1.2.2.</span> <span class="toc-text">3.2.2 åŸå­æ•°ç»„</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-2-3-åŸå­å¼•ç”¨ç±»å‹"><span class="toc-number">1.2.3.</span> <span class="toc-text">3.2.3 åŸå­å¼•ç”¨ç±»å‹</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-2-4-åŸå­æ›´æ–°å­—æ®µç±»å‹"><span class="toc-number">1.2.4.</span> <span class="toc-text">3.2.4 åŸå­æ›´æ–°å­—æ®µç±»å‹</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-3-é”ï¼šLock"><span class="toc-number">1.3.</span> <span class="toc-text">3.3 é”ï¼šLock</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#3-3-1-ReentrantLock"><span class="toc-number">1.3.1.</span> <span class="toc-text">3.3.1 ReentrantLock</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-3-2-LockSupport"><span class="toc-number">1.3.2.</span> <span class="toc-text">3.3.2 LockSupport</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-3-3-Condition"><span class="toc-number">1.3.3.</span> <span class="toc-text">3.3.3 Condition</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#æºç æ¢ç´¢"><span class="toc-number">1.3.3.1.</span> <span class="toc-text">æºç æ¢ç´¢</span></a></li></ol></li></ol></li></ol></li></ol></div></div></div><div id="body-wrap"><div class="post-bg" id="nav" style="background-image: url(/img/post.jpg)"><div id="page-header"><span class="pull_left" id="blog_name"><a class="blog_title" id="site-name" href="/">BETTER LATE THAN NEVER</a></span><span class="pull_right menus"><div id="search_button"><a class="site-page social-icon search"><i class="fa fa-search fa-fw"></i><span> æœç´¢</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> é¦–é¡µ</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> æ—¶é—´è½´</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> æ ‡ç­¾</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> åˆ†ç±»</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> æ¸…å•</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fa fa-music"></i><span> Music</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fa fa-film"></i><span> Movie</span></a></li></ul></div></div><span class="toggle-menu close"><a class="site-page"><i class="fa fa-bars fa-fw" aria-hidden="true"></i></a></span></span></div><div id="post-info"><div id="post-title"><div class="posttitle">å¹¶å‘ç¼–ç¨‹ï¼ˆä¸‰ï¼‰</div></div><div id="post-meta"><div class="meta-firstline"><time class="post-meta__date"><span class="post-meta__date-created" title="å‘è¡¨äº 2021-01-09 17:20:30"><i class="fa fa-calendar" aria-hidden="true"></i> å‘è¡¨äº 2021-01-09</span><span class="post-meta__separator">|</span><span class="post-meta__date-updated" title="æ›´æ–°äº 2021-01-09 23:02:25"><i class="fa fa-history" aria-hidden="true"></i> æ›´æ–°äº 2021-01-09</span></time></div><div class="meta-secondline"> </div><div class="meta-thirdline"><span class="post-meta-pv-cv"><i class="fa fa-eye post-meta__icon" aria-hidden="true"> </i><span>é˜…è¯»é‡:</span><span id="busuanzi_value_page_pv"></span></span><span class="post-meta-commentcount"></span></div></div></div></div><main class="layout_post" id="content-inner"><article id="post"><div id="article-container"><p>title: å¹¶å‘ç¼–ç¨‹ï¼ˆä¸‰ï¼‰<br>categories: ğŸºJAVA<br>tags: </p>
<ul>
<li>JAVA</li>
<li>å¹¶å‘ç¼–ç¨‹<br>date: 2021-01-09 17:20:30<br>cover:</li>
</ul>
<h3 id="ä¸‰ã€JUC-java-util-concurrent"><a href="#ä¸‰ã€JUC-java-util-concurrent" class="headerlink" title="ä¸‰ã€JUC:java.util.concurrent"></a>ä¸‰ã€JUC:java.util.concurrent</h3><h4 id="3-1-é›†åˆ"><a href="#3-1-é›†åˆ" class="headerlink" title="3.1 é›†åˆ"></a>3.1 é›†åˆ</h4><h5 id="3-1-1-BlockingQueue"><a href="#3-1-1-BlockingQueue" class="headerlink" title="3.1.1 BlockingQueue"></a>3.1.1 BlockingQueue</h5><p><strong>ä»€ä¹ˆæ˜¯é˜»å¡é˜Ÿåˆ—ï¼Ÿ</strong></p>
<p>é˜»å¡é˜Ÿåˆ—ï¼ˆBlockingQueueï¼‰æ˜¯ä¸€ä¸ªæ”¯æŒä¸¤ä¸ªé™„åŠ æ“ä½œçš„é˜Ÿåˆ—ã€‚è¿™ä¸¤ä¸ªé™„åŠ çš„æ“ä½œæ˜¯ï¼šåœ¨é˜Ÿåˆ—ä¸ºç©ºæ—¶ï¼Œ è·å–å…ƒç´ çš„çº¿ç¨‹ä¼šç­‰å¾…é˜Ÿåˆ—å˜ä¸ºéç©ºã€‚å½“é˜Ÿåˆ—æ»¡æ—¶ï¼Œå­˜å‚¨å…ƒç´ çš„çº¿ç¨‹ä¼šç­‰å¾…é˜Ÿåˆ—å¯ç”¨ã€‚é˜»å¡é˜Ÿåˆ—å¸¸ç”¨äºç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…çš„åœºæ™¯ï¼Œç”Ÿäº§è€…æ˜¯å¾€é˜Ÿåˆ—é‡Œæ·»åŠ å…ƒç´ çš„çº¿ç¨‹ï¼Œæ¶ˆè´¹è€…æ˜¯ä»é˜Ÿåˆ—é‡Œæ‹¿å…ƒç´ çš„çº¿ç¨‹ã€‚é˜»å¡é˜Ÿåˆ—å°±æ˜¯ç”Ÿäº§è€…å­˜æ”¾å…ƒç´ çš„å®¹å™¨ï¼Œè€Œæ¶ˆè´¹è€…ä¹Ÿåªä»å®¹å™¨é‡Œæ‹¿å…ƒç´ ã€‚</p>
<p>é˜»å¡é˜Ÿåˆ—æä¾›äº†å››ç§å¤„ç†æ–¹æ³•:</p>
<table>
<thead>
<tr>
<th>æ–¹æ³•\å¤„ç†æ–¹å¼</th>
<th>æŠ›å‡ºå¼‚å¸¸</th>
<th>è¿”å›ç‰¹æ®Šå€¼</th>
<th>ä¸€ç›´é˜»å¡</th>
<th>è¶…æ—¶é€€å‡º</th>
</tr>
</thead>
<tbody><tr>
<td>æ’å…¥æ–¹æ³•</td>
<td>add(e)</td>
<td>offer(e)</td>
<td>put(e)</td>
<td>offer(e,time,unit)</td>
</tr>
<tr>
<td>ç§»é™¤æ–¹æ³•</td>
<td>remove()</td>
<td>poll()</td>
<td>take()</td>
<td>poll(time,unit)</td>
</tr>
<tr>
<td>æ£€æŸ¥æ–¹æ³•</td>
<td>element()</td>
<td>peek()</td>
<td>ä¸å¯ç”¨</td>
<td>ä¸å¯ç”¨</td>
</tr>
</tbody></table>
<ul>
<li>å¼‚å¸¸ï¼šæ˜¯æŒ‡å½“é˜»å¡é˜Ÿåˆ—æ»¡æ—¶å€™ï¼Œå†å¾€é˜Ÿåˆ—é‡Œæ’å…¥å…ƒç´ ï¼Œä¼šæŠ›å‡ºIllegalStateException(â€œQueue fullâ€)å¼‚å¸¸ã€‚å½“é˜Ÿåˆ—ä¸ºç©ºæ—¶ï¼Œä»é˜Ÿåˆ—é‡Œè·å–å…ƒç´ æ—¶ä¼šæŠ›å‡ºNoSuchElementExceptionå¼‚å¸¸ ã€‚ </li>
<li>è¿”å›ç‰¹æ®Šå€¼ï¼šæ’å…¥æ–¹æ³•ä¼šè¿”å›æ˜¯å¦æˆåŠŸï¼ŒæˆåŠŸåˆ™è¿”å›trueã€‚ç§»é™¤æ–¹æ³•ï¼Œåˆ™æ˜¯ä»é˜Ÿåˆ—é‡Œæ‹¿å‡ºä¸€ä¸ªå…ƒ ç´ ï¼Œå¦‚æœæ²¡æœ‰åˆ™è¿”å›null</li>
<li>ä¸€ç›´é˜»å¡ï¼šå½“é˜»å¡é˜Ÿåˆ—æ»¡æ—¶ï¼Œå¦‚æœç”Ÿäº§è€…çº¿ç¨‹å¾€é˜Ÿåˆ—é‡Œputå…ƒç´ ï¼Œé˜Ÿåˆ—ä¼šä¸€ç›´é˜»å¡ç”Ÿäº§è€…çº¿ç¨‹ï¼Œç›´ åˆ°æ‹¿åˆ°æ•°æ®ï¼Œæˆ–è€…å“åº”ä¸­æ–­é€€å‡ºã€‚å½“é˜Ÿåˆ—ç©ºæ—¶ï¼Œæ¶ˆè´¹è€…çº¿ç¨‹è¯•å›¾ä»é˜Ÿåˆ—é‡Œtakeå…ƒç´ ï¼Œé˜Ÿåˆ—ä¹Ÿä¼šé˜» å¡æ¶ˆè´¹è€…çº¿ç¨‹ï¼Œç›´åˆ°é˜Ÿåˆ—å¯ç”¨ã€‚ </li>
<li>è¶…æ—¶é€€å‡ºï¼šå½“é˜»å¡é˜Ÿåˆ—æ»¡æ—¶ï¼Œé˜Ÿåˆ—ä¼šé˜»å¡ç”Ÿäº§è€…çº¿ç¨‹ä¸€æ®µæ—¶é—´ï¼Œå¦‚æœè¶…è¿‡ä¸€å®šçš„æ—¶é—´ï¼Œç”Ÿäº§è€…çº¿ç¨‹å°±ä¼šé€€å‡º</li>
</ul>
<p>é˜»å¡é˜Ÿåˆ—æ¥å£ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">BlockingQueueçš„æ ¸å¿ƒæ–¹æ³•ï¼š</span><br><span class="line">    </span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">BlockingQueue</span>&lt;<span class="title">E</span>&gt; <span class="keyword">extends</span> <span class="title">Queue</span>&lt;<span class="title">E</span>&gt; </span>&#123;</span><br><span class="line"> Â  Â <span class="comment">//æ’å…¥å…ƒç´ eåˆ°é˜Ÿåˆ—ä¸­ï¼ŒæˆåŠŸè¿”å›true, å¦åˆ™æŠ›å‡ºå¼‚å¸¸ã€‚å¦‚æœå‘é™å®šäº†å®¹é‡çš„é˜Ÿåˆ—ä¸­æ’å…¥å€¼ï¼Œæ¨ èä½¿ç”¨offer()æ–¹æ³•ã€‚ Â  Â </span></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">add</span><span class="params">(E e)</span></span>;</span><br><span class="line"> Â  Â <span class="comment">//æ’å…¥å…ƒç´ eåˆ°é˜Ÿåˆ—ä¸­ï¼Œå¦‚æœè®¾ç½®æˆåŠŸè¿”å›true, å¦åˆ™è¿”å›false. eçš„å€¼ä¸èƒ½ä¸ºç©ºï¼Œå¦åˆ™æŠ›å‡º ç©ºæŒ‡é’ˆå¼‚å¸¸ã€‚</span></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">offer</span><span class="params">(E e)</span></span>;</span><br><span class="line"> Â  Â <span class="comment">//æ’å…¥å…ƒç´ eåˆ°é˜Ÿåˆ—ä¸­ï¼Œï¼Œå¦‚æœé˜Ÿåˆ—ä¸­æ²¡æœ‰å¤šä½™çš„ç©ºé—´ï¼Œè¯¥æ–¹æ³•ä¼šä¸€ç›´é˜»å¡ï¼Œç›´åˆ°é˜Ÿåˆ—ä¸­æœ‰å¤šä½™çš„ ç©ºé—´ã€‚</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">put</span><span class="params">(E e)</span> <span class="keyword">throws</span> InterruptedException</span>;</span><br><span class="line">Â <span class="comment">//åœ¨ç»™å®šçš„æ—¶é—´æ’å…¥å…ƒç´ eåˆ°é˜Ÿåˆ—ä¸­ï¼Œå¦‚æœè®¾ç½®æˆåŠŸè¿”å›true, å¦åˆ™è¿”å›false.</span></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">offer</span><span class="params">(E e, <span class="keyword">long</span> timeout, TimeUnit unit)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> InterruptedException</span>;</span><br><span class="line"> Â  Â <span class="comment">//æ£€ç´¢å¹¶ä»é˜Ÿåˆ—çš„å¤´éƒ¨åˆ é™¤å…ƒç´ ï¼Œå¦‚æœé˜Ÿåˆ—ä¸­æ²¡æœ‰å€¼ï¼Œçº¿ç¨‹ä¼šä¸€ç›´é˜»å¡ï¼Œç›´åˆ°é˜Ÿåˆ—ä¸­æœ‰å€¼ï¼Œå¹¶ä¸”è¯¥ æ–¹æ³•å–å¾—äº†è¯¥å€¼ã€‚</span></span><br><span class="line">    <span class="function">E <span class="title">take</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException</span>;</span><br><span class="line"> Â  Â <span class="comment">//åœ¨ç»™å®šçš„æ—¶é—´èŒƒå›´å†…ï¼Œæ£€ç´¢å¹¶ä»é˜Ÿåˆ—çš„å¤´éƒ¨åˆ é™¤å…ƒç´ ï¼Œä»é˜Ÿåˆ—ä¸­è·å–å€¼ï¼Œå¦‚æœæ²¡æœ‰å–åˆ°ä¼šæŠ›å‡ºå¼‚å¸¸ã€‚</span></span><br><span class="line">    <span class="function">E <span class="title">poll</span><span class="params">(<span class="keyword">long</span> timeout, TimeUnit unit)</span> Â  Â  Â  Â </span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> InterruptedException</span>;</span><br><span class="line"> Â  Â <span class="comment">//è·å–é˜Ÿåˆ—ä¸­å‰©ä½™çš„ç©ºé—´ã€‚</span></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">remainingCapacity</span><span class="params">()</span></span>;</span><br><span class="line"> Â  Â <span class="comment">//ä»é˜Ÿåˆ—ä¸­ç§»é™¤æŒ‡å®šçš„å€¼ã€‚</span></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">remove</span><span class="params">(Object o)</span></span>;</span><br><span class="line"> Â  Â <span class="comment">//åˆ¤æ–­é˜Ÿåˆ—ä¸­æ˜¯å¦åŒ…å«è¯¥å€¼ã€‚</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">contains</span><span class="params">(Object o)</span></span>;</span><br><span class="line"> Â  Â <span class="comment">//å°†é˜Ÿåˆ—ä¸­å€¼ï¼Œå…¨éƒ¨ç§»é™¤ï¼Œå¹¶è¿½åŠ åˆ°ç»™å®šçš„é›†åˆä¸­ã€‚</span></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">drainTo</span><span class="params">(Collection&lt;? <span class="keyword">super</span> E&gt; c)</span></span>;</span><br><span class="line"> Â  Â <span class="comment">//æŒ‡å®šæœ€å¤šæ•°é‡é™åˆ¶å°†é˜Ÿåˆ—ä¸­å€¼ï¼Œå…¨éƒ¨ç§»é™¤ï¼Œå¹¶è¿½åŠ åˆ°ç»™å®šçš„é›†åˆä¸­ã€‚</span></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">drainTo</span><span class="params">(Collection&lt;? <span class="keyword">super</span> E&gt; c, <span class="keyword">int</span> maxElements)</span></span>; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç»§æ‰¿å…³ç³»</p>
<ul>
<li><p>å­æ¥å£ï¼š </p>
<p><strong>BlockingDeque</strong></p>
</li>
</ul>
<p><img src="/img/loading.gif" class="lazyload" data-src="/2021/01/09/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%EF%BC%88%E4%B8%89%EF%BC%89/img1.jpg"  alt></p>
<p>â€‹        <strong>TransferQueue</strong></p>
<p>TransferQueueç»§æ‰¿äº†BlockingQueue,å¹¶æ‰©å±•äº†ä¸€äº›æ–°æ–¹æ³•ã€‚ </p>
<p>BlockingQueueæ˜¯æŒ‡è¿™æ ·çš„ä¸€ä¸ªé˜Ÿåˆ—ï¼šå½“ç”Ÿäº§è€…å‘é˜Ÿåˆ—æ·»åŠ å…ƒç´ ä½†é˜Ÿåˆ—å·²æ»¡æ—¶ï¼Œç”Ÿäº§è€…ä¼šè¢«é˜»å¡ï¼›å½“æ¶ˆè´¹è€…ä»é˜Ÿåˆ—ç§»é™¤å…ƒç´ ä½†é˜Ÿåˆ—ä¸ºç©ºæ—¶ï¼Œæ¶ˆè´¹è€…ä¼šè¢«é˜»å¡ã€‚</p>
<p>TransferQueueåˆ™æ›´è¿›ä¸€æ­¥ï¼Œç”Ÿäº§è€…ä¼šä¸€ç›´é˜»å¡ç›´åˆ°æ‰€æ·»åŠ åˆ°é˜Ÿåˆ—çš„å…ƒç´ è¢«æŸä¸€ä¸ªæ¶ˆè´¹è€…æ‰€æ¶ˆè´¹ ï¼ˆä¸ä»…ä»…æ˜¯æ·»åŠ åˆ°é˜Ÿåˆ—é‡Œå°±å®Œäº‹ï¼‰ã€‚æ–°æ·»åŠ çš„transferæ–¹æ³•ç”¨æ¥å®ç°è¿™ç§çº¦æŸã€‚é¡¾åæ€ä¹‰ï¼Œé˜»å¡å°±æ˜¯å‘ç”Ÿåœ¨å…ƒç´ ä»ä¸€ä¸ªçº¿ç¨‹transferåˆ°å¦ä¸€ä¸ªçº¿ç¨‹çš„è¿‡ç¨‹ä¸­ï¼Œå®ƒæœ‰æ•ˆåœ°å®ç°äº†å…ƒç´ åœ¨çº¿ç¨‹ä¹‹é—´çš„ä¼ é€’ï¼ˆä»¥å»ºç«‹Javaå†…å­˜æ¨¡å‹ä¸­çš„happens-beforeå…³ç³»çš„æ–¹å¼ï¼‰ã€‚ TransferQueueè¿˜åŒ…æ‹¬äº†å…¶ä»–çš„ä¸€äº›æ–¹æ³•ï¼šä¸¤ä¸ªtryTransferæ–¹æ³•ï¼Œä¸€ä¸ªæ˜¯éé˜»å¡çš„ï¼Œå¦ä¸€ä¸ªå¸¦ æœ‰timeoutå‚æ•°è®¾ç½®è¶…æ—¶æ—¶é—´çš„ã€‚è¿˜æœ‰ä¸¤ä¸ªè¾…åŠ©æ–¹æ³•hasWaitingConsumer()å’ŒgetWaitingConsumerCount()ã€‚ </p>
<ul>
<li><p>å®ç°ç±» </p>
<p>ArrayBlockingQueue </p>
<p>DelayQueue</p>
<p>LinkedBlockingDeque</p>
<p>LinkedBlockingQueue</p>
<p>LinkedTransferQueue </p>
<p>PriorityBlockingQueue </p>
<p>SynchronousQueue</p>
</li>
</ul>
<h5 id="3-1-2-ArrayBlockingQueue"><a href="#3-1-2-ArrayBlockingQueue" class="headerlink" title="3.1.2 ArrayBlockingQueue"></a>3.1.2 ArrayBlockingQueue</h5><p><strong>ArrayBlockingQueue</strong> æ˜¯ä¸€ä¸ªçº¿ç¨‹å®‰å…¨çš„ã€åŸºäºæ•°ç»„ã€æœ‰ç•Œçš„ã€é˜»å¡çš„ã€FIFO é˜Ÿåˆ—ã€‚è¯•å›¾å‘å·²æ»¡é˜Ÿåˆ—ä¸­æ”¾å…¥å…ƒç´ ä¼šå¯¼è‡´æ“ä½œå—é˜»å¡ï¼›è¯•å›¾ä»ç©ºé˜Ÿåˆ—ä¸­æå–å…ƒç´ å°†å¯¼è‡´ç±»ä¼¼é˜»å¡ã€‚<br>æ­¤ç±»åŸºäº java.util.concurrent.locks.ReentrantLock æ¥å®ç°çº¿ç¨‹å®‰å…¨ï¼Œæ‰€ä»¥æä¾›äº† ReentrantLock æ‰€èƒ½æ”¯æŒçš„å…¬å¹³æ€§é€‰æ‹©ã€‚</p>
<p>ä½¿ç”¨ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.concurrent.ArrayBlockingQueue; </span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.BlockingQueue;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ArrayBlockingQueueDemo</span> </span>&#123; Â  Â </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"> Â  Â  Â  Â BlockingQueue&lt;Integer&gt; blockingQueue = <span class="keyword">new</span> ArrayBlockingQueue&lt;Integer&gt;(<span class="number">3</span>,<span class="keyword">true</span>);</span><br><span class="line">        Producer producer = <span class="keyword">new</span> Producer(blockingQueue);</span><br><span class="line">        Consumer consumer = <span class="keyword">new</span> Consumer(blockingQueue);</span><br><span class="line"> Â  Â  Â  Â <span class="keyword">new</span> Thread(producer).start();</span><br><span class="line"> Â  Â  Â  Â <span class="keyword">new</span> Thread(consumer).start();</span><br><span class="line"> Â   &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Producer</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line"> Â  Â <span class="keyword">private</span> Â BlockingQueue&lt;Integer&gt; blockingQueue;</span><br><span class="line">Â 	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> element = <span class="number">0</span>;</span><br><span class="line"> Â  Â <span class="function"><span class="keyword">public</span> <span class="title">Producer</span><span class="params">(BlockingQueue&lt;Integer&gt; blockingQueue)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.blockingQueue = blockingQueue; Â   </span><br><span class="line">    &#125;</span><br><span class="line"> Â  Â <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">while</span>(element &lt; <span class="number">20</span>) &#123;</span><br><span class="line">                System.out.println(<span class="string">"ç”Ÿäº§å…ƒç´ ï¼š"</span>+element);</span><br><span class="line">                blockingQueue.put(element++);</span><br><span class="line">            &#125; Â  Â  Â   </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            System.out.println(<span class="string">"ç”Ÿäº§è€…åœ¨ç­‰å¾…ç©ºé—²ç©ºé—´çš„æ—¶å€™å‘ç”Ÿå¼‚å¸¸ï¼"</span>);</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; Â  Â  Â  Â </span><br><span class="line">        System.out.println(<span class="string">"ç”Ÿäº§è€…ç»ˆæ­¢äº†ç”Ÿäº§è¿‡ç¨‹ï¼"</span>); Â   </span><br><span class="line">    &#125; </span><br><span class="line">&#125; </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Consumer</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line"> Â  Â <span class="keyword">private</span> Â BlockingQueue&lt;Integer&gt; blockingQueue;</span><br><span class="line"> Â  Â <span class="function"><span class="keyword">public</span> <span class="title">Consumer</span><span class="params">(BlockingQueue&lt;Integer&gt; blockingQueue)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.blockingQueue = blockingQueue;</span><br><span class="line">    &#125;</span><br><span class="line"> Â  Â <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">while</span>(<span class="keyword">true</span>) &#123;</span><br><span class="line">                System.out.println(<span class="string">"æ¶ˆè´¹å…ƒç´ ï¼š"</span>+blockingQueue.take());</span><br><span class="line">            &#125; Â  Â  Â   </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            System.out.println(<span class="string">"æ¶ˆè´¹è€…åœ¨ç­‰å¾…æ–°äº§å“çš„æ—¶å€™å‘ç”Ÿå¼‚å¸¸ï¼"</span>);</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; Â  Â  Â  Â </span><br><span class="line">        System.out.println(<span class="string">"æ¶ˆè´¹è€…ç»ˆæ­¢äº†æ¶ˆè´¹è¿‡ç¨‹ï¼"</span>); Â   </span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="3-1-3-PriorityBlockingQueue"><a href="#3-1-3-PriorityBlockingQueue" class="headerlink" title="3.1.3 PriorityBlockingQueue"></a>3.1.3 PriorityBlockingQueue</h5><p><strong>PriorityBlockingQueue</strong>æ˜¯å¸¦ä¼˜å…ˆçº§çš„æ— ç•Œé˜»å¡é˜Ÿåˆ—ï¼Œæ¯æ¬¡å‡ºé˜Ÿéƒ½è¿”å›ä¼˜å…ˆçº§é«˜çš„å…ƒç´ ï¼Œæ˜¯äºŒå‰æ ‘å°å †çš„å®ç°ã€‚</p>
<p>ä½¿ç”¨ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.Random;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.PriorityBlockingQueue;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PriorityBlockingQueueTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">Â 		PriorityBlockingQueue&lt;PriorityElement&gt; queue = <span class="keyword">new</span> PriorityBlockingQueue&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) &#123;</span><br><span class="line">            Random random=<span class="keyword">new</span> Random();</span><br><span class="line">            PriorityElement ele = <span class="keyword">new</span> PriorityElement(random.nextInt(<span class="number">10</span>));</span><br><span class="line">            queue.put(ele);</span><br><span class="line">        &#125; Â  Â  Â  Â </span><br><span class="line">        <span class="keyword">while</span>(!queue.isEmpty())&#123;</span><br><span class="line">            System.out.println(queue.take());</span><br><span class="line">        &#125; Â   </span><br><span class="line">    &#125; </span><br><span class="line">&#125; </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PriorityElement</span> <span class="keyword">implements</span> <span class="title">Comparable</span>&lt;<span class="title">PriorityElement</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> priority;<span class="comment">//å®šä¹‰ä¼˜å…ˆçº§ Â  Â </span></span><br><span class="line">    PriorityElement(<span class="keyword">int</span> priority) &#123;</span><br><span class="line">        <span class="comment">//åˆå§‹åŒ–ä¼˜å…ˆçº§ Â  Â  Â  Â </span></span><br><span class="line">        <span class="keyword">this</span>.priority = priority;</span><br><span class="line">    &#125; Â  Â </span><br><span class="line">    <span class="meta">@Override</span> Â  Â </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">compareTo</span><span class="params">(PriorityElement o)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//æŒ‰ç…§ä¼˜å…ˆçº§å¤§å°è¿›è¡Œæ’åº</span></span><br><span class="line">        <span class="keyword">return</span> priority &gt;= o.getPriority() ? <span class="number">1</span> : -<span class="number">1</span>;</span><br><span class="line">    &#125; Â  Â </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getPriority</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> priority;</span><br><span class="line">    &#125; Â  Â </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setPriority</span><span class="params">(<span class="keyword">int</span> priority)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.priority = priority;</span><br><span class="line">    &#125; Â  Â </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"PriorityElement [priority="</span> + priority + <span class="string">"]"</span>;</span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="3-1-4-DelayQueue"><a href="#3-1-4-DelayQueue" class="headerlink" title="3.1.4 DelayQueue"></a>3.1.4 DelayQueue</h5><p><strong>DelayQueue</strong>é˜Ÿåˆ—ä¸­æ¯ä¸ªå…ƒç´ éƒ½æœ‰ä¸ªè¿‡æœŸæ—¶é—´ï¼Œå¹¶ä¸”é˜Ÿåˆ—æ˜¯ä¸ªä¼˜å…ˆçº§é˜Ÿåˆ—ï¼Œå½“ä»é˜Ÿåˆ—è·å–å…ƒç´ æ—¶å€™ï¼Œåªæœ‰è¿‡æœŸå…ƒç´ æ‰ä¼šå‡ºé˜Ÿåˆ—ã€‚</p>
<p>ä½¿ç”¨</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.time.LocalDateTime;</span><br><span class="line"><span class="keyword">import</span> java.time.format.DateTimeFormatter;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.DelayQueue;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.Delayed;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DelayQueueTest</span>  </span>&#123;</span><br><span class="line"> Â  Â <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        Item item1 = <span class="keyword">new</span> Item(<span class="string">"item1"</span>, <span class="number">5</span>, TimeUnit.SECONDS);</span><br><span class="line">        Item item2 = <span class="keyword">new</span> Item(<span class="string">"item2"</span>,<span class="number">10</span>, TimeUnit.SECONDS);</span><br><span class="line">        Item item3 = <span class="keyword">new</span> Item(<span class="string">"item3"</span>,<span class="number">15</span>, TimeUnit.SECONDS);</span><br><span class="line"> Â  Â  Â  Â DelayQueue&lt;Item&gt; queue = <span class="keyword">new</span> DelayQueue&lt;&gt;();</span><br><span class="line">        queue.put(item1);</span><br><span class="line">        queue.put(item2);</span><br><span class="line">        queue.put(item3);</span><br><span class="line">        System.out.println(<span class="string">"begin time:"</span> + LocalDateTime.now().format(DateTimeFormatter.ISO_LOCAL_DATE_TIME));</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">3</span>; i++) &#123;</span><br><span class="line">            Item take = queue.take();</span><br><span class="line">            System.out.format(<span class="string">"name:&#123;%s&#125;, time:&#123;%s&#125;\n"</span>,take.name, LocalDateTime.now().format(DateTimeFormatter.ISO_DATE_TIME));</span><br><span class="line">        &#125; Â   </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Item</span> <span class="keyword">implements</span> <span class="title">Delayed</span> </span>&#123;</span><br><span class="line">    <span class="comment">/* è§¦å‘æ—¶é—´*/</span> </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span> time;</span><br><span class="line">    String name;</span><br><span class="line"> Â  Â <span class="function"><span class="keyword">public</span> <span class="title">Item</span><span class="params">(String name, <span class="keyword">long</span> time, TimeUnit unit)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">        <span class="keyword">this</span>.time = System.currentTimeMillis() + (time &gt; <span class="number">0</span>? unit.toMillis(time): <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"> Â  Â <span class="meta">@Override</span> Â  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">getDelay</span><span class="params">(TimeUnit unit)</span> </span>&#123; </span><br><span class="line">        <span class="keyword">return</span> time - System.currentTimeMillis();</span><br><span class="line">    &#125;</span><br><span class="line"> Â  Â <span class="meta">@Override</span> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">compareTo</span><span class="params">(Delayed o)</span> </span>&#123; Â </span><br><span class="line">        Item item = (Item) o; Â </span><br><span class="line">        <span class="keyword">long</span> diff = <span class="keyword">this</span>.time - item.time; Â </span><br><span class="line">        <span class="keyword">if</span> (diff &lt;= <span class="number">0</span>) &#123; Â  Â </span><br><span class="line">            <span class="keyword">return</span> -<span class="number">1</span>; Â </span><br><span class="line">        &#125;<span class="keyword">else</span> &#123; Â  </span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>; </span><br><span class="line">        &#125; Â </span><br><span class="line">    &#125;</span><br><span class="line"> Â  Â <span class="meta">@Override</span> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123; Â </span><br><span class="line">        <span class="keyword">return</span> <span class="string">"Item&#123;"</span> + </span><br><span class="line">            <span class="string">"time="</span> + time + Â </span><br><span class="line">            <span class="string">", name='"</span> + name + <span class="string">'\''</span> + Â </span><br><span class="line">            <span class="string">'&#125;'</span>; </span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h5 id="3-1-5-LinkedBlockingQueue"><a href="#3-1-5-LinkedBlockingQueue" class="headerlink" title="3.1.5 LinkedBlockingQueue"></a>3.1.5 LinkedBlockingQueue</h5><p><strong>LinkedBlockingQueue</strong>æ˜¯ä¸€ä¸ªåŸºäºå•å‘é“¾è¡¨çš„ã€èŒƒå›´ä»»æ„çš„ï¼ˆå…¶å®æ˜¯æœ‰ç•Œçš„ï¼‰ã€FIFO é˜»å¡é˜Ÿåˆ—ã€‚è®¿é—® ä¸ç§»é™¤æ“ä½œæ˜¯åœ¨é˜Ÿå¤´è¿›è¡Œï¼Œæ·»åŠ æ“ä½œæ˜¯åœ¨é˜Ÿå°¾è¿›è¡Œï¼Œå¹¶åˆ†åˆ«ä½¿ç”¨ä¸åŒçš„é”è¿›è¡Œä¿æŠ¤ï¼Œåªæœ‰åœ¨å¯èƒ½æ¶‰åŠå¤š ä¸ªèŠ‚ç‚¹çš„æ“ä½œæ‰åŒæ—¶å¯¹ä¸¤ä¸ªé”è¿›è¡ŒåŠ é”ã€‚</p>
<p>é˜Ÿåˆ—æ˜¯å¦ä¸ºç©ºã€æ˜¯å¦å·²æ»¡ä»ç„¶æ˜¯é€šè¿‡å…ƒç´ æ•°é‡çš„è®¡æ•°å™¨ï¼ˆcountï¼‰è¿›è¡Œåˆ¤æ–­çš„ï¼Œç”±äºå¯ä»¥åŒæ—¶åœ¨é˜Ÿå¤´ã€ é˜Ÿå°¾å¹¶å‘åœ°è¿›è¡Œè®¿é—®ã€æ·»åŠ æ“ä½œï¼Œæ‰€ä»¥è¿™ä¸ªè®¡æ•°å™¨å¿…é¡»æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œè¿™é‡Œä½¿ç”¨äº†ä¸€ä¸ªåŸå­ç±» AtomicInteger ï¼Œè¿™å°±å†³å®šäº†å®ƒçš„å®¹é‡èŒƒå›´æ˜¯ï¼š 1 â€“ Integer.MAX_VALUEã€‚<br>ç”±äºåŒæ—¶ä½¿ç”¨äº†ä¸¤æŠŠé”ï¼Œåœ¨éœ€è¦åŒæ—¶ä½¿ç”¨ä¸¤æŠŠé”æ—¶ï¼ŒåŠ é”é¡ºåºä¸é‡Šæ”¾é¡ºåºæ˜¯éå¸¸é‡è¦çš„ï¼šå¿…é¡»ä»¥å›ºå®šçš„ é¡ºåºè¿›è¡ŒåŠ é”ï¼Œå†ä»¥ä¸åŠ é”é¡ºåºçš„ç›¸åçš„é¡ºåºé‡Šæ”¾é”ã€‚<br>å¤´ç»“ç‚¹å’Œå°¾ç»“ç‚¹ä¸€å¼€å§‹æ€»æ˜¯æŒ‡å‘ä¸€ä¸ªå“¨å…µçš„ç»“ç‚¹ï¼Œå®ƒä¸æŒæœ‰å®é™…æ•°æ®ï¼Œå½“é˜Ÿåˆ—ä¸­æœ‰æ•°æ®æ—¶ï¼Œå¤´ç»“ç‚¹ä»ç„¶ æŒ‡å‘è¿™ä¸ªå“¨å…µï¼Œå°¾ç»“ç‚¹æŒ‡å‘æœ‰æ•ˆæ•°æ®çš„åä¸€ä¸ªç»“ç‚¹ã€‚è¿™æ ·åšçš„å¥½å¤„åœ¨äºï¼Œä¸è®¡æ•°å™¨ count ç»“åˆåï¼Œ å¯¹é˜Ÿå¤´ã€é˜Ÿå°¾çš„è®¿é—®å¯ä»¥ç‹¬ç«‹è¿›è¡Œï¼Œè€Œä¸éœ€è¦åˆ¤æ–­å¤´ç»“ç‚¹ä¸å°¾ç»“ç‚¹çš„å…³ç³»ã€‚</p>
<p>ä½¿ç”¨ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.concurrent.ArrayBlockingQueue;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.BlockingQueue;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.LinkedBlockingDeque;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.LinkedBlockingQueue;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ArrayBlockingQueueDemo</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"> Â  Â  Â  Â BlockingQueue&lt;Integer&gt; blockingQueue = <span class="keyword">new</span> LinkedBlockingQueue&lt;&gt;();</span><br><span class="line">        Producer producer = <span class="keyword">new</span> Producer(blockingQueue); Â  </span><br><span class="line">        Consumer consumer = <span class="keyword">new</span> Consumer(blockingQueue); Â </span><br><span class="line">        <span class="keyword">new</span> Thread(producer).start(); Â  Â  Â </span><br><span class="line">        <span class="keyword">new</span> Thread(consumer).start(); Â </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Producer</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line"> Â  Â <span class="keyword">private</span> Â BlockingQueue&lt;Integer&gt; blockingQueue; </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> element = <span class="number">0</span>;</span><br><span class="line"> Â  Â <span class="function"><span class="keyword">public</span> <span class="title">Producer</span><span class="params">(BlockingQueue&lt;Integer&gt; blockingQueue)</span> </span>&#123; Â  </span><br><span class="line">        <span class="keyword">this</span>.blockingQueue = blockingQueue; Â </span><br><span class="line">    &#125;</span><br><span class="line"> Â  Â <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123; Â  </span><br><span class="line">        <span class="keyword">try</span> &#123; Â  Â  Â  </span><br><span class="line">            <span class="keyword">while</span>(element &lt; <span class="number">20</span>) &#123; Â  Â  Â  Â  Â </span><br><span class="line">                System.out.println(<span class="string">"ç”Ÿäº§å…ƒç´ ï¼š"</span>+element); Â  Â  Â  Â  Â  Â  Â  Â blockingQueue.put(element++); Â  Â  Â  Â  Â  </span><br><span class="line">            &#125; Â  Â  </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123; Â  </span><br><span class="line">            System.out.println(<span class="string">"ç”Ÿäº§è€…åœ¨ç­‰å¾…ç©ºé—²ç©ºé—´çš„æ—¶å€™å‘ç”Ÿå¼‚å¸¸ï¼"</span>); Â </span><br><span class="line">            e.printStackTrace(); Â </span><br><span class="line">        &#125; Â  Â  Â </span><br><span class="line">        System.out.println(<span class="string">"ç”Ÿäº§è€…ç»ˆæ­¢äº†ç”Ÿäº§è¿‡ç¨‹ï¼"</span>); Â </span><br><span class="line">    &#125;</span><br><span class="line">&#125; </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Consumer</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Â BlockingQueue&lt;Integer&gt; blockingQueue;</span><br><span class="line">Â 	<span class="function"><span class="keyword">public</span> <span class="title">Consumer</span><span class="params">(BlockingQueue&lt;Integer&gt; blockingQueue)</span> </span>&#123; Â </span><br><span class="line">        <span class="keyword">this</span>.blockingQueue = blockingQueue; </span><br><span class="line">    &#125;</span><br><span class="line"> Â  Â <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123; </span><br><span class="line">        <span class="keyword">try</span> &#123; Â  Â  Â  </span><br><span class="line">            <span class="keyword">while</span>(<span class="keyword">true</span>) &#123; Â </span><br><span class="line">                System.out.println(<span class="string">"æ¶ˆè´¹å…ƒç´ ï¼š"</span>+blockingQueue.take()); Â  Â </span><br><span class="line">            &#125; Â  Â  Â  </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123; Â  Â  </span><br><span class="line">            System.out.println(<span class="string">"æ¶ˆè´¹è€…åœ¨ç­‰å¾…æ–°äº§å“çš„æ—¶å€™å‘ç”Ÿå¼‚å¸¸ï¼"</span>);</span><br><span class="line">            e.printStackTrace(); Â  Â </span><br><span class="line">        &#125; Â  Â  </span><br><span class="line">        System.out.println(<span class="string">"æ¶ˆè´¹è€…ç»ˆæ­¢äº†æ¶ˆè´¹è¿‡ç¨‹ï¼"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="3-1-6-LinkedBlockingDeque"><a href="#3-1-6-LinkedBlockingDeque" class="headerlink" title="3.1.6 LinkedBlockingDeque"></a>3.1.6 LinkedBlockingDeque</h5><p><strong>LinkedBlockingDeque</strong>æ˜¯ä¸€ä¸ªç”±é“¾è¡¨ç»“æ„ç»„æˆçš„åŒå‘é˜»å¡é˜Ÿåˆ—ã€‚æ‰€è°“åŒå‘é˜Ÿåˆ—æŒ‡çš„ä½ å¯ä»¥ä»é˜Ÿåˆ—çš„ä¸¤ ç«¯æ’å…¥å’Œç§»å‡ºå…ƒç´ ã€‚åŒç«¯é˜Ÿåˆ—å› ä¸ºå¤šäº†ä¸€ä¸ªæ“ä½œé˜Ÿåˆ—çš„å…¥å£ï¼Œåœ¨å¤šçº¿ç¨‹åŒæ—¶å…¥é˜Ÿæ—¶ï¼Œä¹Ÿå°±å‡å°‘äº†ä¸€åŠçš„ ç«äº‰ã€‚ç›¸æ¯”å…¶ä»–çš„é˜»å¡é˜Ÿåˆ—ï¼ŒLinkedBlockingDequeå¤šäº†addFirstï¼ŒaddLastï¼ŒofferFirstï¼Œ offerLastï¼ŒpeekFirstï¼ŒpeekLastç­‰æ–¹æ³•ï¼Œä»¥Firstå•è¯ç»“å°¾çš„æ–¹æ³•ï¼Œè¡¨ç¤ºæ’å…¥ï¼Œè·å–ï¼ˆpeekï¼‰æˆ–ç§» é™¤åŒç«¯é˜Ÿåˆ—çš„ç¬¬ä¸€ä¸ªå…ƒç´ ã€‚ä»¥Lastå•è¯ç»“å°¾çš„æ–¹æ³•ï¼Œè¡¨ç¤ºæ’å…¥ï¼Œè·å–æˆ–ç§»é™¤åŒç«¯é˜Ÿåˆ—çš„åä¸€ä¸ªå…ƒç´ ã€‚ å¦å¤–æ’å…¥æ–¹æ³•addç­‰åŒäºaddLastï¼Œç§»é™¤æ–¹æ³•removeç­‰æ•ˆäºremoveFirstã€‚åœ¨åˆå§‹åŒ– LinkedBlockingDequeæ—¶å¯ä»¥åˆå§‹åŒ–é˜Ÿåˆ—çš„å®¹é‡ï¼Œç”¨æ¥é˜²æ­¢å…¶å†æ‰©å®¹æ—¶è¿‡æ¸¡è†¨èƒ€ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.concurrent.ArrayBlockingQueue;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.BlockingQueue; <span class="keyword">import</span> java.util.concurrent.LinkedBlockingDeque;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LinkedBlockingQueueDemo</span> </span>&#123; </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"> Â  Â  Â  Â BlockingQueue&lt;Integer&gt; blockingQueue = <span class="keyword">new</span> LinkedBlockingDeque&lt;Integer&gt;(); Â </span><br><span class="line">        Producer producer = <span class="keyword">new</span> Producer(blockingQueue); Â </span><br><span class="line">        Consumer consumer = <span class="keyword">new</span> Consumer(blockingQueue); Â  Â  </span><br><span class="line">        <span class="keyword">new</span> Thread(producer).start(); Â </span><br><span class="line">        <span class="keyword">new</span> Thread(consumer).start(); Â </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Producer</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line"> Â  Â <span class="keyword">private</span> Â BlockingQueue&lt;Integer&gt; blockingQueue; </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> element = <span class="number">0</span>;</span><br><span class="line"> Â  Â <span class="function"><span class="keyword">public</span> <span class="title">Producer</span><span class="params">(BlockingQueue&lt;Integer&gt; blockingQueue)</span> </span>&#123; Â  </span><br><span class="line">        <span class="keyword">this</span>.blockingQueue = blockingQueue; Â </span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123; Â  </span><br><span class="line">        <span class="keyword">try</span> &#123; Â  Â  </span><br><span class="line">            <span class="keyword">while</span>(element &lt; <span class="number">20</span>) &#123; Â  Â </span><br><span class="line">                System.out.println(<span class="string">"ç”Ÿäº§å…ƒç´ ï¼š"</span>+element); Â </span><br><span class="line">                blockingQueue.put(element++); Â  Â  Â  Â </span><br><span class="line">            &#125; Â  Â </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123; Â  Â  Â </span><br><span class="line">            System.out.println(<span class="string">"ç”Ÿäº§è€…åœ¨ç­‰å¾…ç©ºé—²ç©ºé—´çš„æ—¶å€™å‘ç”Ÿå¼‚å¸¸ï¼"</span>); Â  Â  Â  Â  Â  Â e.printStackTrace(); Â </span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">    	System.out.println(<span class="string">"ç”Ÿäº§è€…ç»ˆæ­¢äº†ç”Ÿäº§è¿‡ç¨‹ï¼"</span>); </span><br><span class="line">    &#125; </span><br><span class="line">&#125; </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Consumer</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123; Â  </span><br><span class="line">    <span class="keyword">private</span> Â BlockingQueue&lt;Integer&gt; blockingQueue; Â </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Consumer</span><span class="params">(BlockingQueue&lt;Integer&gt; blockingQueue)</span> </span>&#123; Â  Â  </span><br><span class="line">        <span class="keyword">this</span>.blockingQueue = blockingQueue; </span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line"> Â  Â <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123; Â  Â </span><br><span class="line">        <span class="keyword">try</span> &#123; Â  Â  Â  Â </span><br><span class="line">            <span class="keyword">while</span>(<span class="keyword">true</span>) &#123; Â  Â </span><br><span class="line">                System.out.println(<span class="string">"æ¶ˆè´¹å…ƒç´ ï¼š"</span>+blockingQueue.take()); Â </span><br><span class="line">            &#125; Â  Â  Â </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123; Â  Â  </span><br><span class="line">            System.out.println(<span class="string">"æ¶ˆè´¹è€…åœ¨ç­‰å¾…æ–°äº§å“çš„æ—¶å€™å‘ç”Ÿå¼‚å¸¸ï¼"</span>); Â </span><br><span class="line">            e.printStackTrace(); Â  Â  </span><br><span class="line">        &#125; Â  Â  Â  </span><br><span class="line">        System.out.println(<span class="string">"æ¶ˆè´¹è€…ç»ˆæ­¢äº†æ¶ˆè´¹è¿‡ç¨‹ï¼"</span>); Â </span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="3-1-7-SynchronousQueue"><a href="#3-1-7-SynchronousQueue" class="headerlink" title="3.1.7 SynchronousQueue"></a>3.1.7 SynchronousQueue</h5><p><strong>SynchronousQueue</strong>æ˜¯ä¸€ä¸ªæ²¡æœ‰æ•°æ®ç¼“å†²çš„BlockingQueueï¼Œç”Ÿäº§è€…çº¿ç¨‹å¯¹å…¶çš„æ’å…¥æ“ä½œputå¿…é¡»ç­‰å¾… æ¶ˆè´¹è€…çš„ç§»é™¤æ“ä½œtakeï¼Œåè¿‡æ¥ä¹Ÿä¸€æ ·ã€‚<br>SynchronousQueueå†…éƒ¨å¹¶æ²¡æœ‰æ•°æ®ç¼“å­˜ç©ºé—´ï¼Œä½ ä¸èƒ½è°ƒç”¨peek()æ–¹æ³•æ¥çœ‹é˜Ÿåˆ—ä¸­æ˜¯å¦æœ‰æ•°æ®å…ƒç´ ï¼Œå›  ä¸ºæ•°æ®å…ƒç´ åªæœ‰å½“ä½ è¯•ç€å–èµ°çš„æ—¶å€™æ‰å¯èƒ½å­˜åœ¨ï¼Œä¸å–èµ°è€Œåªæƒ³å·çª¥ä¸€ä¸‹æ˜¯ä¸è¡Œçš„ï¼Œå½“ç„¶éå†è¿™ä¸ªé˜Ÿåˆ— çš„æ“ä½œä¹Ÿæ˜¯ä¸å…è®¸çš„ã€‚<br>æ•°æ®æ˜¯åœ¨é…å¯¹çš„ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…çº¿ç¨‹ä¹‹é—´ç›´æ¥ä¼ é€’çš„ï¼Œå¹¶ä¸ä¼šå°†æ•°æ®ç¼“å†²åˆ°é˜Ÿåˆ—ä¸­ã€‚<br>SynchronousQueueæ”¯æŒå…¬å¹³è®¿é—®é˜Ÿåˆ—ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œçº¿ç¨‹é‡‡ç”¨éå…¬å¹³ç­–ç•¥ï¼Œå¦‚æœä½¿ç”¨å…¬å¹³ç­–ç•¥ï¼Œç­‰å¾… çš„çº¿ç¨‹é‡‡ç”¨å…ˆè¿›å…ˆå‡ºçš„é¡ºåºè®¿é—®é˜Ÿåˆ—ã€‚<br>SynchronousQueueé€‚åˆä¼ é€’æ€§åœºæ™¯ï¼Œä¸€ä¸ªä½¿ç”¨åœºæ™¯æ˜¯åœ¨çº¿ç¨‹æ± é‡Œã€‚ Executors.newCachedThreadPool()å°±ä½¿ç”¨äº†SynchronousQueueï¼Œè¿™ä¸ªçº¿ç¨‹æ± æ ¹æ®éœ€è¦ï¼ˆæ–°ä»»åŠ¡åˆ° æ¥æ—¶ï¼‰åˆ›å»ºæ–°çš„çº¿ç¨‹ï¼Œå¦‚æœæœ‰ç©ºé—²çº¿ç¨‹åˆ™ä¼šé‡å¤ä½¿ç”¨ï¼Œçº¿ç¨‹ç©ºé—²äº†60ç§’åä¼šè¢«å›æ”¶ã€‚</p>
<p>ä½¿ç”¨</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.concurrent.*;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SynchronousQueueDemo</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"> Â  Â  Â  Â BlockingQueue&lt;Integer&gt; blockingQueue = <span class="keyword">new</span> SynchronousQueue&lt;&gt;(); Â  </span><br><span class="line">        Producer producer = <span class="keyword">new</span> Producer(blockingQueue); Â  Â  Â </span><br><span class="line">        Consumer consumer = <span class="keyword">new</span> Consumer(blockingQueue);</span><br><span class="line"> Â  Â  Â  Â <span class="keyword">new</span> Thread(producer).start(); Â  Â  </span><br><span class="line">        <span class="keyword">new</span> Thread(consumer).start();</span><br><span class="line"> Â   &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Producer</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line"> Â  Â <span class="keyword">private</span> Â BlockingQueue&lt;Integer&gt; blockingQueue; Â  </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> element = <span class="number">0</span>;</span><br><span class="line"> Â  Â <span class="function"><span class="keyword">public</span> <span class="title">Producer</span><span class="params">(BlockingQueue&lt;Integer&gt; blockingQueue)</span> </span>&#123; Â  </span><br><span class="line">        <span class="keyword">this</span>.blockingQueue = blockingQueue; Â </span><br><span class="line">    &#125;</span><br><span class="line"> Â  Â <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123; Â  Â  </span><br><span class="line">        <span class="keyword">try</span> &#123; Â  Â  Â  </span><br><span class="line">            <span class="keyword">while</span>(element &lt; <span class="number">20</span>) &#123;</span><br><span class="line">                System.out.println(<span class="string">"ç”Ÿäº§å…ƒç´ ï¼š"</span>+element); Â  </span><br><span class="line">                blockingQueue.put(element++); Â  Â </span><br><span class="line">            &#125; Â  Â  Â  </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123; Â  Â  Â </span><br><span class="line">            System.out.println(<span class="string">"ç”Ÿäº§è€…åœ¨ç­‰å¾…ç©ºé—²ç©ºé—´çš„æ—¶å€™å‘ç”Ÿå¼‚å¸¸ï¼"</span>); Â  Â  Â  </span><br><span class="line">            e.printStackTrace(); Â </span><br><span class="line">        &#125; Â  Â  Â  </span><br><span class="line">        </span><br><span class="line">        System.out.println(<span class="string">"ç”Ÿäº§è€…ç»ˆæ­¢äº†ç”Ÿäº§è¿‡ç¨‹ï¼"</span>); </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Consumer</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line"> Â  Â <span class="keyword">private</span> Â BlockingQueue&lt;Integer&gt; blockingQueue;</span><br><span class="line"> Â  Â <span class="function"><span class="keyword">public</span> <span class="title">Consumer</span><span class="params">(BlockingQueue&lt;Integer&gt; blockingQueue)</span> </span>&#123; Â  Â  </span><br><span class="line">        <span class="keyword">this</span>.blockingQueue = blockingQueue; Â  </span><br><span class="line">    &#125;</span><br><span class="line"> Â  Â <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123; Â  </span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line"> Â  Â  Â  Â  Â  Â <span class="keyword">while</span>(<span class="keyword">true</span>) &#123; Â  Â  Â  Â  Â </span><br><span class="line">                Thread.sleep(<span class="number">1000l</span>); Â  </span><br><span class="line">                System.out.println(<span class="string">"æ¶ˆè´¹å…ƒç´ ï¼š"</span>+blockingQueue.take()); Â  Â  Â </span><br><span class="line">            &#125; Â  Â  Â   </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            System.out.println(<span class="string">"æ¶ˆè´¹è€…åœ¨ç­‰å¾…æ–°äº§å“çš„æ—¶å€™å‘ç”Ÿå¼‚å¸¸ï¼"</span>); </span><br><span class="line">            e.printStackTrace(); Â </span><br><span class="line">        &#125; Â  Â  Â  Â </span><br><span class="line">        System.out.println(<span class="string">"æ¶ˆè´¹è€…ç»ˆæ­¢äº†æ¶ˆè´¹è¿‡ç¨‹ï¼"</span>); </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="3-1-8-LinkedTransferQueue"><a href="#3-1-8-LinkedTransferQueue" class="headerlink" title="3.1.8 LinkedTransferQueue"></a>3.1.8 LinkedTransferQueue</h5><p><strong>LinkedTransferQueue</strong>æ˜¯ä¸€ä¸ªç”±é“¾è¡¨ç»“æ„ç»„æˆçš„æ— ç•Œé˜»å¡TransferQueueé˜Ÿåˆ—ã€‚ç›¸å¯¹äºå…¶ä»–é˜»å¡é˜Ÿåˆ— LinkedTransferQueueå¤šäº†tryTransferå’Œtransferæ–¹æ³•ã€‚<br>transferæ–¹æ³•ã€‚å¦‚æœå½“å‰æœ‰æ¶ˆè´¹è€…æ­£åœ¨ç­‰å¾…æ¥æ”¶å…ƒç´ ï¼ˆæ¶ˆè´¹è€…ä½¿ç”¨take()æ–¹æ³•æˆ–å¸¦æ—¶é—´é™åˆ¶çš„poll() æ–¹æ³•æ—¶ï¼‰ï¼Œtransferæ–¹æ³•å¯ä»¥æŠŠç”Ÿäº§è€…ä¼ å…¥çš„å…ƒç´ ç«‹åˆ»transferï¼ˆä¼ è¾“ï¼‰ç»™æ¶ˆè´¹è€…ã€‚å¦‚æœæ²¡æœ‰æ¶ˆè´¹è€… åœ¨ç­‰å¾…æ¥æ”¶å…ƒç´ ï¼Œtransferæ–¹æ³•ä¼šå°†å…ƒç´ å­˜æ”¾åœ¨é˜Ÿåˆ—çš„tailèŠ‚ç‚¹ï¼Œå¹¶ç­‰åˆ°è¯¥å…ƒç´ è¢«æ¶ˆè´¹è€…æ¶ˆè´¹äº†æ‰è¿” å›ã€‚transferæ–¹æ³•çš„å…³é”®ä»£ç å¦‚ä¸‹ï¼š<br>ç¬¬ä¸€è¡Œä»£ç æ˜¯è¯•å›¾æŠŠå­˜æ”¾å½“å‰å…ƒç´ çš„sèŠ‚ç‚¹ä½œä¸ºtailèŠ‚ç‚¹ã€‚ç¬¬äºŒè¡Œä»£ç æ˜¯è®©CPUè‡ªæ—‹ç­‰å¾…æ¶ˆè´¹è€…æ¶ˆè´¹å…ƒ ç´ ã€‚å› ä¸ºè‡ªæ—‹ä¼šæ¶ˆè€—CPUï¼Œæ‰€ä»¥è‡ªæ—‹ä¸€å®šçš„æ¬¡æ•°åä½¿ç”¨Thread.yield()æ–¹æ³•æ¥æš‚åœå½“å‰æ­£åœ¨æ‰§è¡Œçš„çº¿ ç¨‹ï¼Œå¹¶æ‰§è¡Œå…¶ä»–çº¿ç¨‹ã€‚<br>tryTransferæ–¹æ³•ã€‚åˆ™æ˜¯ç”¨æ¥è¯•æ¢ä¸‹ç”Ÿäº§è€…ä¼ å…¥çš„å…ƒç´ æ˜¯å¦èƒ½ç›´æ¥ä¼ ç»™æ¶ˆè´¹è€…ã€‚å¦‚æœæ²¡æœ‰æ¶ˆè´¹è€…ç­‰å¾…æ¥ æ”¶å…ƒç´ ï¼Œåˆ™è¿”å›falseã€‚å’Œtransferæ–¹æ³•çš„åŒºåˆ«æ˜¯tryTransferæ–¹æ³•æ— è®ºæ¶ˆè´¹è€…æ˜¯å¦æ¥æ”¶ï¼Œæ–¹æ³•ç«‹å³è¿” å›ã€‚è€Œtransferæ–¹æ³•æ˜¯å¿…é¡»ç­‰åˆ°æ¶ˆè´¹è€…æ¶ˆè´¹äº†æ‰è¿”å›ã€‚<br>å¯¹äºå¸¦æœ‰æ—¶é—´é™åˆ¶çš„tryTransfer(E e, long timeout, TimeUnit unit)æ–¹æ³•ï¼Œåˆ™æ˜¯è¯•å›¾æŠŠç”Ÿäº§è€… ä¼ å…¥çš„å…ƒç´ ç›´æ¥ä¼ ç»™æ¶ˆè´¹è€…ï¼Œä½†æ˜¯å¦‚æœæ²¡æœ‰æ¶ˆè´¹è€…æ¶ˆè´¹è¯¥å…ƒç´ åˆ™ç­‰å¾…æŒ‡å®šçš„æ—¶é—´å†è¿”å›ï¼Œå¦‚æœè¶…æ—¶è¿˜æ²¡ æ¶ˆè´¹å…ƒç´ ï¼Œåˆ™è¿”å›falseï¼Œå¦‚æœåœ¨è¶…æ—¶æ—¶é—´å†…æ¶ˆè´¹äº†å…ƒç´ ï¼Œåˆ™è¿”å›trueã€‚</p>
<p>ä½¿ç”¨ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.concurrent.*;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LinkedTransferQueueTest</span> </span>&#123; </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"> Â  Â  Â  Â LinkedTransferQueue&lt;Integer&gt; blockingQueue = <span class="keyword">new</span> LinkedTransferQueue&lt;Integer&gt;(); </span><br><span class="line">        Producer producer = <span class="keyword">new</span> Producer(blockingQueue); </span><br><span class="line">        Consumer consumer = <span class="keyword">new</span> Consumer(blockingQueue);</span><br><span class="line"> Â  Â  Â  Â <span class="keyword">new</span> Thread(producer).start(); Â </span><br><span class="line">        <span class="keyword">new</span> Thread(consumer).start(); Â  </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Producer</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line"> Â  Â <span class="keyword">private</span> Â LinkedTransferQueue&lt;Integer&gt; linkedTransferQueue;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> element = <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line"> Â  Â <span class="function"><span class="keyword">public</span> <span class="title">Producer</span><span class="params">(LinkedTransferQueue&lt;Integer&gt; linkedTransferQueue)</span> </span>&#123; </span><br><span class="line">        <span class="keyword">this</span>.linkedTransferQueue = linkedTransferQueue;</span><br><span class="line"> &#125;</span><br><span class="line"> Â  Â <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123; </span><br><span class="line">        <span class="keyword">try</span> &#123; Â  Â  Â  </span><br><span class="line">            <span class="keyword">while</span>(element &lt; <span class="number">20</span>) &#123; Â  Â  </span><br><span class="line">                System.out.println(<span class="string">"ç”Ÿäº§å…ƒç´ ï¼š"</span>+element); Â  Â  Â </span><br><span class="line">                linkedTransferQueue.put(element++); Â  Â  </span><br><span class="line">            &#125; Â  Â  Â  </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123; Â  Â  Â  </span><br><span class="line">            System.out.println(<span class="string">"ç”Ÿäº§è€…åœ¨ç­‰å¾…ç©ºé—²ç©ºé—´çš„æ—¶å€™å‘ç”Ÿå¼‚å¸¸ï¼"</span>); Â </span><br><span class="line">            e.printStackTrace(); Â  Â  </span><br><span class="line">        &#125; Â  Â </span><br><span class="line">        System.out.println(<span class="string">"ç”Ÿäº§è€…ç»ˆæ­¢äº†ç”Ÿäº§è¿‡ç¨‹ï¼"</span>); </span><br><span class="line">    &#125; </span><br><span class="line">&#125; </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Consumer</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line"> Â  Â <span class="keyword">private</span> Â LinkedTransferQueue&lt;Integer&gt; linkedTransferQueue;</span><br><span class="line"> Â  Â <span class="function"><span class="keyword">public</span> <span class="title">Consumer</span><span class="params">(LinkedTransferQueue&lt;Integer&gt; linkedTransferQueue)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.linkedTransferQueue = linkedTransferQueue; Â </span><br><span class="line">    &#125;</span><br><span class="line"> Â  Â <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123; Â  </span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line"> Â  Â  Â  Â  Â  Â <span class="keyword">while</span>(<span class="keyword">true</span>) &#123; Â  Â  Â </span><br><span class="line">                Thread.sleep(<span class="number">1000l</span>); Â  </span><br><span class="line">                System.out.println(<span class="string">"æ¶ˆè´¹å…ƒç´ ï¼š"</span>+linkedTransferQueue.take()); Â  Â  Â  </span><br><span class="line">            &#125; Â  Â  </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123; Â  Â  Â  Â </span><br><span class="line">            System.out.println(<span class="string">"æ¶ˆè´¹è€…åœ¨ç­‰å¾…æ–°äº§å“çš„æ—¶å€™å‘ç”Ÿå¼‚å¸¸ï¼"</span>); Â  Â </span><br><span class="line">            e.printStackTrace(); Â  Â  </span><br><span class="line">        &#125; Â  Â  </span><br><span class="line">        System.out.println(<span class="string">"æ¶ˆè´¹è€…ç»ˆæ­¢äº†æ¶ˆè´¹è¿‡ç¨‹ï¼"</span>); </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="3-1-9-ConcurrentHashMap"><a href="#3-1-9-ConcurrentHashMap" class="headerlink" title="3.1.9 ConcurrentHashMap"></a>3.1.9 ConcurrentHashMap</h5><h6 id="HashMapå®¹é‡"><a href="#HashMapå®¹é‡" class="headerlink" title="HashMapå®¹é‡"></a>HashMapå®¹é‡</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* Constructs an empty &lt;tt&gt;HashMap&lt;/tt&gt; with the specified initial </span></span><br><span class="line"><span class="comment">* capacity and load factor. </span></span><br><span class="line"><span class="comment">* </span></span><br><span class="line"><span class="comment">* <span class="doctag">@param</span>  initialCapacity the initial capacity </span></span><br><span class="line"><span class="comment">* <span class="doctag">@param</span>  loadFactor Â  Â   the load factor </span></span><br><span class="line"><span class="comment">* <span class="doctag">@throws</span> IllegalArgumentException if the initial capacity is negative </span></span><br><span class="line"><span class="comment">* Â  Â  Â  Â  or the load factor is nonpositive </span></span><br><span class="line"><span class="comment">*/</span> </span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">HashMap</span><span class="params">(<span class="keyword">int</span> initialCapacity, <span class="keyword">float</span> loadFactor)</span> </span>&#123; </span><br><span class="line">    <span class="keyword">if</span> (initialCapacity &lt; <span class="number">0</span>) Â  Â  </span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Illegal initial capacity: "</span> + Â  Â  Â </span><br><span class="line">                                           initialCapacity);</span><br><span class="line">    </span><br><span class="line">Â <span class="keyword">if</span> (initialCapacity &gt; MAXIMUM_CAPACITY) </span><br><span class="line">     initialCapacity = MAXIMUM_CAPACITY; Â  </span><br><span class="line">    <span class="keyword">if</span> (loadFactor &lt;= <span class="number">0</span> || Float.isNaN(loadFactor)) </span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Illegal load factor: "</span> + Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  loadFactor); Â </span><br><span class="line">    <span class="keyword">this</span>.loadFactor = loadFactor; Â </span><br><span class="line">    <span class="keyword">this</span>.threshold = tableSizeFor(initialCapacity);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç»™å®šçš„é»˜è®¤å®¹é‡ä¸º 16ï¼Œè´Ÿè½½å› å­ä¸º 0.75ã€‚Map åœ¨ä½¿ç”¨è¿‡ç¨‹ä¸­ä¸æ–­çš„å¾€é‡Œé¢å­˜æ”¾æ•°æ®ï¼Œå½“æ•°é‡è¾¾åˆ°äº† 16 * 0.75 = 12 å°±éœ€è¦å°†å½“å‰ 16 çš„å®¹é‡è¿›è¡Œæ‰©å®¹ï¼Œè€Œæ‰©å®¹è¿™ä¸ªè¿‡ç¨‹æ¶‰åŠåˆ° rehashã€å¤åˆ¶æ•°æ®ç­‰ æ“ä½œï¼Œæ‰€ä»¥éå¸¸æ¶ˆè€—æ€§èƒ½ã€‚<br>å› æ­¤é€šå¸¸å»ºè®®èƒ½æå‰é¢„ä¼° HashMap çš„å¤§å°å¥½ï¼Œå°½é‡çš„å‡å°‘æ‰©å®¹å¸¦æ¥çš„æ€§èƒ½æŸè€—ã€‚<br>çº¿ç¨‹ä¸å®‰å…¨çš„ HashMap<br>å› ä¸ºå¤šçº¿ç¨‹ç¯å¢ƒä¸‹ï¼Œä½¿ç”¨ HashMap è¿›è¡Œ put æ“ä½œä¼šå¼•èµ·æ­»å¾ªç¯ï¼Œå¯¼è‡´ CPU åˆ©ç”¨ç‡æ¥è¿‘ 100%ï¼Œæ‰€ä»¥ åœ¨å¹¶å‘æƒ…å†µä¸‹ä¸èƒ½ä½¿ç”¨ HashMapï¼Œå¦‚ä»¥ä¸‹ä»£ç </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> HashMap&lt;String, String&gt; map = <span class="keyword">new</span> HashMap&lt;String, String&gt;(<span class="number">2</span>);</span><br><span class="line">Thread t = <span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123; Â </span><br><span class="line">    <span class="meta">@Override</span> Â </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10000</span>; i++) &#123; Â </span><br><span class="line">            <span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123; Â  Â  Â </span><br><span class="line">                <span class="meta">@Override</span> Â  Â  Â  Â  Â  Â  Â </span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123; Â  </span><br><span class="line">                    map.put(UUID.randomUUID().toString(), <span class="string">""</span>); Â  Â  </span><br><span class="line">                &#125; Â  Â  Â  Â  Â </span><br><span class="line">            &#125;, <span class="string">"kaikeba"</span> + i).start(); Â  </span><br><span class="line">        &#125; Â  </span><br><span class="line">    &#125;</span><br><span class="line">&#125;, <span class="string">"kaikeba"</span>);</span><br><span class="line">t.start();</span><br><span class="line">t.join();</span><br></pre></td></tr></table></figure>

<h6 id="æ•ˆç‡ä½ä¸‹çš„-HashTable-å®¹å™¨"><a href="#æ•ˆç‡ä½ä¸‹çš„-HashTable-å®¹å™¨" class="headerlink" title="æ•ˆç‡ä½ä¸‹çš„ HashTable å®¹å™¨"></a>æ•ˆç‡ä½ä¸‹çš„ HashTable å®¹å™¨</h6><p>HashTable å®¹å™¨ä½¿ç”¨ syncronizedæ¥ä¿è¯çº¿ç¨‹å®‰å…¨ï¼Œä½†åœ¨çº¿ç¨‹ç«äº‰æ¿€çƒˆçš„æƒ…å†µä¸‹ HashTable çš„æ•ˆç‡ éå¸¸ä½ä¸‹ã€‚å› ä¸ºå½“ä¸€ä¸ªçº¿ç¨‹è®¿é—® HashTable çš„åŒæ­¥æ–¹æ³•æ—¶ï¼Œå…¶ä»–çº¿ç¨‹è®¿é—® HashTable çš„åŒæ­¥æ–¹æ³• æ—¶ï¼Œå¯èƒ½ä¼šè¿›å…¥é˜»å¡æˆ–è½®è¯¢çŠ¶æ€ã€‚å¦‚çº¿ç¨‹ 1 ä½¿ç”¨ put è¿›è¡Œæ·»åŠ å…ƒç´ ï¼Œçº¿ç¨‹ 2 ä¸ä½†ä¸èƒ½ä½¿ç”¨ put æ–¹ æ³•æ·»åŠ å…ƒç´ ï¼Œå¹¶ä¸”ä¹Ÿä¸èƒ½ä½¿ç”¨ get æ–¹æ³•æ¥è·å–å…ƒç´ ï¼Œæ‰€ä»¥ç«äº‰è¶Šæ¿€çƒˆæ•ˆç‡è¶Šä½ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.Iterator; </span><br><span class="line"><span class="keyword">import</span> java.util.Map; </span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ConcurrentHashMap;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConcurrentHashMapTest</span> </span>&#123;</span><br><span class="line"> Â  Â <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">Â 		Map&lt;String, String&gt; map = <span class="keyword">new</span> ConcurrentHashMap&lt;String, String&gt;(); Â </span><br><span class="line">        map.put(<span class="string">"key1"</span>, <span class="string">"1"</span>); </span><br><span class="line">        map.put(<span class="string">"key2"</span>, <span class="string">"2"</span>); Â </span><br><span class="line">        map.put(<span class="string">"key3"</span>, <span class="string">"3"</span>); Â  Â </span><br><span class="line">        map.put(<span class="string">"key4"</span>, <span class="string">"4"</span>); Â  Â </span><br><span class="line">        Iterator&lt;String&gt; it = map.keySet().iterator();</span><br><span class="line"> Â  Â  Â  Â <span class="keyword">while</span> (it.hasNext()) &#123; Â </span><br><span class="line">            String key = it.next(); Â  Â </span><br><span class="line">            System.out.println(key + <span class="string">","</span>+ map.get(key));</span><br><span class="line"> Â  Â  Â   &#125; </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="3-1-10-ConcurrentSkipListMap"><a href="#3-1-10-ConcurrentSkipListMap" class="headerlink" title="3.1.10 ConcurrentSkipListMap"></a>3.1.10 ConcurrentSkipListMap</h5><p>JDK1.6æ—¶ï¼Œä¸ºäº†å¯¹é«˜å¹¶å‘ç¯å¢ƒä¸‹çš„æœ‰åºMapæä¾›æ›´å¥½çš„æ”¯æŒï¼ŒJ.U.Cæ–°å¢äº†ä¸€ä¸ª ConcurrentNavigableMapæ¥å£ï¼ŒConcurrentNavigableMapå¾ˆç®€å•ï¼Œå®ƒåŒæ—¶å®ç°äº†NavigableMapå’Œ ConcurrentMapæ¥å£ã€‚<br>ConcurrentNavigableMapæ¥å£æä¾›çš„åŠŸèƒ½ä¹Ÿå’ŒNavigableMapå‡ ä¹å®Œå…¨ä¸€è‡´ï¼Œå¾ˆå¤šæ–¹æ³•ä»…ä»…æ˜¯è¿”å›çš„ ç±»å‹ä¸åŒã€‚<br>NavigableMapæ¥å£ï¼Œè¿›ä¸€æ­¥æ‰©å±•äº†SortedMapçš„åŠŸèƒ½ï¼Œæä¾›äº†æ ¹æ®æŒ‡å®šKeyè¿”å›æ¥è¿‘é¡¹ã€æŒ‰å‡åº/é™ åºè¿”å›æ‰€æœ‰é”®çš„è§†å›¾ç­‰åŠŸèƒ½ã€‚<br>J.U.Cæä¾›äº†åŸºäºConcurrentNavigableMapæ¥å£çš„ä¸€ä¸ªå®ç°â€”â€” ConcurrentSkipListMap ã€‚ ConcurrentSkipListMapå¯ä»¥çœ‹æˆæ˜¯å¹¶å‘ç‰ˆæœ¬çš„TreeMapï¼Œä½†æ˜¯å’ŒTreeMapä¸åŒæ˜¯ï¼Œ ConcurrentSkipListMapå¹¶ä¸æ˜¯åŸºäºçº¢é»‘æ ‘å®ç°çš„ï¼Œå…¶åº•å±‚æ˜¯ä¸€ç§ç±»ä¼¼è·³è¡¨ï¼ˆSkip Listï¼‰çš„ç»“æ„ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ConcurrentNavigableMap; </span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ConcurrentSkipListMap;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConcurrentSkipListMapTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123; Â  Â  Â  </span><br><span class="line">        ConcurrentSkipListMap&lt;String, Contact&gt; map = <span class="keyword">new</span> ConcurrentSkipListMap&lt;&gt;();</span><br><span class="line">        Thread threads[]=<span class="keyword">new</span> Thread[<span class="number">25</span>]; Â  Â </span><br><span class="line">        <span class="keyword">int</span> counter=<span class="number">0</span>; Â  Â  </span><br><span class="line">        <span class="comment">//åˆ›å»ºå’Œå¯åŠ¨25ä¸ªä»»åŠ¡ï¼Œå¯¹äºæ¯ä¸ªä»»åŠ¡æŒ‡å®šä¸€ä¸ªå¤§å†™å­—æ¯ä½œä¸ºID Â  Â </span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">char</span> i=<span class="string">'A'</span>; i&lt;<span class="string">'Z'</span>; i++) &#123; Â  </span><br><span class="line">            Task0 task=<span class="keyword">new</span> Task0(map, String.valueOf(i)); Â  Â  </span><br><span class="line">            threads[counter]=<span class="keyword">new</span> Thread(task); Â  Â </span><br><span class="line">            threads[counter].start(); Â  </span><br><span class="line">            counter++; Â  Â  Â </span><br><span class="line">        &#125; Â  Â  Â  Â  Â  Â </span><br><span class="line">        <span class="comment">//ä½¿ç”¨join()æ–¹æ³•ç­‰å¾…çº¿ç¨‹çš„ç»“æŸ Â  Â </span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;<span class="number">25</span>; i++) &#123;</span><br><span class="line">Â 			<span class="keyword">try</span> &#123; Â  Â  Â  Â  Â  Â  Â  </span><br><span class="line">                threads[i].join(); Â  Â  Â  Â  Â </span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123; Â  Â  Â  Â  Â </span><br><span class="line">                e.printStackTrace(); Â  Â  Â  Â  Â </span><br><span class="line">            &#125; Â  Â  Â  </span><br><span class="line">        &#125; Â  Â  Â  Â  Â </span><br><span class="line">        System.out.printf(<span class="string">"Size of the map: %d\n"</span>,map.size()); Â  </span><br><span class="line">        Map.Entry&lt;String, Contact&gt; element; Â  Â  Â  Â  Â  </span><br><span class="line">        Contact contact; Â  Â  Â </span><br><span class="line">        <span class="comment">// ä½¿ç”¨firstEntry()æ–¹æ³•è·å–mapçš„ç¬¬ä¸€ä¸ªå®ä½“ï¼Œå¹¶è¾“å‡ºã€‚ </span></span><br><span class="line">        element=map.firstEntry(); Â  Â  </span><br><span class="line">        contact=element.getValue(); Â  Â  Â  Â </span><br><span class="line">        System.out.printf(<span class="string">"First Entry: %s: %s\n"</span>,contact. Â </span><br><span class="line">                          getName(),contact.getPhone()); Â  </span><br><span class="line">        <span class="comment">//ä½¿ç”¨lastEntry()æ–¹æ³•è·å–mapçš„æœ€åä¸€ä¸ªå®ä½“ï¼Œå¹¶è¾“å‡ºã€‚ Â  </span></span><br><span class="line">        element=map.lastEntry(); Â  Â  Â  Â  </span><br><span class="line">        contact=element.getValue(); Â  Â  </span><br><span class="line">        System.out.printf(<span class="string">"Last Entry: %s: %s\n"</span>,contact. Â  Â  Â  Â  Â  Â  Â  Â  Â  Â getName(),contact.getPhone()); Â  Â  Â  Â </span><br><span class="line">        <span class="comment">//ä½¿ç”¨subMap()æ–¹æ³•è·å–mapçš„å­mapï¼Œå¹¶è¾“å‡ºã€‚</span></span><br><span class="line">        System.out.printf(<span class="string">"Submap from A1996 to B1002: \n"</span>);</span><br><span class="line">        ConcurrentNavigableMap&lt;String, Contact&gt; submap=map.</span><br><span class="line"> Â  Â  Â  Â  Â  Â subMap(<span class="string">"A1996"</span>, <span class="string">"B1001"</span>);</span><br><span class="line"> Â  Â  Â  Â <span class="keyword">do</span> &#123; Â  Â  </span><br><span class="line">              </span><br><span class="line">            element=submap.pollFirstEntry(); Â </span><br><span class="line">            <span class="keyword">if</span> (element!=<span class="keyword">null</span>) &#123; Â  Â  </span><br><span class="line">                contact=element.getValue(); Â  Â  Â </span><br><span class="line">                System.out.printf(<span class="string">"%s: %s\n"</span>,contact.getName(),contact. Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â getPhone()); Â  Â  Â  Â  Â  Â </span><br><span class="line">            &#125; Â  Â  Â  Â  </span><br><span class="line">        &#125; <span class="keyword">while</span> (element!=<span class="keyword">null</span>); Â  Â </span><br><span class="line">    &#125;</span><br><span class="line"> Â  Â  Â </span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Contact</span> </span>&#123; Â </span><br><span class="line">    <span class="keyword">private</span> String name; Â </span><br><span class="line">    <span class="keyword">private</span> String phone;</span><br><span class="line"> Â  Â <span class="function"><span class="keyword">public</span> <span class="title">Contact</span><span class="params">(String name, String phone)</span> </span>&#123; </span><br><span class="line">        <span class="keyword">this</span>.name = name; Â  Â  Â </span><br><span class="line">        <span class="keyword">this</span>.phone = phone;</span><br><span class="line"> Â   &#125;</span><br><span class="line"> Â  Â <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123; Â  </span><br><span class="line">        <span class="keyword">return</span> name; Â </span><br><span class="line">    &#125;</span><br><span class="line"> Â  Â <span class="function"><span class="keyword">public</span> String <span class="title">getPhone</span><span class="params">()</span> </span>&#123; Â  </span><br><span class="line">        <span class="keyword">return</span> phone; Â </span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Task0</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line"> Â  Â <span class="keyword">private</span> ConcurrentSkipListMap&lt;String, Contact&gt; map; </span><br><span class="line">    <span class="keyword">private</span> String id;</span><br><span class="line"> Â  Â <span class="function"><span class="keyword">public</span> <span class="title">Task0</span><span class="params">(ConcurrentSkipListMap&lt;String, Contact&gt; map, String id)</span> </span>&#123; Â </span><br><span class="line">        <span class="keyword">this</span>.id = id; Â  </span><br><span class="line">        <span class="keyword">this</span>.map = map;</span><br><span class="line">    &#125;</span><br><span class="line"> Â  Â <span class="meta">@Override</span> Â  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line"> Â  Â  Â  Â <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">1000</span>; i++) &#123; Â  </span><br><span class="line">            Contact contact = <span class="keyword">new</span> Contact(id, String.valueOf(i + <span class="number">1000</span>)); Â </span><br><span class="line">            map.put(id + contact.getPhone(), contact); Â  </span><br><span class="line">        &#125; Â  </span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="3-1-11-ConcurrentSkipListSet"><a href="#3-1-11-ConcurrentSkipListSet" class="headerlink" title="3.1.11 ConcurrentSkipListSet"></a>3.1.11 ConcurrentSkipListSet</h5><p><strong>ConcurrentSkipListSet</strong>ï¼Œæ˜¯JDK1.6æ—¶J.U.Cæ–°å¢çš„ä¸€ä¸ªé›†åˆå·¥å…·ç±»ï¼Œå®ƒæ˜¯ä¸€ç§æœ‰åºçš„SETç±»å‹ã€‚<br>ConcurrentSkipListSetå®ç°äº†NavigableSetæ¥å£ï¼ŒConcurrentSkipListMapå®ç°äº†NavigableMap æ¥å£ï¼Œä»¥æä¾›å’Œæ’åºç›¸å…³çš„åŠŸèƒ½ï¼Œç»´æŒå…ƒç´ çš„æœ‰åºæ€§ï¼Œæ‰€ä»¥ConcurrentSkipListSetå°±æ˜¯ä¸€ç§ä¸ºå¹¶å‘ ç¯å¢ƒè®¾è®¡çš„æœ‰åºSETå·¥å…·ç±»ã€‚<br>ConcurrentSkipListSetåº•å±‚å®ç°å¼•ç”¨äº†ConcurrentSkipListMapã€‚<br>æ —å­ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.concurrent.ConcurrentSkipListSet;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConcurrentSkipListSetTest</span> </span>&#123; Â </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123; Â  </span><br><span class="line">        ConcurrentSkipListSet&lt;Contact1&gt; set = <span class="keyword">new</span> ConcurrentSkipListSet&lt;&gt; (); Â  Â  </span><br><span class="line">        Thread threads[]=<span class="keyword">new</span> Thread[<span class="number">25</span>]; Â  Â  </span><br><span class="line">        <span class="keyword">int</span> counter=<span class="number">0</span>; Â  Â  </span><br><span class="line">        <span class="comment">//åˆ›å»ºå’Œå¯åŠ¨25ä¸ªä»»åŠ¡ï¼Œå¯¹äºæ¯ä¸ªä»»åŠ¡æŒ‡å®šä¸€ä¸ªå¤§å†™å­—æ¯ä½œä¸ºID Â  Â  </span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">char</span> i=<span class="string">'A'</span>; i&lt;<span class="string">'Z'</span>; i++) &#123; Â  Â  Â  </span><br><span class="line">            Task1 task=<span class="keyword">new</span> Task1(set, String.valueOf(i)); Â  </span><br><span class="line">            threads[counter]=<span class="keyword">new</span> Thread(task); Â  Â </span><br><span class="line">            threads[counter].start(); Â  Â  Â  </span><br><span class="line">            counter++; Â  </span><br><span class="line">        &#125; Â  Â  Â  Â </span><br><span class="line">        </span><br><span class="line">        <span class="comment">//ä½¿ç”¨join()æ–¹æ³•ç­‰å¾…çº¿ç¨‹çš„ç»“æŸ Â  Â </span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;<span class="number">25</span>; i++) &#123; Â </span><br><span class="line">            <span class="keyword">try</span> &#123; Â  Â  Â  Â  Â  Â  Â  Â </span><br><span class="line">                threads[i].join(); Â  Â  Â  </span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123; Â  Â  Â </span><br><span class="line">                e.printStackTrace(); Â  Â  Â  Â  Â  </span><br><span class="line">            &#125;    </span><br><span class="line"> 		&#125; Â  Â  Â  </span><br><span class="line">        System.out.printf(<span class="string">"Size of the set: %d\n"</span>,set.size()); Â </span><br><span class="line">        Contact1 contact; Â  Â  </span><br><span class="line">        <span class="comment">// ä½¿ç”¨firstæ–¹æ³•è·å–setçš„ç¬¬ä¸€ä¸ªå®ä½“ï¼Œå¹¶è¾“å‡ºã€‚ Â </span></span><br><span class="line">        contact=set.first(); Â  Â </span><br><span class="line">        System.out.printf(<span class="string">"First Entry: %s: %s\n"</span>,contact. Â  Â  Â  Â  Â  Â  Â  Â getName(),contact.getPhone()); </span><br><span class="line">        <span class="comment">//ä½¿ç”¨lastæ–¹æ³•è·å–setçš„æœ€åä¸€ä¸ªå®ä½“ï¼Œå¹¶è¾“å‡ºã€‚ Â  Â  Â </span></span><br><span class="line">        contact=set.last(); Â  Â  Â  Â </span><br><span class="line">        System.out.printf(<span class="string">"Last Entry: %s: %s\n"</span>,contact. Â  Â  Â  Â  Â  Â  Â  Â getName(),contact.getPhone());</span><br><span class="line"> Â   &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Contact1</span> <span class="keyword">implements</span> <span class="title">Comparable</span>&lt;<span class="title">Contact1</span>&gt; </span>&#123; Â </span><br><span class="line">    <span class="keyword">private</span> String name; Â </span><br><span class="line">    <span class="keyword">private</span> String phone;</span><br><span class="line"> Â  Â <span class="function"><span class="keyword">public</span> <span class="title">Contact1</span><span class="params">(String name, String phone)</span> </span>&#123; Â  </span><br><span class="line">        <span class="keyword">this</span>.name = name; Â  </span><br><span class="line">        <span class="keyword">this</span>.phone = phone;</span><br><span class="line"> Â   &#125;</span><br><span class="line"> Â  Â <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123; Â  Â  Â  </span><br><span class="line">        <span class="keyword">return</span> name; Â </span><br><span class="line">    &#125;</span><br><span class="line"> Â  Â <span class="function"><span class="keyword">public</span> String <span class="title">getPhone</span><span class="params">()</span> </span>&#123; Â  Â </span><br><span class="line">        <span class="keyword">return</span> phone; </span><br><span class="line">    &#125;</span><br><span class="line"> Â  Â <span class="meta">@Override</span> Â </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">compareTo</span><span class="params">(Contact1 o)</span> </span>&#123; Â  Â  Â </span><br><span class="line">        <span class="keyword">return</span> name.compareTo(o.name); Â   </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Task1</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line"> Â  Â <span class="keyword">private</span> ConcurrentSkipListSet&lt;Contact1&gt; set; Â  Â </span><br><span class="line">    <span class="keyword">private</span> String id;</span><br><span class="line"> Â  Â <span class="function"><span class="keyword">public</span> <span class="title">Task1</span><span class="params">(ConcurrentSkipListSet&lt;Contact1&gt; set, String id)</span> </span>&#123; Â </span><br><span class="line">        <span class="keyword">this</span>.id = id; Â  Â  </span><br><span class="line">        <span class="keyword">this</span>.set = set; Â  </span><br><span class="line">    &#125;</span><br><span class="line"> Â  Â <span class="meta">@Override</span> Â  Â </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        </span><br><span class="line"> Â  Â  Â  Â <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">100</span>; i++) &#123; Â  Â  Â  Â </span><br><span class="line">            Contact1 contact = <span class="keyword">new</span> Contact1(id, String.valueOf(i + <span class="number">100</span>)); Â  Â  Â  Â  Â  Â set.add(contact); Â  Â  Â </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="3-1-12-CopyOnWriteArrayList"><a href="#3-1-12-CopyOnWriteArrayList" class="headerlink" title="3.1.12 CopyOnWriteArrayList"></a>3.1.12 CopyOnWriteArrayList</h5><p><strong>Copy-On-Write</strong>ç®€ç§°COWï¼Œæ˜¯ä¸€ç§ç”¨äºç¨‹åºè®¾è®¡ä¸­çš„ä¼˜åŒ–ç­–ç•¥ã€‚</p>
<p>å…¶åŸºæœ¬æ€è·¯æ˜¯ï¼Œä»ä¸€å¼€å§‹å¤§å®¶éƒ½åœ¨å…±äº« åŒä¸€ä¸ªå†…å®¹ï¼Œå½“æŸä¸ªäººæƒ³è¦ä¿®æ”¹è¿™ä¸ªå†…å®¹çš„æ—¶å€™ï¼Œæ‰ä¼šçœŸæ­£æŠŠå†…å®¹Copyå‡ºå»å½¢æˆä¸€ä¸ªæ–°çš„å†…å®¹ç„¶åå†æ”¹ï¼Œè¿™æ˜¯ä¸€ç§å»¶æ—¶æ‡’æƒ°ç­–ç•¥ã€‚ä»JDK1.5å¼€å§‹Javaå¹¶å‘åŒ…é‡Œæä¾›äº†ä¸¤ä¸ªä½¿ç”¨CopyOnWriteæœºåˆ¶å®ç°çš„å¹¶ å‘å®¹å™¨,å®ƒä»¬æ˜¯CopyOnWriteArrayListå’ŒCopyOnWriteArraySetã€‚CopyOnWriteå®¹å™¨éå¸¸æœ‰ç”¨ï¼Œå¯ä»¥åœ¨éå¸¸å¤šçš„å¹¶å‘åœºæ™¯ä¸­ä½¿ç”¨åˆ°ã€‚</p>
<p> <strong>ä»€ä¹ˆæ˜¯CopyOnWriteå®¹å™¨</strong></p>
<p> CopyOnWriteå®¹å™¨å³å†™æ—¶å¤åˆ¶çš„å®¹å™¨ã€‚é€šä¿—çš„ç†è§£æ˜¯å½“æˆ‘ä»¬å¾€ä¸€ä¸ªå®¹å™¨æ·»åŠ å…ƒç´ çš„æ—¶å€™ï¼Œä¸ç›´æ¥å¾€å½“å‰ å®¹å™¨æ·»åŠ ï¼Œè€Œæ˜¯å…ˆå°†å½“å‰å®¹å™¨è¿›è¡ŒCopyï¼Œå¤åˆ¶å‡ºä¸€ä¸ªæ–°çš„å®¹å™¨ï¼Œç„¶åæ–°çš„å®¹å™¨é‡Œæ·»åŠ å…ƒç´ ï¼Œæ·»åŠ å®Œå…ƒç´  ä¹‹åï¼Œå†å°†åŸå®¹å™¨çš„å¼•ç”¨æŒ‡å‘æ–°çš„å®¹å™¨ã€‚è¿™æ ·åšçš„å¥½å¤„æ˜¯æˆ‘ä»¬å¯ä»¥å¯¹CopyOnWriteå®¹å™¨è¿›è¡Œå¹¶å‘çš„è¯»ï¼Œ è€Œä¸éœ€è¦åŠ é”ï¼Œå› ä¸ºå½“å‰å®¹å™¨ä¸ä¼šæ·»åŠ ä»»ä½•å…ƒç´ ã€‚æ‰€ä»¥CopyOnWriteå®¹å™¨ä¹Ÿæ˜¯ä¸€ç§è¯»å†™åˆ†ç¦»çš„æ€æƒ³ï¼Œè¯» å’Œå†™ä¸åŒçš„å®¹å™¨ã€‚ </p>
<p>CopyOnWriteå®¹å™¨æœ‰å¾ˆå¤šä¼˜ç‚¹ï¼Œä½†æ˜¯åŒæ—¶ä¹Ÿå­˜åœ¨ä¸¤ä¸ªé—®é¢˜ï¼Œå³å†…å­˜å ç”¨é—®é¢˜å’Œæ•°æ®ä¸€è‡´æ€§é—®é¢˜ã€‚æ‰€ä»¥åœ¨ å¼€å‘çš„æ—¶å€™éœ€è¦æ³¨æ„ä¸€ä¸‹å†…å­˜å ç”¨é—®é¢˜ã€‚å› ä¸ºCopyOnWriteçš„å†™æ—¶å¤åˆ¶æœºåˆ¶ï¼Œæ‰€ä»¥åœ¨è¿›è¡Œå†™æ“ä½œçš„æ—¶å€™ï¼Œå†…å­˜é‡Œä¼šåŒæ—¶é©»æ‰ä¸¤ä¸ª å¯¹è±¡çš„å†…å­˜ï¼Œæ—§çš„å¯¹è±¡å’Œæ–°å†™å…¥çš„å¯¹è±¡ï¼ˆ<code>æ³¨æ„:åœ¨å¤åˆ¶çš„æ—¶å€™åªæ˜¯å¤åˆ¶å®¹å™¨é‡Œçš„å¼•ç”¨ï¼Œåªæ˜¯åœ¨å†™çš„æ—¶å€™ ä¼šåˆ›å»ºæ–°å¯¹è±¡æ·»åŠ åˆ°æ–°å®¹å™¨é‡Œï¼Œè€Œæ—§å®¹å™¨çš„å¯¹è±¡è¿˜åœ¨ä½¿ç”¨ï¼Œæ‰€ä»¥æœ‰ä¸¤ä»½å¯¹è±¡å†…å­˜</code>ï¼‰ã€‚å¦‚æœè¿™äº›å¯¹è±¡å ç”¨ çš„å†…å­˜æ¯”è¾ƒå¤§ï¼Œæ¯”å¦‚è¯´200Må·¦å³ï¼Œé‚£ä¹ˆå†å†™å…¥100Mæ•°æ®è¿›å»ï¼Œå†…å­˜å°±ä¼šå ç”¨300Mï¼Œé‚£ä¹ˆè¿™ä¸ªæ—¶å€™å¾ˆæœ‰ å¯èƒ½é€ æˆé¢‘ç¹çš„Yong GCå’ŒFull GCã€‚ä¹‹å‰æˆ‘ä»¬ç³»ç»Ÿä¸­ä½¿ç”¨äº†ä¸€ä¸ªæœåŠ¡ç”±äºæ¯æ™šä½¿ç”¨CopyOnWriteæœºåˆ¶ æ›´æ–°å¤§å¯¹è±¡ï¼Œé€ æˆäº†æ¯æ™š15ç§’çš„Full GCï¼Œåº”ç”¨å“åº”æ—¶é—´ä¹Ÿéšä¹‹å˜é•¿ã€‚</p>
<p> é’ˆå¯¹å†…å­˜å ç”¨é—®é¢˜ï¼Œå¯ä»¥é€šè¿‡å‹ç¼©å®¹å™¨ä¸­çš„å…ƒç´ çš„æ–¹æ³•æ¥å‡å°‘å¤§å¯¹è±¡çš„å†…å­˜æ¶ˆè€—ï¼Œæ¯”å¦‚ï¼Œå¦‚æœå…ƒç´ å…¨æ˜¯ 10è¿›åˆ¶çš„æ•°å­—ï¼Œå¯ä»¥è€ƒè™‘æŠŠå®ƒå‹ç¼©æˆ36è¿›åˆ¶æˆ–64è¿›åˆ¶ã€‚æˆ–è€…ä¸ä½¿ç”¨CopyOnWriteå®¹å™¨ï¼Œè€Œä½¿ç”¨å…¶ä»–çš„å¹¶å‘å®¹å™¨ï¼Œå¦‚ConcurrentHashMapã€‚ æ•°æ®ä¸€è‡´æ€§é—®é¢˜ã€‚CopyOnWriteå®¹å™¨åªèƒ½ä¿è¯æ•°æ®çš„ç»ˆä¸€è‡´æ€§ï¼Œä¸èƒ½ä¿è¯æ•°æ®çš„å®æ—¶ä¸€è‡´æ€§ã€‚æ‰€ä»¥å¦‚ æœä½ å¸Œæœ›å†™å…¥çš„çš„æ•°æ®ï¼Œé©¬ä¸Šèƒ½è¯»åˆ°ï¼Œè¯·ä¸è¦ä½¿ç”¨CopyOnWriteå®¹å™¨ã€‚</p>
<p>ä½¿ç”¨ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.Arrays;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.CopyOnWriteArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ExecutorService;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.Executors; </span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ReadThread</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123; Â </span><br><span class="line">    <span class="keyword">private</span> List&lt;Integer&gt; list;</span><br><span class="line"> Â  Â <span class="function"><span class="keyword">public</span> <span class="title">ReadThread</span><span class="params">(List&lt;Integer&gt; list)</span> </span>&#123; Â  Â </span><br><span class="line">        <span class="keyword">this</span>.list = list; Â  </span><br><span class="line">    &#125;</span><br><span class="line"> Â  Â <span class="meta">@Override</span> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123; </span><br><span class="line">        System.out.print(<span class="string">"size:="</span>+list.size()+<span class="string">",::"</span>); Â </span><br><span class="line">        <span class="keyword">for</span> (Integer ele : list) &#123;</span><br><span class="line">            System.out.print(ele + <span class="string">","</span>); Â  </span><br><span class="line">        &#125; Â  Â  Â  </span><br><span class="line">        System.out.println(); Â </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">WriteThread</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123; Â </span><br><span class="line">    <span class="keyword">private</span> List&lt;Integer&gt; list;</span><br><span class="line"> Â  Â <span class="function"><span class="keyword">public</span> <span class="title">WriteThread</span><span class="params">(List&lt;Integer&gt; list)</span> </span>&#123; Â  Â </span><br><span class="line">        <span class="keyword">this</span>.list = list; </span><br><span class="line">    &#125;</span><br><span class="line"> Â  Â <span class="meta">@Override</span> Â  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123; Â  Â </span><br><span class="line">        <span class="keyword">this</span>.list.add(<span class="number">9</span>); Â  </span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestCopyOnWriteArrayListTest</span> </span>&#123;</span><br><span class="line"> Â  Â <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">test</span><span class="params">()</span> </span>&#123; Â </span><br><span class="line">        <span class="comment">//1ã€åˆå§‹åŒ–CopyOnWriteArrayList Â  </span></span><br><span class="line">        List&lt;Integer&gt; tempList = Arrays.asList(<span class="keyword">new</span> Integer [] &#123;<span class="number">1</span>,<span class="number">2</span>&#125;); </span><br><span class="line">        CopyOnWriteArrayList&lt;Integer&gt; copyList = <span class="keyword">new</span> CopyOnWriteArrayList&lt;&gt; (tempList);</span><br><span class="line">        </span><br><span class="line"> Â  Â  Â  Â <span class="comment">//2ã€æ¨¡æ‹Ÿå¤šçº¿ç¨‹å¯¹listè¿›è¡Œè¯»å’Œå†™ Â  Â </span></span><br><span class="line">        ExecutorService executorService = Executors.newFixedThreadPool(<span class="number">10</span>); </span><br><span class="line">        executorService.execute(<span class="keyword">new</span> ReadThread(copyList)); Â  Â  </span><br><span class="line">        executorService.execute(<span class="keyword">new</span> WriteThread(copyList)); </span><br><span class="line">        executorService.execute(<span class="keyword">new</span> WriteThread(copyList)); Â </span><br><span class="line">        executorService.execute(<span class="keyword">new</span> WriteThread(copyList)); Â  </span><br><span class="line">        executorService.execute(<span class="keyword">new</span> ReadThread(copyList)); Â  Â </span><br><span class="line">        executorService.execute(<span class="keyword">new</span> WriteThread(copyList)); Â  Â </span><br><span class="line">        executorService.execute(<span class="keyword">new</span> ReadThread(copyList)); Â </span><br><span class="line">        executorService.execute(<span class="keyword">new</span> WriteThread(copyList)); Â </span><br><span class="line">        <span class="keyword">try</span> &#123; Â  Â  Â  Â  Â  </span><br><span class="line">            TimeUnit.SECONDS.sleep(<span class="number">5</span>); </span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123; Â  </span><br><span class="line">            <span class="comment">// TODO Auto-generated catch block Â </span></span><br><span class="line">            e.printStackTrace(); Â </span><br><span class="line">        &#125; Â  Â  Â  Â </span><br><span class="line">        System.out.println(<span class="string">"copyList size:"</span>+copyList.size());</span><br><span class="line">    &#125;</span><br><span class="line"> Â  Â <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123; </span><br><span class="line">        <span class="keyword">new</span> TestCopyOnWriteArrayList().test(); Â  </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="3-1-13-CopyOnWriteArraySet"><a href="#3-1-13-CopyOnWriteArraySet" class="headerlink" title="3.1.13 CopyOnWriteArraySet"></a>3.1.13 CopyOnWriteArraySet</h5><p>CopyOnWriteArraySetç›¸å¯¹CopyOnWriteArrayListç”¨æ¥å­˜å‚¨ä¸é‡å¤çš„å¯¹è±¡ï¼Œæ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚è™½ç„¶ç»§æ‰¿äº†AbstractSetç±»ï¼Œä½†CopyOnWriteArraySetä¸HashMap å®Œå…¨ä¸åŒï¼Œå†…éƒ¨æ˜¯ç”¨ CopyOnWriteArrayListå®ç°çš„ï¼Œå®ç°ä¸é‡å¤çš„ç‰¹æ€§ä¹Ÿæ˜¯ç›´æ¥è°ƒç”¨CopyOnWriteArrayListçš„æ–¹æ³•å®ç° çš„ï¼Œæ„Ÿè§‰åŠ çš„æœ‰ç”¨çš„å‡½æ•°å°±æ˜¯eqå‡½æ•°åˆ¤æ–­å¯¹è±¡æ˜¯å¦ç›¸åŒ</p>
<h4 id="3-2-åŸå­æ“ä½œç±»"><a href="#3-2-åŸå­æ“ä½œç±»" class="headerlink" title="3.2 åŸå­æ“ä½œç±»"></a>3.2 åŸå­æ“ä½œç±»</h4><p>åœ¨å¹¶å‘ç¼–ç¨‹ä¸­å¾ˆå®¹æ˜“å‡ºç°å¹¶å‘å®‰å…¨çš„é—®é¢˜ï¼Œæœ‰ä¸€ä¸ªå¾ˆç®€å•çš„ä¾‹å­å°±æ˜¯å¤šçº¿ç¨‹æ›´æ–°å˜é‡i=1,æ¯”å¦‚å¤šä¸ªçº¿ç¨‹ æ‰§è¡Œi++æ“ä½œï¼Œå°±æœ‰å¯èƒ½è·å–ä¸åˆ°æ­£ç¡®çš„å€¼ï¼Œè€Œè¿™ä¸ªé—®é¢˜ï¼Œå¸¸ç”¨çš„æ–¹æ³•æ˜¯é€šè¿‡Synchronizedè¿›è¡Œæ§åˆ¶ æ¥è¾¾åˆ°çº¿ç¨‹å®‰å…¨çš„ç›®çš„ã€‚ä½†æ˜¯ç”±äºsynchronizedæ˜¯é‡‡ç”¨çš„æ˜¯æ‚²è§‚é”ç­–ç•¥ï¼Œå¹¶ä¸æ˜¯ç‰¹åˆ«é«˜æ•ˆçš„ä¸€ç§è§£å†³æ–¹æ¡ˆã€‚å®é™…ä¸Šï¼Œåœ¨J.U.Cä¸‹çš„atomicåŒ…æä¾›äº†ä¸€ç³»åˆ—çš„æ“ä½œç®€å•ï¼Œæ€§èƒ½é«˜æ•ˆï¼Œå¹¶èƒ½ä¿è¯çº¿ç¨‹å®‰å…¨çš„ç±»å» æ›´æ–°åŸºæœ¬ç±»å‹å˜é‡ï¼Œæ•°ç»„å…ƒç´ ï¼Œå¼•ç”¨ç±»å‹ä»¥åŠæ›´æ–°å¯¹è±¡ä¸­çš„å­—æ®µç±»å‹ã€‚atomicåŒ…ä¸‹çš„è¿™äº›ç±»éƒ½æ˜¯é‡‡ç”¨çš„ æ˜¯ä¹è§‚é”ç­–ç•¥å»åŸå­æ›´æ–°æ•°æ®ï¼Œåœ¨javaä¸­åˆ™æ˜¯ä½¿ç”¨CASæ“ä½œå…·ä½“å®ç°ã€‚</p>
<h5 id="3-2-1-åŸå­åŸºæœ¬æ•°æ®ç±»å‹"><a href="#3-2-1-åŸå­åŸºæœ¬æ•°æ®ç±»å‹" class="headerlink" title="3.2.1 åŸå­åŸºæœ¬æ•°æ®ç±»å‹"></a>3.2.1 åŸå­åŸºæœ¬æ•°æ®ç±»å‹</h5><p>åŸå­æ›´æ–°åŸºæœ¬ç±»å‹<br>atomicåŒ…æé«˜åŸå­æ›´æ–°åŸºæœ¬ç±»å‹çš„å·¥å…·ç±»ï¼Œä¸»è¦æœ‰è¿™äº›ï¼š</p>
<ul>
<li>AtomicBooleanï¼šä»¥åŸå­æ›´æ–°çš„æ–¹å¼æ›´æ–°booleanï¼›</li>
<li>AtomicIntegerï¼šä»¥åŸå­æ›´æ–°çš„æ–¹å¼æ›´æ–°Integer; </li>
<li>AtomicLongï¼šä»¥åŸå­æ›´æ–°çš„æ–¹å¼æ›´æ–°Longï¼›</li>
<li>AtomicIntegerå¸¸ç”¨çš„æ–¹æ³•:</li>
<li>addAndGet(int delta) ï¼šä»¥åŸå­æ–¹å¼å°†è¾“å…¥çš„æ•°å€¼ä¸å®ä¾‹ä¸­åŸæœ¬çš„å€¼ç›¸åŠ ï¼Œå¹¶è¿”å›åçš„ç»“ æœï¼› </li>
<li>incrementAndGet() ï¼šä»¥åŸå­çš„æ–¹å¼å°†å®ä¾‹ä¸­çš„åŸå€¼è¿›è¡ŒåŠ 1æ“ä½œï¼Œå¹¶è¿”å›ç»ˆç›¸åŠ åçš„ç»“æœï¼› </li>
<li>getAndSet(int newValue)ï¼šå°†å®ä¾‹ä¸­çš„å€¼æ›´æ–°ä¸ºæ–°å€¼ï¼Œå¹¶è¿”å›æ—§å€¼ï¼› </li>
<li>getAndIncrement()ï¼šä»¥åŸå­çš„æ–¹å¼å°†å®ä¾‹ä¸­çš„åŸå€¼åŠ 1ï¼Œè¿”å›çš„æ˜¯è‡ªå¢å‰çš„æ—§å€¼ï¼›</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">getAndIncrement</span><span class="params">()</span> </span>&#123; Â  </span><br><span class="line">    <span class="keyword">return</span> unsafe.getAndAddInt(<span class="keyword">this</span>, valueOffset, <span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹å‡ºï¼Œè¯¥æ–¹æ³•å®é™…ä¸Šæ˜¯è°ƒç”¨äº†unsafeå®ä¾‹çš„getAndAddIntæ–¹æ³•ï¼Œunsafeå®ä¾‹çš„è·å–æ—¶é€šè¿‡ UnSafeç±»çš„é™æ€æ–¹æ³•getUnsafeè·å–ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Unsafe unsafe = Unsafe.getUnsafe();</span><br></pre></td></tr></table></figure>

<p>Unsafeç±»åœ¨sun.miscåŒ…ä¸‹ï¼ŒUnsaferç±»æä¾›äº†ä¸€äº›åº•å±‚æ“ä½œï¼ŒatomicåŒ…ä¸‹çš„åŸå­æ“ä½œç±»çš„ä¹Ÿä¸»è¦æ˜¯é€š è¿‡Unsafeç±»æä¾›çš„compareAndSwapIntï¼ŒcompareAndSwapLongç­‰ä¸€ç³»åˆ—æä¾›CASæ“ä½œçš„æ–¹æ³•æ¥è¿›è¡Œå®ç°ã€‚</p>
<p>atomicIntegerå€ŸåŠ©äº†UnSafeæä¾›çš„CASæ“ä½œèƒ½å¤Ÿä¿è¯æ•°æ®æ›´æ–°çš„æ—¶å€™æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œå¹¶ä¸”ç”±äºCASæ˜¯ é‡‡ç”¨ä¹è§‚é”ç­–ç•¥ï¼Œå› æ­¤ï¼Œè¿™ç§æ•°æ®æ›´æ–°çš„æ–¹æ³•ä¹Ÿå…·æœ‰é«˜æ•ˆæ€§ã€‚</p>
<p>AtomicLongçš„å®ç°åŸç†å’ŒAtomicIntegerä¸€è‡´ï¼Œåªä¸è¿‡ä¸€ä¸ªé’ˆå¯¹çš„æ˜¯longå˜é‡ï¼Œä¸€ä¸ªé’ˆå¯¹çš„æ˜¯intå˜ é‡ã€‚è€Œbooleanå˜é‡çš„æ›´æ–°ç±»AtomicBooleanç±»æ˜¯æ€æ ·å®ç°æ›´æ–°çš„å‘¢?æ ¸å¿ƒæ–¹æ³•æ˜¯ compareAndSet tæ–¹ æ³•ï¼Œ</p>
<p>å…¶æºç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">compareAndSet</span><span class="params">(<span class="keyword">boolean</span> expect, <span class="keyword">boolean</span> update)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> e = expect ? <span class="number">1</span> : <span class="number">0</span>; </span><br><span class="line">    <span class="keyword">int</span> u = update ? <span class="number">1</span> : <span class="number">0</span>; Â  </span><br><span class="line">    <span class="keyword">return</span> unsafe.compareAndSwapInt(<span class="keyword">this</span>, valueOffset, e, u);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹å‡ºï¼ŒcompareAndSetæ–¹æ³•çš„å®é™…ä¸Šä¹Ÿæ˜¯å…ˆè½¬æ¢æˆ0,1çš„æ•´å‹å˜é‡ï¼Œç„¶åæ˜¯é€šè¿‡é’ˆå¯¹intå‹å˜é‡çš„ åŸå­æ›´æ–°æ–¹æ³•compareAndSwapIntæ¥å®ç°çš„ã€‚å¯ä»¥çœ‹å‡ºatomicåŒ…ä¸­åªæä¾›äº†å¯¹boolean,int ,longè¿™ ä¸‰ç§åŸºæœ¬ç±»å‹çš„åŸå­æ›´æ–°çš„æ–¹æ³•ï¼Œå‚è€ƒå¯¹booleanæ›´æ–°çš„æ–¹å¼ï¼ŒåŸå­æ›´æ–°char,double,floatä¹Ÿå¯ä»¥é‡‡ ç”¨ç±»ä¼¼çš„æ€è·¯è¿›è¡Œå®ç°ã€‚<br>ä½¿ç”¨ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Main</span> </span>&#123; Â  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123; Â  </span><br><span class="line">        AtomicInteger ai = <span class="keyword">new</span> AtomicInteger();</span><br><span class="line"> Â  Â  Â  Â List&lt;Thread&gt; list = <span class="keyword">new</span> ArrayList&lt;&gt;(); Â  </span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123; Â  Â  Â </span><br><span class="line">            Thread t = <span class="keyword">new</span> Thread(<span class="keyword">new</span> Accumlator(ai), <span class="string">"thread-"</span> + i); Â  Â  </span><br><span class="line">            list.add(t); Â  Â  Â  </span><br><span class="line">            t.start(); Â  Â </span><br><span class="line">        &#125;</span><br><span class="line"> Â  Â  Â  Â <span class="keyword">for</span> (Thread t : list) &#123; Â  Â </span><br><span class="line">            t.join(); Â  Â  </span><br><span class="line">        &#125;</span><br><span class="line"> Â  Â  Â  Â System.out.println(ai.get());</span><br><span class="line">    &#125;</span><br><span class="line"> Â  Â <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Accumlator</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123; Â  Â  </span><br><span class="line">        <span class="keyword">private</span> AtomicInteger ai;</span><br><span class="line"> Â  Â  Â  Â Accumlator(AtomicInteger ai) &#123; Â  Â  Â </span><br><span class="line">            <span class="keyword">this</span>.ai = ai; Â  Â </span><br><span class="line">        &#125;</span><br><span class="line"> Â  Â  Â  Â <span class="meta">@Override</span> Â  Â  </span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123; Â  Â  </span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>, len = <span class="number">1000</span>; i &lt; len; i++) &#123; Â  </span><br><span class="line">                ai.incrementAndGet(); Â  Â  Â </span><br><span class="line">            &#125; Â  Â  Â </span><br><span class="line">        &#125; Â  </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="3-2-2-åŸå­æ•°ç»„"><a href="#3-2-2-åŸå­æ•°ç»„" class="headerlink" title="3.2.2 åŸå­æ•°ç»„"></a>3.2.2 åŸå­æ•°ç»„</h5><p>atomicåŒ…ä¸‹æä¾›èƒ½åŸå­æ›´æ–°æ•°ç»„ä¸­å…ƒç´ çš„ç±»æœ‰ï¼š</p>
<ul>
<li>AtomicIntegerArrayï¼šåŸå­æ›´æ–°æ•´å‹æ•°ç»„ä¸­çš„å…ƒç´ ï¼›</li>
<li>AtomicLongArrayï¼šåŸå­æ›´æ–°é•¿æ•´å‹æ•°ç»„ä¸­çš„å…ƒç´ ï¼› </li>
<li>AtomicReferenceArrayï¼šåŸå­æ›´æ–°å¼•ç”¨ç±»å‹æ•°ç»„ä¸­çš„å…ƒç´ </li>
</ul>
<p>è¿™å‡ ä¸ªç±»çš„ç”¨æ³•ä¸€è‡´ï¼Œå°±ä»¥AtomicIntegerArrayæ¥æ€»ç»“ä¸‹å¸¸ç”¨çš„æ–¹æ³•ï¼š</p>
<ul>
<li>addAndGet(int i, int delta)ï¼šä»¥åŸå­æ›´æ–°çš„æ–¹å¼å°†æ•°ç»„ä¸­ç´¢å¼•ä¸ºiçš„å…ƒç´ ä¸è¾“å…¥å€¼ç›¸åŠ ï¼›</li>
<li>getAndIncrement(int i)ï¼šä»¥åŸå­æ›´æ–°çš„æ–¹å¼å°†æ•°ç»„ä¸­ç´¢å¼•ä¸ºiçš„å…ƒç´ è‡ªå¢åŠ 1ï¼› </li>
<li>compareAndSet(int i, int expect, int update)ï¼šå°†æ•°ç»„ä¸­ç´¢å¼•ä¸ºiçš„ä½ç½®çš„å…ƒç´ è¿›è¡Œæ›´æ–°</li>
</ul>
<p>å¯ä»¥çœ‹å‡ºï¼ŒAtomicIntegerArrayä¸AtomicIntegerçš„æ–¹æ³•åŸºæœ¬ä¸€è‡´ï¼Œåªä¸è¿‡åœ¨AtomicIntegerArray çš„æ–¹æ³•ä¸­ä¼šå¤šä¸€ä¸ªæŒ‡å®šæ•°ç»„ç´¢å¼•ä½iã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.concurrent.atomic.AtomicIntegerArray;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AtomicIntegerArrayTest</span> </span>&#123;</span><br><span class="line"> Â  Â <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123; Â  </span><br><span class="line">        <span class="comment">//åˆ›å»ºç»™å®šé•¿åº¦çš„AtomicIntegerArrayã€‚ Â </span></span><br><span class="line">        AtomicIntegerArray atomicIntegerArray = <span class="keyword">new</span> AtomicIntegerArray(<span class="number">10</span>); Â  </span><br><span class="line">        <span class="comment">//å°†ä½ç½® i çš„å…ƒç´ è®¾ç½®ä¸ºç»™å®šå€¼,é»˜è®¤å€¼ä¸º0 Â  Â  </span></span><br><span class="line">        atomicIntegerArray.set(<span class="number">9</span>,<span class="number">10</span>); Â  </span><br><span class="line">        System.out.println(<span class="string">"Value: "</span> + atomicIntegerArray.get(<span class="number">9</span>) + <span class="string">"é»˜è®¤å€¼ï¼š"</span> + atomicIntegerArray.get(<span class="number">0</span>)); Â  Â  Â </span><br><span class="line">        <span class="comment">//è¿”å›è¯¥æ•°ç»„çš„é•¿åº¦ Â  Â  </span></span><br><span class="line">        System.out.println(<span class="string">"æ•°ç»„é•¿åº¦ï¼š"</span> + atomicIntegerArray.length()); Â </span><br><span class="line">        <span class="comment">//ä»¥åŸå­æ–¹å¼å…ˆå¯¹ç»™å®šä¸‹æ ‡åŠ ä¸Šç‰¹å®šçš„å€¼ï¼Œå†è·å–ç›¸åŠ åçš„å€¼ Â  Â  Â </span></span><br><span class="line">        atomicIntegerArray.set(<span class="number">0</span>,<span class="number">10</span>); Â  Â </span><br><span class="line">        System.out.println(<span class="string">"Value: "</span> + atomicIntegerArray.get(<span class="number">0</span>)); Â </span><br><span class="line">        System.out.println(<span class="string">"Value: "</span> + Â atomicIntegerArray.addAndGet(<span class="number">5</span>,<span class="number">10</span>)); Â </span><br><span class="line">        <span class="comment">//å¦‚æœå½“å‰å€¼ == é¢„æœŸå€¼ï¼Œå°†ä½ç½® i çš„å…ƒç´ è®¾ç½®ä¸ºç»™å®šçš„æ›´æ–°å€¼ã€‚ Â  Â </span></span><br><span class="line">        Boolean bool = atomicIntegerArray.compareAndSet(<span class="number">5</span>,<span class="number">10</span>,<span class="number">30</span>); Â  Â </span><br><span class="line">        System.out.println(<span class="string">"ç»“æœå€¼ï¼š "</span> + atomicIntegerArray.get(<span class="number">5</span>) + <span class="string">" Result: "</span> + bool);</span><br><span class="line">        <span class="comment">//ä»¥åŸå­æ–¹å¼å…ˆå°†å½“å‰ä¸‹æ ‡çš„å€¼å‡1ï¼Œå†è·å–å‡1åçš„ç»“æœ Â  Â </span></span><br><span class="line">        System.out.println(<span class="string">"ä¸‹æ ‡ä¸º5çš„å€¼ä¸ºï¼š"</span> + Â atomicIntegerArray.decrementAndGet(<span class="number">5</span>)); </span><br><span class="line">        System.out.println(<span class="string">"ä¸‹æ ‡ä¸º5çš„å€¼ä¸ºï¼š"</span> + atomicIntegerArray.get(<span class="number">5</span>)); Â  Â  </span><br><span class="line">        <span class="comment">//ä»¥åŸå­æ–¹å¼å…ˆè·å–å½“å‰ä¸‹æ ‡çš„å€¼ï¼Œå†å°†å½“å‰ä¸‹æ ‡çš„å€¼åŠ ä¸Šç»™å®šçš„å€¼ Â  Â </span></span><br><span class="line">        Integer result2 = atomicIntegerArray.getAndAdd(<span class="number">5</span>,<span class="number">5</span>); Â  Â </span><br><span class="line">        System.out.println(<span class="string">"ä¸‹æ ‡ä¸º5çš„å€¼ä¸ºï¼š"</span> + result2); Â  </span><br><span class="line">        System.out.println(<span class="string">"ä¸‹æ ‡ä¸º5çš„å€¼ä¸ºï¼š"</span> + atomicIntegerArray.get(<span class="number">5</span>));</span><br><span class="line">        <span class="comment">//ä»¥åŸå­æ–¹å¼å…ˆè·å–å½“å‰ä¸‹æ ‡çš„å€¼ï¼Œå†å¯¹å½“å‰ä¸‹æ ‡çš„å€¼å‡1 Â  </span></span><br><span class="line">        System.out.println(<span class="string">"ä¸‹æ ‡ä¸º1çš„å€¼ä¸ºï¼š"</span> + atomicIntegerArray.getAndDecrement(<span class="number">1</span>));</span><br><span class="line">        System.out.println(<span class="string">"ä¸‹æ ‡ä¸º1çš„å€¼ä¸ºï¼š"</span> + atomicIntegerArray.get(<span class="number">1</span>)); Â  Â </span><br><span class="line">        <span class="comment">// ä»¥åŸå­æ–¹å¼å…ˆè·å–å½“å‰ä¸‹æ ‡çš„å€¼ï¼Œå†å¯¹å½“å‰ä¸‹æ ‡çš„å€¼åŠ 1 Â  </span></span><br><span class="line">        System.out.println(<span class="string">"ä¸‹æ ‡ä¸º2çš„å€¼ä¸ºï¼š"</span> + atomicIntegerArray.getAndIncrement(<span class="number">2</span>));</span><br><span class="line">        System.out.println(<span class="string">"ä¸‹æ ‡ä¸º2çš„å€¼ä¸ºï¼š"</span> + atomicIntegerArray.get(<span class="number">2</span>)); Â  Â  </span><br><span class="line">        <span class="comment">//å°†ä½ç½® i çš„å…ƒç´ ä»¥åŸå­æ–¹å¼è®¾ç½®ä¸ºç»™å®šå€¼ï¼Œå¹¶è¿”å›æ—§å€¼ã€‚</span></span><br><span class="line">        System.out.println(<span class="string">"ä¸‹æ ‡ä¸º3çš„å€¼ä¸ºï¼š"</span> + atomicIntegerArray.getAndSet(<span class="number">3</span>,<span class="number">50</span>)); Â </span><br><span class="line">        System.out.println(<span class="string">"ä¸‹æ ‡ä¸º3çš„å€¼ä¸ºï¼š"</span> + atomicIntegerArray.get(<span class="number">3</span>)); Â </span><br><span class="line">        <span class="comment">//ä»¥åŸå­æ–¹å¼å…ˆå¯¹ä¸‹æ ‡åŠ 1å†è·å–å€¼ Â  Â  </span></span><br><span class="line">        System.out.println(<span class="string">"ä¸‹æ ‡ä¸º4çš„å€¼ä¸ºï¼š"</span> + atomicIntegerArray.incrementAndGet(<span class="number">4</span>)); Â </span><br><span class="line">        System.out.println(<span class="string">"ä¸‹æ ‡ä¸º4çš„å€¼ä¸ºï¼š"</span> + atomicIntegerArray.get(<span class="number">4</span>));</span><br><span class="line"> Â   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¹¶å‘æµ‹è¯•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.concurrent.atomic.AtomicIntegerArray;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AtomicIntegerArrayTest2</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line"> Â  Â <span class="keyword">static</span> AtomicIntegerArray arr = <span class="keyword">new</span> AtomicIntegerArray(<span class="number">10</span>); </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">AddThread</span> <span class="keyword">implements</span> <span class="title">Runnable</span></span>&#123; Â </span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span> <span class="params">()</span> </span>&#123; Â  Â  Â  Â </span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> k = <span class="number">0</span>; k &lt; <span class="number">10</span>; k++) Â  Â  </span><br><span class="line">                arr.getAndIncrement(k % arr.length()); </span><br><span class="line">        &#125; Â  </span><br><span class="line">    &#125;</span><br><span class="line"> Â  Â <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123; Â </span><br><span class="line">        Thread[] ts = <span class="keyword">new</span> Thread[<span class="number">10</span>]; Â  Â  Â </span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> k = <span class="number">0</span>; k &lt; <span class="number">10</span>; k++) &#123; Â  Â  Â  Â </span><br><span class="line">            ts[k] = <span class="keyword">new</span> Thread(<span class="keyword">new</span> AddThread()); </span><br><span class="line">        &#125; Â  Â  Â </span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> k = <span class="number">0</span>; k &lt; <span class="number">10</span>; k++) &#123; Â  Â </span><br><span class="line">            ts[k].start(); Â  Â  Â </span><br><span class="line">        &#125; Â  Â  Â </span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> k = <span class="number">0</span>; k &lt; <span class="number">10</span>; k++) &#123; Â  Â  Â  </span><br><span class="line">            ts[k].join(); Â  Â  </span><br><span class="line">        &#125; Â  Â  </span><br><span class="line">        System.out.println(arr); Â </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="3-2-3-åŸå­å¼•ç”¨ç±»å‹"><a href="#3-2-3-åŸå­å¼•ç”¨ç±»å‹" class="headerlink" title="3.2.3 åŸå­å¼•ç”¨ç±»å‹"></a>3.2.3 åŸå­å¼•ç”¨ç±»å‹</h5><p>å¦‚æœéœ€è¦åŸå­æ›´æ–°å¼•ç”¨ç±»å‹å˜é‡çš„è¯ï¼Œä¸ºäº†ä¿è¯çº¿ç¨‹å®‰å…¨ï¼Œatomicä¹Ÿæä¾›äº†ç›¸å…³çš„ç±»ï¼š</p>
<ul>
<li><p>AtomicReference </p>
</li>
<li><p>AtomicStampedReference </p>
</li>
<li><p>AtomicMarkableReference</p>
</li>
</ul>
<p>AtomicReferenceçš„å¼•å…¥æ˜¯ä¸ºäº†å¯ä»¥ç”¨ä¸€ç§ç±»ä¼¼ä¹è§‚é”çš„æ–¹å¼æ“ä½œå…±äº«èµ„æºï¼Œåœ¨æŸäº›æƒ…æ™¯ä¸‹ä»¥æå‡æ€§èƒ½ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AtomicReferenceTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123; Â  Â  Â  </span><br><span class="line">        AtomicReference&lt;Integer&gt; ref = <span class="keyword">new</span> AtomicReference&lt;&gt;(<span class="keyword">new</span> Integer(<span class="number">1000</span>));</span><br><span class="line">        </span><br><span class="line"> Â  Â  Â  Â List&lt;Thread&gt; list = <span class="keyword">new</span> ArrayList&lt;&gt;(); Â  Â </span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">1000</span>; i++) &#123; Â  Â  Â </span><br><span class="line">            Thread t = <span class="keyword">new</span> Thread(<span class="keyword">new</span> Task(ref), <span class="string">"Thread-"</span> + i); Â  Â  </span><br><span class="line">            list.add(t); Â  Â  Â  Â </span><br><span class="line">            t.start();</span><br><span class="line">            </span><br><span class="line"> &#125;</span><br><span class="line"> Â  Â  Â  Â <span class="keyword">for</span> (Thread t : list) &#123; Â  </span><br><span class="line">            t.join(); Â  Â  </span><br><span class="line">        &#125;</span><br><span class="line"> Â  Â  Â  Â System.out.println(ref.get()); Â  </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Task</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123; Â  </span><br><span class="line">    <span class="keyword">private</span> AtomicReference&lt;Integer&gt; ref;</span><br><span class="line"> Â  Â Task(AtomicReference&lt;Integer&gt; ref) &#123; Â </span><br><span class="line">        <span class="keyword">this</span>.ref = ref; </span><br><span class="line">    &#125; Â  Â  </span><br><span class="line">    <span class="meta">@Override</span> Â  Â </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123; Â  Â </span><br><span class="line">        <span class="keyword">for</span> (; ; ) &#123; Â </span><br><span class="line">            <span class="comment">//è‡ªæ—‹æ“ä½œ Â  Â  Â  </span></span><br><span class="line">            Integer oldV = ref.get(); Â  </span><br><span class="line">            <span class="keyword">if</span> (ref.compareAndSet(oldV, oldV + <span class="number">1</span>)) </span><br><span class="line">                <span class="comment">// CASæ“ä½œ  Â  Â  Â  Â  Â  </span></span><br><span class="line">                <span class="keyword">break</span>; Â  Â  Â </span><br><span class="line">        &#125; Â </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¯¥æ¡ˆä¾‹å¹¶æ²¡æœ‰ä½¿ç”¨é”ï¼Œæ˜¯ä½¿ç”¨è‡ªæ—‹+CASçš„æ— é”æ“ä½œä¿è¯å…±äº«å˜é‡çš„çº¿ç¨‹å®‰å…¨ã€‚<br>CASæ“ä½œå¯èƒ½å­˜åœ¨ABAçš„é—®é¢˜ï¼š å‡å¦‚ä¸€ä¸ªå€¼åŸæ¥æ˜¯Aï¼Œå˜æˆäº†Bï¼Œåˆå˜æˆäº†Aï¼Œé‚£ä¹ˆCASæ£€æŸ¥æ—¶ä¼šå‘ç°å®ƒçš„å€¼æ²¡æœ‰å‘ç”Ÿå˜åŒ–ï¼Œä½†æ˜¯å®é™…ä¸Šå´ å˜åŒ–äº†ã€‚<br>ä¸€èˆ¬æ¥è®²è¿™å¹¶ä¸æ˜¯ä»€ä¹ˆé—®é¢˜ï¼Œæ¯”å¦‚æ•°å€¼è¿ç®—ï¼Œçº¿ç¨‹å…¶å®æ ¹æœ¬ä¸å…³å¿ƒå˜é‡ä¸­é€”å¦‚ä½•å˜åŒ–ï¼Œåªè¦ç»ˆçš„çŠ¶æ€ å’Œé¢„æœŸå€¼ä¸€æ ·å³å¯ã€‚<br>ä½†æ˜¯ï¼Œæœ‰äº›æ“ä½œä¼šä¾èµ–äºå¯¹è±¡çš„å˜åŒ–è¿‡ç¨‹ï¼Œæ­¤æ—¶çš„è§£å†³æ€è·¯ä¸€èˆ¬å°±æ˜¯ä½¿ç”¨ç‰ˆæœ¬å·ã€‚åœ¨å˜é‡å‰é¢è¿½åŠ ä¸Šç‰ˆ æœ¬å·ï¼Œæ¯æ¬¡å˜é‡æ›´æ–°çš„æ—¶å€™æŠŠç‰ˆæœ¬å·åŠ ä¸€ï¼Œé‚£ä¹ˆAï¼Bï¼A å°±ä¼šå˜æˆ1A - 2B - 3Aã€‚<br>AtomicStampedReferenceå°±æ˜¯ä¸Šé¢æ‰€è¯´çš„åŠ äº†ç‰ˆæœ¬å·çš„AtomicReferenceã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Pair</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">     <span class="keyword">final</span> T reference; Â  Â  </span><br><span class="line">     <span class="keyword">final</span> <span class="keyword">int</span> stamp; Â  Â </span><br><span class="line">     <span class="function"><span class="keyword">private</span> <span class="title">Pair</span><span class="params">(T reference, <span class="keyword">int</span> stamp)</span> </span>&#123; Â  </span><br><span class="line">         <span class="keyword">this</span>.reference = reference; Â  </span><br><span class="line">         <span class="keyword">this</span>.stamp = stamp; Â  Â </span><br><span class="line">     &#125; Â  Â  Â </span><br><span class="line">     <span class="keyword">static</span> &lt;T&gt; <span class="function">Pair&lt;T&gt; <span class="title">of</span><span class="params">(T reference, <span class="keyword">int</span> stamp)</span> </span>&#123; Â  Â  </span><br><span class="line">         <span class="keyword">return</span> <span class="keyword">new</span> Pair&lt;T&gt;(reference, stamp); Â  Â  </span><br><span class="line">     &#125; Â  </span><br><span class="line"> &#125;</span><br><span class="line"> Â  Â <span class="keyword">private</span> <span class="keyword">volatile</span> Pair&lt;V&gt; pair;</span><br><span class="line"> Â  Â <span class="comment">/** Â  Â  </span></span><br><span class="line"><span class="comment"> Â  Â  * Creates a new &#123;<span class="doctag">@code</span> AtomicStampedReference&#125; with the given</span></span><br><span class="line"><span class="comment">	 * initial values. Â  Â  </span></span><br><span class="line"><span class="comment">	 * Â  Â  </span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> initialRef the initial reference Â  Â  </span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> initialStamp the initial stamp Â  Â  </span></span><br><span class="line"><span class="comment">	 */</span> Â  Â </span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">AtomicStampedReference</span><span class="params">(V initialRef, <span class="keyword">int</span> initialStamp)</span> </span>&#123; Â  </span><br><span class="line">    	pair = Pair.of(initialRef, initialStamp); Â  </span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è§£å†³ABAé—®é¢˜ï¼Œå¼•å…¥äº†AtomicStampedReferenceã€‚</p>
<p>AtomicStampedReferenceå¯ä»¥ç»™å¼•ç”¨åŠ ä¸Šç‰ˆæœ¬å·ï¼Œè¿½è¸ªå¼•ç”¨çš„æ•´ä¸ªå˜åŒ–è¿‡ç¨‹ï¼Œå¦‚ï¼š A -&gt; B -&gt; C -&gt; D - &gt; Aï¼Œé€šè¿‡AtomicStampedReferenceï¼Œå¯ä»¥çŸ¥é“ï¼Œå¼•ç”¨å˜é‡ä¸­é€”è¢«æ›´æ”¹äº†3 æ¬¡ã€‚</p>
<p>ä½†æ˜¯ï¼Œæœ‰æ—¶å€™ï¼Œæˆ‘ä»¬å¹¶ä¸å…³å¿ƒå¼•ç”¨å˜é‡æ›´æ”¹äº†å‡ æ¬¡ï¼Œåªå…³å¿ƒæ˜¯å¦æ›´æ”¹è¿‡ï¼Œå°±æœ‰äº† AtomicMarkableReferenceï¼š<br>    AtomicMarkableReferenceå’ŒAtomicStampedReferenceçš„å”¯ä¸€åŒºåˆ«å°±æ˜¯ä¸å†ç”¨intæ ‡è¯†å¼•ç”¨ï¼Œè€Œæ˜¯ä½¿ ç”¨booleanå˜é‡â€”â€”è¡¨ç¤ºå¼•ç”¨å˜é‡æ˜¯å¦è¢«æ›´æ”¹è¿‡ã€‚<br>    AtomicMarkableReferenceå¯¹äºé‚£äº›ä¸å…³å¿ƒå¼•ç”¨å˜åŒ–è¿‡ç¨‹ï¼Œåªå…³å¿ƒå¼•ç”¨å˜é‡æ˜¯å¦å˜åŒ–è¿‡çš„åº”ç”¨ä¼šæ›´åŠ å‹å¥½ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AtomicMarkableReference</span>&lt;<span class="title">V</span>&gt; </span>&#123;</span><br><span class="line"> Â  Â <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Pair</span>&lt;<span class="title">T</span>&gt; </span>&#123; Â  Â </span><br><span class="line">        <span class="keyword">final</span> T reference; Â  Â  </span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> mark; Â  Â </span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="title">Pair</span><span class="params">(T reference, <span class="keyword">boolean</span> mark)</span> </span>&#123; Â  Â  </span><br><span class="line">            <span class="keyword">this</span>.reference = reference; Â  Â </span><br><span class="line">            <span class="keyword">this</span>.mark = mark; Â  Â  Â  </span><br><span class="line">        &#125; Â  Â  Â </span><br><span class="line">        <span class="keyword">static</span> &lt;T&gt; <span class="function">Pair&lt;T&gt; <span class="title">of</span><span class="params">(T reference, <span class="keyword">boolean</span> mark)</span> </span>&#123; Â </span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> Pair&lt;T&gt;(reference, mark); Â  Â  Â  </span><br><span class="line">        &#125; Â  </span><br><span class="line">    &#125;</span><br><span class="line"> Â  Â <span class="keyword">private</span> <span class="keyword">volatile</span> Pair&lt;V&gt; pair;</span><br><span class="line"> Â  Â <span class="comment">/** Â  Â  </span></span><br><span class="line"><span class="comment"> Â  Â   * Creates a new &#123;<span class="doctag">@code</span> AtomicMarkableReference&#125; with the given Â  </span></span><br><span class="line"><span class="comment">      * initial values. Â  </span></span><br><span class="line"><span class="comment">      * Â  Â </span></span><br><span class="line"><span class="comment">      * <span class="doctag">@param</span> initialRef the initial reference Â  Â  </span></span><br><span class="line"><span class="comment">      * <span class="doctag">@param</span> initialMark the initial mark </span></span><br><span class="line"><span class="comment">      */</span> Â  Â </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">AtomicMarkableReference</span><span class="params">(V initialRef, <span class="keyword">boolean</span> initialMark)</span> </span>&#123; </span><br><span class="line">        pair = Pair.of(initialRef, initialMark);</span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="3-2-4-åŸå­æ›´æ–°å­—æ®µç±»å‹"><a href="#3-2-4-åŸå­æ›´æ–°å­—æ®µç±»å‹" class="headerlink" title="3.2.4 åŸå­æ›´æ–°å­—æ®µç±»å‹"></a>3.2.4 åŸå­æ›´æ–°å­—æ®µç±»å‹</h5><p>å¦‚æœéœ€è¦æ›´æ–°å¯¹è±¡çš„æŸä¸ªå­—æ®µï¼Œå¹¶åœ¨å¤šçº¿ç¨‹çš„æƒ…å†µä¸‹ï¼Œèƒ½å¤Ÿä¿è¯çº¿ç¨‹å®‰å…¨ï¼ŒatomicåŒæ ·ä¹Ÿæä¾›äº†ç›¸åº”çš„ åŸå­æ“ä½œç±»ï¼š</p>
<ul>
<li>AtomicIntegeFieldUpdaterï¼šåŸå­æ›´æ–°æ•´å‹å­—æ®µç±»ï¼› </li>
<li>AtomicLongFieldUpdaterï¼šåŸå­æ›´æ–°é•¿æ•´å‹å­—æ®µç±»ï¼›</li>
<li>AtomicReferenceFieldUpdaterï¼š</li>
</ul>
<p>åŸå­æ›´æ–°å¼•ç”¨å­—æ®µç±»å‹ï¼›</p>
<p>è¦æƒ³ä½¿ç”¨åŸå­æ›´æ–°å­—æ®µéœ€è¦ä¸¤æ­¥æ“ä½œï¼š</p>
<ul>
<li>åŸå­æ›´æ–°å­—æ®µç±»éƒ½æ˜¯æŠ½è±¡ç±»ï¼Œåªèƒ½é€šè¿‡é™æ€æ–¹æ³• newUpdater æ¥åˆ›å»ºä¸€ä¸ªæ›´æ–°å™¨ï¼Œå¹¶ä¸”éœ€è¦è®¾ç½®æƒ³ è¦æ›´æ–°çš„ç±»å’Œå±æ€§ï¼› </li>
<li>æ›´æ–°ç±»çš„å±æ€§å¿…é¡»ä½¿ç”¨ public volatile è¿›è¡Œä¿®é¥°ï¼›</li>
<li>å­—æ®µå¿…é¡»æ˜¯volatileç±»å‹çš„ï¼Œåœ¨çº¿ç¨‹ä¹‹é—´å…±äº«å˜é‡æ—¶ä¿è¯ç«‹å³å¯è§ </li>
<li>å­—æ®µçš„æè¿°ç±»å‹ï¼ˆä¿®é¥°ç¬¦public/protected/default/privateï¼‰æ˜¯ä¸è°ƒç”¨è€…ä¸æ“ä½œå¯¹è±¡å­—æ®µçš„ å…³ç³»ä¸€è‡´ã€‚ä¹Ÿå°±æ˜¯è¯´è°ƒç”¨è€…èƒ½å¤Ÿç›´æ¥æ“ä½œå¯¹è±¡å­—æ®µï¼Œé‚£ä¹ˆå°±å¯ä»¥åå°„è¿›è¡ŒåŸå­æ“ä½œã€‚</li>
<li>å¯¹äºçˆ¶ç±»çš„å­—æ®µï¼Œå­ç±»æ˜¯ä¸èƒ½ç›´æ¥æ“ä½œçš„ï¼Œå°½ç®¡å­ç±»å¯ä»¥è®¿é—®çˆ¶ç±»çš„å­—æ®µã€‚</li>
<li>åªèƒ½æ˜¯å®ä¾‹å˜é‡ï¼Œä¸èƒ½æ˜¯ç±»å˜é‡ï¼Œä¹Ÿå°±æ˜¯è¯´ä¸èƒ½åŠ staticå…³é”®å­—ã€‚ </li>
<li>åªèƒ½æ˜¯å¯ä¿®æ”¹å˜é‡ï¼Œä¸èƒ½ä½¿finalå˜é‡ï¼Œå› ä¸ºfinalçš„è¯­ä¹‰å°±æ˜¯ä¸å¯ä¿®æ”¹ã€‚ </li>
<li>å¯¹äºAtomicIntegerFieldUpdaterå’ŒAtomicLongFieldUpdateråªèƒ½ä¿®æ”¹int/longç±»å‹çš„å­— æ®µï¼Œä¸èƒ½ä¿®æ”¹å…¶åŒ…è£…ç±»å‹ï¼ˆInteger/Longï¼‰ã€‚å¦‚æœè¦ä¿®æ”¹åŒ…è£…ç±»å‹å°±éœ€è¦ä½¿ç”¨ AtomicReferenceFieldUpdaterã€‚</li>
</ul>
<p>è¿™å‡ ä¸ªç±»æä¾›çš„æ–¹æ³•åŸºæœ¬ä¸€è‡´ï¼Œä»¥AtomicIntegerFieldUpdaterä¸ºä¾‹æ¥çœ‹çœ‹å…·ä½“çš„ä½¿ç”¨ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.concurrent.atomic.AtomicIntegerFieldUpdater;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AtomicIntegerFieldUpdaterTest</span></span>&#123;</span><br><span class="line">    </span><br><span class="line"> Â  Â <span class="keyword">private</span> <span class="keyword">static</span> AtomicIntegerFieldUpdater&lt;User&gt; a = </span><br><span class="line">        AtomicIntegerFieldUpdater.newUpdater(User.class, "age");</span><br><span class="line">    </span><br><span class="line"> Â  Â <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123; Â  Â  </span><br><span class="line">        User user = <span class="keyword">new</span> User(<span class="string">"conan"</span>, <span class="number">10</span>); Â  Â  Â  </span><br><span class="line">        System.out.println(a.getAndIncrement(user)); Â </span><br><span class="line">        System.out.println(a.get(user)); Â </span><br><span class="line">    &#125;</span><br><span class="line"> Â  Â <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123; Â  Â </span><br><span class="line">        <span class="keyword">private</span> String name; Â  Â  Â </span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">volatile</span> <span class="keyword">int</span> age; Â  Â  </span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">User</span><span class="params">(String name, <span class="keyword">int</span> age)</span> </span>&#123; Â  Â  Â </span><br><span class="line">            <span class="keyword">this</span>.name = name; Â  Â </span><br><span class="line">            <span class="keyword">this</span>.age = age; Â  Â  </span><br><span class="line">        &#125; Â  Â  Â </span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123; Â  Â  </span><br><span class="line">            <span class="keyword">return</span> name; Â  Â  </span><br><span class="line">        &#125; Â  Â  Â  Â </span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getAge</span><span class="params">()</span> </span>&#123; Â  Â  Â  Â </span><br><span class="line">            <span class="keyword">return</span> age; Â  Â  Â   </span><br><span class="line">        &#125; Â </span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä»ç¤ºä¾‹ä¸­å¯ä»¥çœ‹å‡ºï¼Œåˆ›å»º AtomicIntegerFieldUpdater æ˜¯é€šè¿‡å®ƒæä¾›çš„é™æ€æ–¹æ³•è¿›è¡Œåˆ›å»ºï¼Œ getAndAdd æ–¹æ³•ä¼šå°†æŒ‡å®šçš„å­—æ®µåŠ ä¸Šè¾“å…¥çš„å€¼ï¼Œå¹¶ä¸”è¿”å›ç›¸åŠ ä¹‹å‰çš„å€¼ã€‚userå¯¹è±¡ä¸­ageå­—æ®µåŸå€¼ä¸º 1ï¼ŒåŠ 5ä¹‹åï¼Œå¯ä»¥çœ‹å‡ºuserå¯¹è±¡ä¸­çš„ageå­—æ®µçš„å€¼å·²ç»å˜æˆäº†6ã€‚</p>
<h4 id="3-3-é”ï¼šLock"><a href="#3-3-é”ï¼šLock" class="headerlink" title="3.3 é”ï¼šLock"></a>3.3 é”ï¼šLock</h4><p>java.util.concurrent.locks åŒ…ï¼Œè¯¥åŒ…æä¾›äº†ä¸€ç³»åˆ—åŸºç¡€çš„é”å·¥å…·ï¼Œç”¨ä»¥å¯¹synchronizdã€waitã€ notifyç­‰è¿›è¡Œè¡¥å……ã€å¢å¼ºã€‚ juc-locksé”æ¡†æ¶ä¸­ä¸€å…±å°±ä¸‰ä¸ªæ¥å£ï¼šLockã€Conditionã€ReadWriteLockã€‚</p>
<h5 id="3-3-1-ReentrantLock"><a href="#3-3-1-ReentrantLock" class="headerlink" title="3.3.1 ReentrantLock"></a>3.3.1 ReentrantLock</h5><p>ReentrantLockå«åšå¯é‡å…¥é”ï¼ŒæŒ‡çš„æ˜¯çº¿ç¨‹å¯ä»¥é‡å¤è·å–åŒä¸€æŠŠé”ï¼Œæˆ–è€…è¯´è¯¥é”æ”¯æŒä¸€ä¸ªçº¿ç¨‹å¯¹èµ„æºçš„ é‡å¤åŠ é”ã€‚åŒæ—¶è¯¥é”è¿˜æ”¯æŒè·å–é”çš„å…¬å¹³æ€§å’Œéå…¬å¹³æ€§é€‰æ‹©ï¼Œé”çš„å…¬å¹³æ€§æ˜¯æŒ‡ï¼Œåœ¨ç»å¯¹æ—¶é—´ä¸Šï¼Œå…ˆå¯¹é” è·å–çš„è¯·æ±‚ä¸€å®šå…ˆè¢«æ»¡è¶³ï¼Œä¹Ÿå°±æ˜¯ç­‰å¾…æ—¶é—´é•¿çš„é‚£ä¸ªçº¿ç¨‹ä¼˜å…ˆè·å¾—ï¼Œå¯ä»¥è¯´ï¼Œé”çš„è·å–æ˜¯é¡ºåºçš„ï¼Œå³ ç¬¦åˆFIFOè§„åˆ™ã€‚<br>ReentrantLockä¹Ÿæ˜¯äº’æ–¥é”ï¼Œå› æ­¤ä¹Ÿå¯ä»¥ä¿è¯åŸå­æ€§ã€‚<br>ReentrantLock é‡å…¥é”çš„åŸºæœ¬åŸç†æ˜¯åˆ¤æ–­ä¸Šæ¬¡è·å–é”çš„çº¿ç¨‹æ˜¯å¦ä¸ºå½“å‰çº¿ç¨‹ï¼Œå¦‚æœæ˜¯åˆ™å¯å†æ¬¡è¿›å…¥ä¸´ ç•ŒåŒºï¼Œå¦‚æœä¸æ˜¯ï¼Œåˆ™é˜»å¡ã€‚<br>ç”±äºReentrantLockæ˜¯åŸºäºAQSå®ç°çš„ï¼Œåº•å±‚é€šè¿‡æ“ä½œåŒæ­¥çŠ¶æ€æ¥è·å–é”.ï¼Œä¸‹é¢çœ‹ä¸€ä¸‹éå…¬å¹³é”çš„å® ç°é€»è¾‘ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">nonfairTryAcquire</span><span class="params">(<span class="keyword">int</span> acquires)</span> </span>&#123; Â  Â  </span><br><span class="line">    <span class="comment">//è·å–å½“å‰çº¿ç¨‹ Â  Â  Â  Â  </span></span><br><span class="line">    <span class="keyword">final</span> Thread current = Thread.currentThread(); Â  Â  Â  Â </span><br><span class="line">    <span class="comment">//é€šè¿‡AQSè·å–åŒæ­¥çŠ¶æ€ Â  Â  Â  </span></span><br><span class="line">    <span class="keyword">int</span> c = getState(); Â  Â  Â  Â  Â  Â </span><br><span class="line">    <span class="comment">//åŒæ­¥çŠ¶æ€ä¸º0ï¼Œè¯´æ˜ä¸´ç•ŒåŒºå¤„äºæ— é”çŠ¶æ€ï¼Œ Â  Â  Â  Â  Â  Â </span></span><br><span class="line">    <span class="keyword">if</span> (c == <span class="number">0</span>) &#123; Â  Â  Â  Â  Â  Â </span><br><span class="line">        <span class="comment">//ä¿®æ”¹åŒæ­¥çŠ¶æ€ï¼Œå³åŠ é” Â  Â  Â  Â  Â </span></span><br><span class="line">        <span class="keyword">if</span> (compareAndSetState(<span class="number">0</span>, acquires)) &#123; Â  Â  Â  Â </span><br><span class="line">            <span class="comment">//å°†å½“å‰çº¿ç¨‹è®¾ç½®ä¸ºé”çš„owner Â  Â  </span></span><br><span class="line">            setExclusiveOwnerThread(current); Â  Â </span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>; Â  Â  Â  Â  Â  Â </span><br><span class="line">        &#125; Â  Â  Â  Â  </span><br><span class="line">    &#125; Â  Â  Â  </span><br><span class="line">    <span class="comment">//å¦‚æœä¸´ç•ŒåŒºå¤„äºé”å®šçŠ¶æ€ï¼Œä¸”ä¸Šæ¬¡è·å–é”çš„çº¿ç¨‹ä¸ºå½“å‰çº¿ç¨‹ Â </span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (current == getExclusiveOwnerThread()) &#123; Â  </span><br><span class="line">        <span class="comment">//åˆ™é€’å¢åŒæ­¥çŠ¶æ€ Â  Â  Â  </span></span><br><span class="line">        <span class="keyword">int</span> nextc = c + acquires; Â  Â  </span><br><span class="line">        <span class="keyword">if</span> (nextc &lt; <span class="number">0</span>) <span class="comment">// overflow Â  Â  Â </span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">"Maximum lock count exceeded"</span>); Â  </span><br><span class="line">        setState(nextc);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>; Â  Â  Â  </span><br><span class="line">    &#125; Â  Â  Â  Â </span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>; Â  Â  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æˆåŠŸè·å–é”çš„çº¿ç¨‹å†æ¬¡è·å–é”ï¼Œåªæ˜¯å¢åŠ äº†åŒæ­¥çŠ¶æ€å€¼ï¼Œåœ¨é‡Šæ”¾åŒæ­¥è½¬æ€æ—¶ï¼Œç›¸åº”çš„å‡å°‘åŒæ­¥çŠ¶æ€å€¼ï¼Œ å®ç°å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">tryRelease</span><span class="params">(<span class="keyword">int</span> releases)</span> </span>&#123; Â  Â  Â  </span><br><span class="line">    <span class="keyword">int</span> c = getState() - releases; Â  </span><br><span class="line">    <span class="keyword">if</span> (Thread.currentThread() != getExclusiveOwnerThread()) Â  Â  Â  </span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalMonitorStateException(); Â  Â </span><br><span class="line">    <span class="keyword">boolean</span> free = <span class="keyword">false</span>; Â  Â  Â  Â  </span><br><span class="line">    <span class="comment">//åœ¨åŒæ­¥çŠ¶æ€å®Œå…¨é‡Šæ”¾äº†ï¼Œè®¾ç½®true Â  Â </span></span><br><span class="line">    <span class="keyword">if</span> (c == <span class="number">0</span>) &#123; Â  Â  Â  Â  Â  Â  Â </span><br><span class="line">        free = <span class="keyword">true</span>; Â  Â  Â  </span><br><span class="line">        setExclusiveOwnerThread(<span class="keyword">null</span>); Â  Â  </span><br><span class="line">    &#125; Â  Â  Â  Â  Â  </span><br><span class="line">    setState(c); Â  Â </span><br><span class="line">    <span class="keyword">return</span> free; Â  Â </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å…¬å¹³é”å’Œéå…¬å¹³é”çš„æµ‹è¯•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList; </span><br><span class="line"><span class="keyword">import</span> java.util.Collection;</span><br><span class="line"><span class="keyword">import</span> java.util.Collections; </span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.locks.Lock; </span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.locks.ReentrantLock;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ReentrantLockTest</span> </span>&#123; Â  </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Lock fairLock = <span class="keyword">new</span> ReentrantLockMine(<span class="keyword">true</span>); </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Lock unfairLock = <span class="keyword">new</span> ReentrantLockMine(<span class="keyword">false</span>);</span><br><span class="line">    </span><br><span class="line"> Â  Â <span class="meta">@Test</span> Â  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">unfair</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123; Â  Â </span><br><span class="line">        testLock(<span class="string">"unfair lock"</span>, unfairLock); Â   </span><br><span class="line">    &#125;</span><br><span class="line"> Â  Â <span class="meta">@Test</span> Â  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">fair</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123; Â  </span><br><span class="line">        testLock(<span class="string">"fair lock"</span>, fairLock); Â   </span><br><span class="line">    &#125;</span><br><span class="line"> Â  Â <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">testLock</span><span class="params">(String type, Lock lock)</span> <span class="keyword">throws</span> InterruptedException </span>&#123; Â  </span><br><span class="line">        System.out.println(type); Â  Â </span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) &#123; Â  Â  Â </span><br><span class="line">            Thread thread = <span class="keyword">new</span> Thread(<span class="keyword">new</span> Job(lock))&#123; Â  Â  </span><br><span class="line">                <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123; Â  Â  Â  </span><br><span class="line">                    <span class="keyword">return</span> getName();</span><br><span class="line">                &#125; Â  Â  Â  Â  Â </span><br><span class="line">            &#125;; Â  Â  Â  </span><br><span class="line">            thread.setName(<span class="string">""</span> + i); Â  Â </span><br><span class="line">            thread.start(); Â  Â  Â </span><br><span class="line">        &#125; Â  Â  </span><br><span class="line">        Thread.sleep(<span class="number">11000</span>); Â  </span><br><span class="line">    &#125;</span><br><span class="line"> Â  Â <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Job</span> <span class="keyword">implements</span> <span class="title">Runnable</span></span>&#123; Â  Â </span><br><span class="line">        <span class="keyword">private</span> Lock lock; Â  Â  </span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">Job</span><span class="params">(Lock lock)</span> </span>&#123; Â  Â  Â </span><br><span class="line">            <span class="keyword">this</span>.lock = lock; Â  Â  </span><br><span class="line">        &#125;</span><br><span class="line"> Â  Â  Â  Â <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123; Â  </span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">2</span>; i++) &#123; Â  Â  Â </span><br><span class="line">                lock.lock(); Â  Â  Â  Â  Â  </span><br><span class="line">                <span class="keyword">try</span> &#123; Â  Â  Â  Â  Â  Â </span><br><span class="line">                    Thread.sleep(<span class="number">1000</span>); Â </span><br><span class="line">                    System.out.println(<span class="string">"è·å–é”çš„å½“å‰çº¿ç¨‹["</span> + Thread.currentThread().getName() + <span class="string">"], åŒæ­¥é˜Ÿåˆ—ä¸­çš„çº¿ç¨‹"</span> + ((ReentrantLockMine)lock).getQueuedThreads() + <span class="string">""</span>); Â  Â  Â </span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123; Â  Â </span><br><span class="line">                    e.printStackTrace(); Â  Â  Â  Â </span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123; Â  Â  Â  Â  Â  Â  Â  Â </span><br><span class="line">                    lock.unlock(); Â  Â  Â  </span><br><span class="line">                &#125; Â  Â  Â  </span><br><span class="line">            &#125; Â  Â  </span><br><span class="line">        &#125; Â </span><br><span class="line">    &#125;</span><br><span class="line"> Â  Â <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">ReentrantLockMine</span> <span class="keyword">extends</span> <span class="title">ReentrantLock</span> </span>&#123; Â </span><br><span class="line">        <span class="comment">//é‡æ–°å® ç°ReentrantLockç±»æ˜¯ä¸ºäº†é‡å†™getQueuedThreadsæ–¹æ³•ï¼Œä¾¿äºæˆ‘ä»¬è¯•éªŒçš„è§‚å¯Ÿ</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">ReentrantLockMine</span><span class="params">(<span class="keyword">boolean</span> fair)</span> </span>&#123; Â  Â  Â  Â </span><br><span class="line">            <span class="keyword">super</span>(fair); Â  Â  </span><br><span class="line">        &#125;</span><br><span class="line"> Â  Â  Â  Â <span class="meta">@Override</span> Â  </span><br><span class="line">        <span class="function"><span class="keyword">protected</span> Collection&lt;Thread&gt; <span class="title">getQueuedThreads</span><span class="params">()</span> </span>&#123; Â </span><br><span class="line">            <span class="comment">//è·å–åŒæ­¥é˜Ÿåˆ—ä¸­çš„ çº¿ç¨‹ Â  Â  Â  Â  Â </span></span><br><span class="line">            List&lt;Thread&gt; arrayList = <span class="keyword">new</span> ArrayList&lt;Thread&gt; (<span class="keyword">super</span>.getQueuedThreads());</span><br><span class="line">            Collections.reverse(arrayList); Â  Â  </span><br><span class="line">            <span class="keyword">return</span> arrayList; Â  Â  </span><br><span class="line">        &#125; Â </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>éå…¬å¹³é”çš„è·å–ï¼Œåªè¦è·å–äº†åŒæ­¥çŠ¶æ€å°±å¯ä»¥è·å–é”ï¼Œæœ‰å¯èƒ½å¯¼è‡´é¥¥é¥¿ç°è±¡ï¼Œä½†æ˜¯éå…¬å¹³é”ï¼Œçº¿ç¨‹çš„åˆ‡ æ¢æ¯”è¾ƒå°‘ï¼Œæ›´é«˜æ•ˆã€‚<br>ReentrantLockä¸synchronizedçš„åŒºåˆ«</p>
<ul>
<li><p>é‡å…¥ </p>
<p>synchronizedå¯é‡å…¥ï¼Œå› ä¸ºåŠ é”å’Œè§£é”è‡ªåŠ¨è¿›è¡Œï¼Œä¸å¿…æ‹…å¿ƒåæ˜¯å¦é‡Šæ”¾é”ï¼›ReentrantLockä¹Ÿ å¯é‡å…¥ï¼Œä½†åŠ é”å’Œè§£é”éœ€è¦æ‰‹åŠ¨è¿›è¡Œï¼Œä¸”æ¬¡æ•°éœ€ä¸€æ ·ï¼Œå¦åˆ™å…¶ä»–çº¿ç¨‹æ— æ³•è·å¾—é”ã€‚</p>
</li>
<li><p>å®ç°</p>
<p> synchronizedæ˜¯JVMå®ç°çš„ã€è€ŒReentrantLockæ˜¯JDKå®ç°çš„ã€‚è¯´ç™½äº†å°±æ˜¯ï¼Œæ˜¯æ“ä½œç³»ç»Ÿæ¥å®ç°ï¼Œ è¿˜æ˜¯ç”¨æˆ·è‡ªå·±æ•²ä»£ç å®ç°ã€‚ </p>
</li>
<li><p>æ€§èƒ½ </p>
<p>åœ¨ Java çš„ 1.5 ç‰ˆæœ¬ä¸­ï¼Œsynchronized æ€§èƒ½ä¸å¦‚ SDK é‡Œé¢çš„ Lockï¼Œä½† 1.6 ç‰ˆæœ¬ä¹‹åï¼Œ synchronized åšäº†å¾ˆå¤šä¼˜åŒ–ï¼Œå°†æ€§èƒ½è¿½äº†ä¸Šæ¥ã€‚</p>
</li>
<li><p>åŠŸèƒ½ </p>
<p>ReentrantLocké”çš„ç»†ç²’åº¦å’Œçµæ´»åº¦ï¼Œä¼˜äºsynchronizedã€‚ ReentrantLockä¸åŒç‚¹ä¸€ï¼šå¯åœ¨æ„é€ å‡½æ•°ä¸­æŒ‡å®šæ˜¯å…¬å¹³é”è¿˜æ˜¯éå…¬å¹³é”ï¼Œè€Œsynchronizedåªèƒ½æ˜¯éå…¬å¹³é”</p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ReentrantLock reentrantLock = <span class="keyword">new</span> ReentrantLock(<span class="keyword">true</span>);</span><br></pre></td></tr></table></figure>

<p>ReentrantLockä¸åŒç‚¹äºŒï¼šå¯ä»¥é¿å…æ­»é”é—®é¢˜ï¼Œå› ä¸ºå®ƒå¯ä»¥éé˜»å¡åœ°è·å–é”ã€‚å¦‚æœå°è¯•è·å– é”å¤±è´¥ï¼Œå¹¶ä¸è¿›å…¥é˜»å¡çŠ¶æ€ï¼Œè€Œæ˜¯ç›´æ¥è¿”å›falseï¼Œè¿™æ—¶å€™çº¿ç¨‹ä¸ç”¨é˜»å¡ç­‰å¾…ï¼Œå¯ä»¥å…ˆå»åšå…¶ä»–äº‹æƒ…ã€‚ æ‰€ä»¥ä¸ä¼šé€ æˆæ­»é”ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ”¯æŒéé˜»å¡è·å–é”çš„ API </span></span><br><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">tryLock</span><span class="params">()</span></span>;</span><br></pre></td></tr></table></figure>

<p>tryLockè¿˜æ”¯æŒè¶…æ—¶ã€‚è°ƒç”¨tryLockæ—¶æ²¡æœ‰è·å–åˆ°é”ï¼Œä¼šç­‰å¾…ä¸€æ®µæ—¶é—´ï¼Œå¦‚æœçº¿ç¨‹åœ¨ä¸€æ®µæ—¶é—´ä¹‹å†…è¿˜æ˜¯ æ²¡æœ‰è·å–åˆ°é”ï¼Œä¸æ˜¯è¿›å…¥é˜»å¡çŠ¶æ€ï¼Œè€Œæ˜¯throws InterruptedExceptionï¼Œé‚£è¿™ä¸ªçº¿ç¨‹ä¹Ÿæœ‰æœºä¼šé‡Šæ”¾ æ›¾ç»æŒæœ‰çš„é”ï¼Œè¿™æ ·ä¹Ÿèƒ½ç ´åæ­»é”ä¸å¯æŠ¢å æ¡ä»¶ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">tryLock</span><span class="params">(<span class="keyword">long</span> time, TimeUnit unit)</span></span></span><br></pre></td></tr></table></figure>

<p>ReentrantLockä¸åŒç‚¹ä¸‰ï¼šæä¾›èƒ½å¤Ÿä¸­æ–­ç­‰å¾…é”æœºåˆ¶ã€‚</p>
<p>synchronized çš„é—®é¢˜æ˜¯ï¼ŒæŒæœ‰é” A åï¼Œå¦‚æœå°è¯•è·å–é” B å¤±è´¥ï¼Œé‚£ä¹ˆçº¿ç¨‹å°±è¿›å…¥é˜»å¡çŠ¶æ€ï¼Œä¸€æ—¦ å‘ç”Ÿæ­»é”ï¼Œå°±æ²¡æœ‰ä»»ä½•æœºä¼šæ¥å”¤é†’é˜»å¡çš„çº¿ç¨‹ã€‚</p>
<p>ä½†å¦‚æœé˜»å¡çŠ¶æ€çš„çº¿ç¨‹èƒ½å¤Ÿå“åº”ä¸­æ–­ä¿¡å·ï¼Œä¹Ÿå°±æ˜¯è¯´å½“æˆ‘ä»¬ç»™é˜»å¡çš„çº¿ç¨‹å‘é€ä¸­æ–­ä¿¡å·çš„æ—¶å€™ï¼Œèƒ½å¤Ÿå”¤ é†’å®ƒï¼Œé‚£å®ƒå°±æœ‰æœºä¼šé‡Šæ”¾æ›¾ç»æŒæœ‰çš„é” Aã€‚ReentrantLockå¯ä»¥ç”¨lockInterruptiblyæ–¹æ³•æ¥å®ç°ã€‚</p>
<p>ReentrantLockä¸åŒç‚¹å››ï¼šå¯ä»¥ç”¨J.U.CåŒ…ä¸­çš„Conditionå®ç°åˆ†ç»„å”¤é†’éœ€è¦ç­‰å¾…çš„çº¿ç¨‹ã€‚è€Œ synchronizedåªèƒ½notifyæˆ–è€…notifyAllã€‚</p>
<h5 id="3-3-2-LockSupport"><a href="#3-3-2-LockSupport" class="headerlink" title="3.3.2 LockSupport"></a>3.3.2 LockSupport</h5><p>LockSupportç±»ï¼Œæ˜¯JUCåŒ…ä¸­çš„ä¸€ä¸ªå·¥å…·ç±»ï¼Œå®šä¹‰äº†ä¸€ç»„é™æ€æ–¹æ³•ï¼Œæä¾›åŸºæœ¬çš„çº¿ç¨‹é˜»å¡å’Œå”¤é†’åŠŸ èƒ½ï¼Œæ˜¯æ„å»ºåŒæ­¥ç»„ä»¶çš„åŸºç¡€å·¥å…·ï¼Œç”¨æ¥åˆ›å»ºé”å’Œå…¶ä»–åŒæ­¥ç±»çš„åŸºæœ¬çº¿ç¨‹é˜»å¡åŸè¯­ã€‚<br>LockSupportç±»çš„æ ¸å¿ƒæ–¹æ³•å…¶å®å°±ä¸¤ä¸ªï¼špark() å’Œ unpark()ï¼Œå…¶ä¸­ park() æ–¹æ³•ç”¨æ¥é˜»å¡çº¿ç¨‹ï¼Œ unpark()æ–¹æ³•ç”¨äºå”¤é†’æŒ‡å®šçº¿ç¨‹ã€‚<br>å’ŒObjectç±»çš„wait() å’Œ signal() æ–¹æ³•æœ‰äº›ç±»ä¼¼ï¼Œä½†æ˜¯LockSupportçš„è¿™ä¸¤ç§æ–¹æ³•ä»è¯­æ„ä¸Šè®²æ¯” Objectç±»çš„æ–¹æ³•æ›´æ¸…æ™°ï¼Œè€Œä¸”å¯ä»¥é’ˆå¯¹æŒ‡å®šçº¿ç¨‹è¿›è¡Œé˜»å¡å’Œå”¤é†’ã€‚<br>LockSupportç±»ä½¿ç”¨äº†ä¸€ç§åä¸ºPermitï¼ˆè®¸å¯ï¼‰çš„æ¦‚å¿µæ¥åšåˆ°é˜»å¡å’Œå”¤é†’çº¿ç¨‹çš„åŠŸèƒ½ï¼Œå¯ä»¥æŠŠè®¸å¯çœ‹ æˆæ˜¯ä¸€ç§ï¼ˆ0ï¼Œ1ï¼‰ä¿¡å·é‡ï¼ˆSemaphoreï¼‰ï¼Œä½†ä¸Semaphoreä¸åŒçš„æ˜¯ï¼Œè®¸å¯çš„é‡åŠ ä¸Šé™1ã€‚<br>åˆå§‹æ—¶ï¼Œpermitä¸º0ï¼Œå½“è°ƒç”¨ unpark() æ–¹æ³•æ—¶ï¼Œçº¿ç¨‹çš„permitåŠ 1ï¼Œå½“è°ƒç”¨ park()æ–¹æ³•æ—¶ï¼Œå¦‚æœ permitä¸º0ï¼Œåˆ™è°ƒç”¨çº¿ç¨‹è¿›å…¥é˜»å¡çŠ¶æ€ã€‚</p>
<p>å‡è®¾ç°åœ¨éœ€è¦å®ç°ä¸€ç§FIFOç±»å‹çš„ç‹¬å é”ï¼Œå¯ä»¥æŠŠè¿™ç§é”çœ‹æˆæ˜¯ReentrantLockçš„å…¬å¹³é”ç®€å•ç‰ˆæœ¬ï¼Œ ä¸”æ˜¯ä¸å¯é‡å…¥çš„ï¼Œå°±æ˜¯è¯´å½“ä¸€ä¸ªçº¿ç¨‹è·å¾—é”åï¼Œå…¶ä»–ç­‰å¾…çº¿ç¨‹ä»¥FIFOçš„è°ƒåº¦æ–¹å¼ç­‰å¾…è·å–é”ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.Queue; </span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ConcurrentLinkedQueue; </span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.atomic.AtomicBoolean;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.locks.LockSupport;</span><br><span class="line"> <span class="class"><span class="keyword">class</span> <span class="title">FIFOMutex</span>  </span>&#123; Â </span><br><span class="line">     <span class="keyword">private</span> <span class="keyword">final</span> AtomicBoolean locked = <span class="keyword">new</span> AtomicBoolean(<span class="keyword">false</span>); Â </span><br><span class="line">     <span class="keyword">private</span> <span class="keyword">final</span> Queue&lt;Thread&gt; waiters = <span class="keyword">new</span> ConcurrentLinkedQueue&lt;&gt;();</span><br><span class="line">     </span><br><span class="line"> Â  Â <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">lock</span><span class="params">()</span></span>&#123; Â  Â </span><br><span class="line">        Thread current = Thread.currentThread(); Â  Â  Â  </span><br><span class="line">        waiters.add(current); Â  Â  Â  </span><br><span class="line">        <span class="comment">// å¦‚æœå½“å‰çº¿ç¨‹ä¸åœ¨é˜Ÿé¦–ï¼Œæˆ–é”å·²è¢«å ç”¨ï¼Œåˆ™å½“å‰çº¿ç¨‹é˜»å¡ </span></span><br><span class="line">        <span class="comment">// è¿™ä¸ªåˆ¤æ–­çš„å†…åœ¨æ„å›¾ï¼šé”å¿…é¡»ç”±é˜Ÿé¦–å…ƒç´ æ‹¿åˆ° Â  Â </span></span><br><span class="line">        <span class="keyword">while</span> (waiters.peek() != current || !locked.compareAndSet(<span class="keyword">false</span>,<span class="keyword">true</span>))&#123; Â </span><br><span class="line">            LockSupport.park(); Â  Â  Â </span><br><span class="line">        &#125; Â  Â  Â  </span><br><span class="line">        waiters.remove();</span><br><span class="line">        <span class="comment">// åˆ é™¤é˜Ÿé¦–å…ƒç´  Â </span></span><br><span class="line">    &#125;</span><br><span class="line"> Â  Â <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">unlock</span><span class="params">()</span></span>&#123; </span><br><span class="line">        locked.set(<span class="keyword">false</span>); Â  Â </span><br><span class="line">        LockSupport.unpark(waiters.peek()); Â </span><br><span class="line">    &#125; </span><br><span class="line"> &#125; </span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestFIFOMutex</span> </span>&#123; Â </span><br><span class="line">     <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123; Â </span><br><span class="line">         FIFOMutex mutex = <span class="keyword">new</span> FIFOMutex(); </span><br><span class="line">         MyThread a1 = <span class="keyword">new</span> MyThread(<span class="string">"a"</span>, mutex); Â  </span><br><span class="line">         MyThread a2 = <span class="keyword">new</span> MyThread(<span class="string">"b"</span>, mutex); Â  </span><br><span class="line">         MyThread a3 = <span class="keyword">new</span> MyThread(<span class="string">"c"</span>, mutex); Â </span><br><span class="line">         a1.start(); Â  Â  </span><br><span class="line">         a2.start(); Â  Â  </span><br><span class="line">         a3.start(); Â  Â  </span><br><span class="line">         a1.join(); Â  Â  Â  Â </span><br><span class="line">         a2.join(); Â </span><br><span class="line">         a3.join(); Â  Â  </span><br><span class="line">         System.out.println(<span class="string">"Finished"</span>); Â </span><br><span class="line">     &#125; </span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyThread</span> <span class="keyword">extends</span> <span class="title">Thread</span></span>&#123; Â </span><br><span class="line">    <span class="keyword">private</span> String name; Â </span><br><span class="line">    <span class="keyword">private</span> FIFOMutex mutex; Â  Â </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> count; Â </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MyThread</span><span class="params">(String name, FIFOMutex mutex)</span> </span>&#123; </span><br><span class="line">        <span class="keyword">this</span>.name = name; Â  </span><br><span class="line">        <span class="keyword">this</span>.mutex = mutex;</span><br><span class="line"> Â   &#125;</span><br><span class="line">    </span><br><span class="line">Â 	<span class="meta">@Override</span> Â </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123; Â  Â  </span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">20</span>; i++) &#123; Â  Â </span><br><span class="line">            mutex.lock(); Â  Â  Â </span><br><span class="line">            count++; Â  Â  Â  Â  </span><br><span class="line">            System.out.println(<span class="string">"thread:"</span>+Thread.currentThread().getName()+<span class="string">" name:"</span> + name + <span class="string">" count:"</span> + count); Â </span><br><span class="line">            mutex.unlock(); Â  </span><br><span class="line">        &#125; Â </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¸Šè¿°FIFOMutexç±»çš„å®ç°ä¸­ï¼Œå½“åˆ¤æ–­é”å·²è¢«å ç”¨æ—¶ï¼Œä¼šè°ƒç”¨ LockSupport.park(this) æ–¹æ³•ï¼Œå°†å½“å‰ è°ƒç”¨çº¿ç¨‹é˜»å¡ï¼›å½“ä½¿ç”¨å®Œé”æ—¶ï¼Œä¼šè°ƒç”¨ LockSupport.unpark(waiters.peek()) æ–¹æ³•å°†ç­‰å¾…é˜Ÿåˆ—ä¸­ çš„é˜Ÿé¦–çº¿ç¨‹å”¤é†’ã€‚<br>é€šè¿‡LockSupportçš„è¿™ä¸¤ä¸ªæ–¹æ³•ï¼Œå¯ä»¥å¾ˆæ–¹ä¾¿çš„é˜»å¡å’Œå”¤é†’çº¿ç¨‹ã€‚</p>
<ul>
<li>park æ–¹æ³•æ˜¯ä¼šå“åº”ä¸­æ–­çš„ï¼Œä½†æ˜¯ä¸ä¼šæŠ›å‡ºå¼‚å¸¸ã€‚ï¼ˆä¹Ÿå°±æ˜¯è¯´å¦‚æœå½“å‰è°ƒç”¨çº¿ç¨‹è¢«ä¸­æ–­ï¼Œåˆ™ä¼šç«‹å³ è¿”å›ä½†ä¸ä¼šæŠ›å‡ºä¸­æ–­å¼‚å¸¸ï¼‰ </li>
<li>park çš„é‡è½½æ–¹æ³• park(Object blocker)ï¼Œä¼šä¼ å…¥ä¸€ä¸ªblockerå¯¹è±¡ï¼Œæ‰€è°“Blockerå¯¹è±¡ï¼Œå…¶å® å°±æ˜¯å½“å‰çº¿ç¨‹è°ƒç”¨æ—¶æ‰€åœ¨è°ƒç”¨å¯¹è±¡ï¼ˆå¦‚ä¸Šè¿°ç¤ºä¾‹ä¸­çš„FIFOMutexå¯¹è±¡ï¼‰ã€‚è¯¥å¯¹è±¡ä¸€èˆ¬ä¾›ç›‘è§†ã€è¯Šæ–­ å·¥å…·ç¡®å®šçº¿ç¨‹å—é˜»å¡çš„åŸå› æ—¶ä½¿ç”¨ã€‚</li>
</ul>
<h5 id="3-3-3-Condition"><a href="#3-3-3-Condition" class="headerlink" title="3.3.3 Condition"></a>3.3.3 Condition</h5><p>åœ¨æ²¡æœ‰Lockä¹‹å‰ï¼Œæˆ‘ä»¬ä½¿ç”¨synchronizedæ¥æ§åˆ¶åŒæ­¥ï¼Œé…åˆObjectçš„wait()ã€wait(long timeout)ã€notify()ã€ä»¥åŠnotifyAll ç­‰æ–¹æ³•å¯ä»¥å®ç°ç­‰å¾…/é€šçŸ¥æ¨¡å¼ã€‚<br>Conditionæ¥å£ä¹Ÿæä¾›äº†ç±»ä¼¼äºObjectçš„ç›‘å¬å™¨æ–¹æ³•ã€ä¸Lockæ¥å£é…åˆå¯ä»¥å®ç°ç­‰å¾…/é€šçŸ¥æ¨¡å¼ï¼Œä½†æ˜¯ ä¸¤è€…è¿˜æ˜¯æœ‰å¾ˆå¤§åŒºåˆ«çš„ï¼Œä¸‹å›¾æ˜¯ä¸¤è€…çš„å¯¹æ¯”ï¼š</p>
<p><img src="/img/loading.gif" class="lazyload" data-src="/2021/01/09/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%EF%BC%88%E4%B8%89%EF%BC%89/img2.jpg"  alt></p>
<p>Condition å°† Object ç›‘è§†å™¨æ–¹æ³•ï¼ˆwaitã€notify å’Œ notifyAllï¼‰åˆ†è§£æˆæˆªç„¶ä¸åŒçš„å¯¹è±¡ï¼Œä»¥ä¾¿ é€šè¿‡å°†è¿™äº›å¯¹è±¡ä¸ä»»æ„ Lock å®ç°ç»„åˆä½¿ç”¨ï¼Œä¸ºæ¯ä¸ªå¯¹è±¡æä¾›å¤šä¸ªç­‰å¾… setï¼ˆwait-setï¼‰ã€‚å…¶ä¸­ï¼Œ Lock æ›¿ä»£äº† synchronized æ–¹æ³•å’Œè¯­å¥çš„ä½¿ç”¨ï¼ŒCondition æ›¿ä»£äº† Object ç›‘è§†å™¨æ–¹æ³•çš„ä½¿ç”¨ã€‚</p>
<p>æ¡ä»¶ï¼ˆä¹Ÿç§°ä¸ºæ¡ä»¶é˜Ÿåˆ— æˆ–æ¡ä»¶å˜é‡ï¼‰ä¸ºçº¿ç¨‹æä¾›äº†ä¸€ä¸ªå«ä¹‰ï¼Œä»¥ä¾¿åœ¨æŸä¸ªçŠ¶æ€æ¡ä»¶ç°åœ¨å¯èƒ½ä¸º true çš„å¦ä¸€ä¸ªçº¿ç¨‹é€šçŸ¥å®ƒä¹‹å‰ï¼Œä¸€ç›´æŒ‚èµ·è¯¥çº¿ç¨‹ï¼ˆå³è®©å…¶â€œç­‰å¾…â€ï¼‰ã€‚å› ä¸ºè®¿é—®æ­¤å…±äº«çŠ¶æ€ä¿¡æ¯å‘ç”Ÿåœ¨ä¸åŒ çš„çº¿ç¨‹ä¸­ï¼Œæ‰€ä»¥å®ƒå¿…é¡»å—ä¿æŠ¤ï¼Œå› æ­¤è¦å°†æŸç§å½¢å¼çš„é”ä¸è¯¥æ¡ä»¶ç›¸å…³è”ã€‚ç­‰å¾…æä¾›ä¸€ä¸ªæ¡ä»¶çš„ä¸»è¦å±æ€§ æ˜¯ï¼šä»¥åŸå­æ–¹å¼ é‡Šæ”¾ç›¸å…³çš„é”ï¼Œå¹¶æŒ‚èµ·å½“å‰çº¿ç¨‹ï¼Œå°±åƒ Object.wait åšçš„é‚£æ ·ã€‚</p>
<p>Condition å®ä¾‹å®è´¨ä¸Šè¢«ç»‘å®šåˆ°ä¸€ä¸ªé”ä¸Šã€‚è¦ä¸ºç‰¹å®š Lock å®ä¾‹è·å¾— Condition å®ä¾‹ï¼Œè¯·ä½¿ç”¨å…¶ newCondition() æ–¹æ³•ã€‚<br>æ ¸å¿ƒæ–¹æ³•<br>Conditionæä¾›äº†ä¸€ç³»åˆ—çš„æ–¹æ³•æ¥å¯¹é˜»å¡å’Œå”¤é†’çº¿ç¨‹ï¼š</p>
<ul>
<li>await()ï¼šé€ æˆå½“å‰çº¿ç¨‹åœ¨æ¥åˆ°ä¿¡å·æˆ–è¢«ä¸­æ–­ä¹‹å‰ä¸€ç›´å¤„äºç­‰å¾…çŠ¶æ€ã€‚</li>
<li>await(long time, TimeUnit unit) ï¼šé€ æˆå½“å‰çº¿ç¨‹åœ¨æ¥åˆ°ä¿¡å·ã€è¢«ä¸­æ–­æˆ–åˆ°è¾¾æŒ‡å®šç­‰å¾…æ—¶ é—´ä¹‹å‰ä¸€ç›´å¤„äºç­‰å¾…çŠ¶æ€ã€‚ </li>
<li>awaitNanos(long nanosTimeout) ï¼šé€ æˆå½“å‰çº¿ç¨‹åœ¨æ¥åˆ°ä¿¡å·ã€è¢«ä¸­æ–­æˆ–åˆ°è¾¾æŒ‡å®šç­‰å¾…æ—¶é—´ ä¹‹å‰ä¸€ç›´å¤„äºç­‰å¾…çŠ¶æ€ã€‚è¿”å›å€¼è¡¨ç¤ºå‰©ä½™æ—¶é—´ï¼Œå¦‚æœåœ¨nanosTimesoutä¹‹å‰å”¤é†’ï¼Œé‚£ä¹ˆè¿”å›å€¼ = nanosTimeout - æ¶ˆè€—æ—¶é—´ï¼Œå¦‚æœè¿”å›å€¼ &lt;= 0 ,åˆ™å¯ä»¥è®¤å®šå®ƒå·²ç»è¶…æ—¶äº†ã€‚ </li>
<li>awaitUninterruptibly() ï¼šé€ æˆå½“å‰çº¿ç¨‹åœ¨æ¥åˆ°ä¿¡å·ä¹‹å‰ä¸€ç›´å¤„äºç­‰å¾…çŠ¶æ€ã€‚ã€æ³¨æ„ï¼šè¯¥æ–¹æ³•å¯¹ä¸­æ–­ä¸æ•æ„Ÿã€‘ã€‚ </li>
<li>awaitUntil(Date deadline) ï¼šé€ æˆå½“å‰çº¿ç¨‹åœ¨æ¥åˆ°ä¿¡å·ã€è¢«ä¸­æ–­æˆ–åˆ°è¾¾æŒ‡å®šåæœŸé™ä¹‹å‰ä¸€ ç›´å¤„äºç­‰å¾…çŠ¶æ€ã€‚å¦‚æœæ²¡æœ‰åˆ°æŒ‡å®šæ—¶é—´å°±è¢«é€šçŸ¥ï¼Œåˆ™è¿”å›trueï¼Œå¦åˆ™è¡¨ç¤ºåˆ°äº†æŒ‡å®šæ—¶é—´ï¼Œè¿”å›è¿” å›falseã€‚</li>
<li>signal() ï¼šå”¤é†’ä¸€ä¸ªç­‰å¾…çº¿ç¨‹ã€‚è¯¥çº¿ç¨‹ä»ç­‰å¾…æ–¹æ³•è¿”å›å‰å¿…é¡»è·å¾—ä¸Conditionç›¸å…³çš„é”ã€‚</li>
<li>signalAll() ï¼šå”¤é†’æ‰€æœ‰ç­‰å¾…çº¿ç¨‹ã€‚èƒ½å¤Ÿä»ç­‰å¾…æ–¹æ³•è¿”å›çš„çº¿ç¨‹å¿…é¡»è·å¾—ä¸Conditionç›¸å…³çš„ é”ã€‚</li>
</ul>
<p>Conditionæ˜¯ä¸€ç§å¹¿ä¹‰ä¸Šçš„æ¡ä»¶é˜Ÿåˆ—ã€‚ä»–ä¸ºçº¿ç¨‹æä¾›äº†ä¸€ç§æ›´ä¸ºçµæ´»çš„ç­‰å¾…/é€šçŸ¥æ¨¡å¼ï¼Œçº¿ç¨‹åœ¨è°ƒç”¨ awaitæ–¹æ³•åæ‰§è¡ŒæŒ‚èµ·æ“ä½œï¼Œç›´åˆ°çº¿ç¨‹ç­‰å¾…çš„æŸä¸ªæ¡ä»¶ä¸ºçœŸæ—¶æ‰ä¼šè¢«å”¤é†’ã€‚Conditionå¿…é¡»è¦é…åˆé”ä¸€ èµ·ä½¿ç”¨ï¼Œå› ä¸ºå¯¹å…±äº«çŠ¶æ€å˜é‡çš„è®¿é—®å‘ç”Ÿåœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ã€‚ä¸€ä¸ªConditionçš„å®ä¾‹å¿…é¡»ä¸ä¸€ä¸ªLockç»‘ å®šï¼Œå› æ­¤Conditionä¸€èˆ¬éƒ½æ˜¯ä½œä¸ºLockçš„å†…éƒ¨å®ç°ã€‚</p>
<h6 id="æºç æ¢ç´¢"><a href="#æºç æ¢ç´¢" class="headerlink" title="æºç æ¢ç´¢"></a>æºç æ¢ç´¢</h6><p>è·å–ä¸€ä¸ªConditionå¿…é¡»è¦é€šè¿‡Lockçš„newCondition()æ–¹æ³•ã€‚è¯¥æ–¹æ³•å®šä¹‰åœ¨æ¥å£Lockä¸‹ï¼Œè¿”å›çš„ç»“æœ æ˜¯ç»‘å®šåˆ°æ­¤ Lock å®ä¾‹çš„æ–° Condition å®ä¾‹ã€‚<br>Conditionä¸ºä¸€ä¸ªæ¥å£ï¼Œå…¶ä¸‹ä»…æœ‰ä¸€ä¸ªå®ç°ç±»ConditionObjectï¼Œç”±äºConditionçš„æ“ä½œéœ€è¦è·å–ç›¸å…³ çš„é”ï¼Œè€ŒAQSåˆ™æ˜¯åŒæ­¥é”çš„å®ç°åŸºç¡€ï¼Œæ‰€ä»¥ConditionObjectåˆ™å®šä¹‰ä¸ºAQSçš„å†…éƒ¨ç±»ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConditionObject</span> <span class="keyword">implements</span> <span class="title">Condition</span>, <span class="title">java</span>.<span class="title">io</span>.<span class="title">Serializable</span> </span>&#123;</span><br><span class="line">	<span class="comment">// çœç•¥æ–¹æ³• </span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>ç­‰å¾…é˜Ÿåˆ—</strong><br>æ¯ä¸ªConditionå¯¹è±¡éƒ½åŒ…å«ç€ä¸€ä¸ªFIFOé˜Ÿåˆ—ï¼Œè¯¥é˜Ÿåˆ—æ˜¯Conditionå¯¹è±¡é€šçŸ¥/ç­‰å¾…åŠŸèƒ½çš„å…³é”®ã€‚<br>åœ¨é˜Ÿåˆ—ä¸­æ¯ä¸€ä¸ªèŠ‚ç‚¹éƒ½åŒ…å«ç€ä¸€ä¸ªçº¿ç¨‹å¼•ç”¨ï¼Œè¯¥çº¿ç¨‹å°±æ˜¯åœ¨è¯¥Conditionå¯¹è±¡ä¸Šç­‰å¾…çš„çº¿ç¨‹ã€‚<br>Conditionçš„å®šä¹‰ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConditionObject</span> <span class="keyword">implements</span> <span class="title">Condition</span>, <span class="title">java</span>.<span class="title">io</span>.<span class="title">Serializable</span> </span>&#123; Â </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">1173984872572414699L</span>; </span><br><span class="line">    <span class="comment">/** First node of condition queue. */</span> Â  Â  </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">transient</span> Node firstWaiter; Â  Â  Â  Â  Â  </span><br><span class="line">    <span class="comment">/** Last node of condition queue. */</span> Â  </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">transient</span> Node lastWaiter;</span><br><span class="line">    </span><br><span class="line">Â  Â  Â  Â <span class="comment">/** Â  </span></span><br><span class="line"><span class="comment">         * Creates a new &#123;<span class="doctag">@code</span> ConditionObject&#125; instance.</span></span><br><span class="line"><span class="comment">	  */</span> Â  Â </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ConditionObject</span><span class="params">()</span> </span>&#123; &#125;</span><br><span class="line">Â  Â  Â  Â <span class="comment">// Internal methods Â  Â  </span></span><br><span class="line">    	<span class="comment">// çœç•¥æ–¹æ³•</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä»ä¸Šé¢ä»£ç å¯ä»¥çœ‹å‡ºConditionæ‹¥æœ‰é¦–èŠ‚ç‚¹ï¼ˆfirstWaiterï¼‰ï¼Œå°¾èŠ‚ç‚¹ï¼ˆlastWaiterï¼‰ã€‚</p>
<p>å½“å‰çº¿ç¨‹è°ƒç”¨await()æ–¹æ³•ï¼Œå°†ä¼šä»¥å½“å‰çº¿ç¨‹æ„é€ æˆä¸€ä¸ªèŠ‚ç‚¹ï¼ˆNodeï¼‰ï¼Œå¹¶å°†èŠ‚ç‚¹åŠ å…¥åˆ°è¯¥é˜Ÿåˆ—çš„å°¾ éƒ¨ã€‚<br>Nodeé‡Œé¢åŒ…å«äº†å½“å‰çº¿ç¨‹çš„å¼•ç”¨ã€‚Nodeå®šä¹‰ä¸AQSçš„CLHåŒæ­¥é˜Ÿåˆ—çš„èŠ‚ç‚¹ä½¿ç”¨çš„éƒ½æ˜¯åŒä¸€ä¸ªç±»ã€‚</p>
<p>Conditionçš„é˜Ÿåˆ—ç»“æ„æ¯”CLHåŒæ­¥é˜Ÿåˆ—çš„ç»“æ„ç®€å•äº›ï¼Œæ–°å¢è¿‡ç¨‹è¾ƒä¸ºç®€å•åªéœ€è¦å°†åŸå°¾èŠ‚ç‚¹çš„ nextWaiteræŒ‡å‘æ–°å¢èŠ‚ç‚¹ï¼Œç„¶åæ›´æ–°lastWaiterå³å¯ã€‚</p>
<p><strong>ç­‰å¾…</strong><br>è°ƒç”¨Conditionçš„await()æ–¹æ³•ä¼šä½¿å½“å‰çº¿ç¨‹è¿›å…¥ç­‰å¾…çŠ¶æ€ï¼ŒåŒæ—¶ä¼šåŠ å…¥åˆ°Conditionç­‰å¾…é˜Ÿåˆ—å¹¶é‡Šæ”¾ é”ã€‚</p>
<p>å½“ä»await()æ–¹æ³•è¿”å›æ—¶ï¼Œå½“å‰çº¿ç¨‹ä¸€å®šæ˜¯è·å–äº†Conditionç›¸çš„é”ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">await</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123; Â </span><br><span class="line">    <span class="comment">// å½“å‰çº¿ç¨‹ä¸­æ–­ã€ç›´æ¥å¼‚å¸¸ Â  </span></span><br><span class="line">    <span class="keyword">if</span> (Thread.interrupted()) Â  </span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> InterruptedException(); Â  Â  </span><br><span class="line">    <span class="comment">//åŠ å…¥ç­‰å¾…é˜Ÿåˆ— Â  Â  Â  Â  Â  Â </span></span><br><span class="line">    Node node = addConditionWaiter(); Â  Â </span><br><span class="line">    <span class="comment">//é‡Šæ”¾é” Â  Â  Â  Â  Â  </span></span><br><span class="line">    <span class="keyword">int</span> savedState = fullyRelease(node); Â  Â  Â </span><br><span class="line">    <span class="keyword">int</span> interruptMode = <span class="number">0</span>; Â  Â  Â </span><br><span class="line">    <span class="comment">//æ£€æµ‹å½“å‰èŠ‚ç‚¹æ˜¯å¦åœ¨åŒæ­¥é˜Ÿåˆ—ä¸Šã€å¦‚æœä¸åœ¨åˆ™è¯´æ˜è¯¥èŠ‚ç‚¹æ²¡æœ‰èµ„æ ¼ç«äº‰é”ï¼Œç»§ç»­ç­‰ å¾…ã€‚</span></span><br><span class="line">    <span class="keyword">while</span> (!isOnSyncQueue(node)) &#123; Â  Â  Â </span><br><span class="line">        <span class="comment">// æŒ‚èµ·çº¿ç¨‹ Â  Â  Â  Â  Â  </span></span><br><span class="line">        LockSupport.park(<span class="keyword">this</span>); Â  Â  Â  Â  Â  </span><br><span class="line">        <span class="comment">// çº¿ç¨‹é‡Šæ˜¯å¦è¢«ä¸­æ–­ï¼Œä¸­æ–­ç›´æ¥é€€å‡º Â  Â  Â </span></span><br><span class="line">        <span class="keyword">if</span> ((interruptMode = checkInterruptWhileWaiting(node)) != <span class="number">0</span>) Â  Â  Â  </span><br><span class="line">            <span class="keyword">break</span>; Â  Â  Â  Â </span><br><span class="line">    &#125; Â  Â  Â  Â  Â  Â  Â  Â  Â  </span><br><span class="line">    <span class="comment">// è·å–åŒæ­¥çŠ¶æ€ Â  Â </span></span><br><span class="line">    <span class="keyword">if</span> (acquireQueued(node, savedState) &amp;&amp; interruptMode != THROW_IE) Â  Â </span><br><span class="line">        interruptMode = REINTERRUPT; Â  Â  Â  Â  Â  Â </span><br><span class="line">    <span class="comment">// æ¸…ç†æ¡ä»¶é˜Ÿåˆ— Â  Â  Â  Â  </span></span><br><span class="line">    <span class="keyword">if</span> (node.nextWaiter != <span class="keyword">null</span>)</span><br><span class="line">        <span class="comment">// clean up if cancelled Â  Â  Â </span></span><br><span class="line">        unlinkCancelledWaiters();</span><br><span class="line">	<span class="keyword">if</span> (interruptMode != <span class="number">0</span>) Â  Â </span><br><span class="line">    	reportInterruptAfterWait(interruptMode); Â  Â  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ­¤æ®µä»£ç çš„é€»è¾‘æ˜¯ï¼š é¦–å…ˆå°†å½“å‰çº¿ç¨‹æ–°å»ºä¸€ä¸ªèŠ‚ç‚¹åŒæ—¶åŠ å…¥åˆ°ç­‰å¾…é˜Ÿåˆ—ä¸­ï¼Œç„¶åé‡Šæ”¾å½“å‰çº¿ç¨‹æŒæœ‰çš„åŒæ­¥çŠ¶æ€ã€‚<br>ç„¶ååˆ™æ˜¯ä¸æ–­æ£€æµ‹è¯¥èŠ‚ç‚¹ä»£è¡¨çš„çº¿ç¨‹æ˜¯å¦å‡ºç°åœ¨CLHåŒæ­¥é˜Ÿåˆ—ä¸­ï¼ˆæ”¶åˆ°signalä¿¡å·ä¹‹åå°±ä¼šåœ¨AQSé˜Ÿåˆ— ä¸­æ£€æµ‹åˆ°ï¼‰ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™ä¸€ç›´æŒ‚èµ·ï¼Œå¦åˆ™å‚ä¸ç«äº‰åŒæ­¥çŠ¶æ€ã€‚</p>
<p><strong>åŠ å…¥æ¡ä»¶é˜Ÿåˆ—ï¼ˆaddConditionWaiter()ï¼‰æºç å¦‚ä¸‹</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Node <span class="title">addConditionWaiter</span><span class="params">()</span> </span>&#123; Â  </span><br><span class="line">    <span class="comment">//é˜Ÿåˆ—çš„å°¾èŠ‚ç‚¹ Â  Â  Â  Â  Â </span></span><br><span class="line">    Node t = lastWaiter; Â  Â  Â </span><br><span class="line">    <span class="comment">// If lastWaiter is cancelled, clean out. Â  Â  Â  Â  Â  </span></span><br><span class="line">    <span class="comment">// å¦‚æœè¯¥èŠ‚ç‚¹çš„çŠ¶æ€çš„ä¸æ˜¯CONDITIONï¼Œåˆ™è¯´æ˜è¯¥èŠ‚ç‚¹ä¸åœ¨ç­‰å¾…é˜Ÿåˆ—ä¸Šï¼Œéœ€è¦æ¸…é™¤ Â  Â  Â  </span></span><br><span class="line">    <span class="keyword">if</span> (t != <span class="keyword">null</span> &amp;&amp; t.waitStatus != Node.CONDITION) &#123; Â  Â  Â  </span><br><span class="line">        <span class="comment">// æ¸…é™¤ç­‰å¾…é˜Ÿåˆ—ä¸­çŠ¶æ€ä¸ä¸ºCONDITIONçš„èŠ‚ç‚¹ Â  Â  Â  Â  </span></span><br><span class="line">        unlinkCancelledWaiters(); Â  Â  Â  Â  Â  Â  Â  Â  </span><br><span class="line">        <span class="comment">//æ¸…é™¤åé‡æ–°è·å–å°¾èŠ‚ç‚¹ Â  Â  Â  Â  Â  </span></span><br><span class="line">        t = lastWaiter; Â  Â  Â  </span><br><span class="line">    &#125; Â  Â  Â  Â  Â  Â  Â  Â  </span><br><span class="line">    <span class="comment">// å°†å½“å‰çº¿ç¨‹æ„é€ æˆç­‰å¾…èŠ‚ç‚¹ Â  Â  </span></span><br><span class="line">    Node node = <span class="keyword">new</span> Node(Thread.currentThread(), Node.CONDITION); Â  Â  </span><br><span class="line">    <span class="comment">// å°†nodeèŠ‚ç‚¹æ·»åŠ åˆ°ç­‰å¾…é˜Ÿåˆ—çš„å°¾éƒ¨ Â  Â  Â </span></span><br><span class="line">    <span class="keyword">if</span> (t == <span class="keyword">null</span>) Â  Â  Â  Â  Â  </span><br><span class="line">        firstWaiter = node; Â  Â  Â  </span><br><span class="line">    <span class="keyword">else</span> Â  Â  Â  Â  Â  </span><br><span class="line">        t.nextWaiter = node; Â  Â  </span><br><span class="line">    lastWaiter = node; Â  Â  Â </span><br><span class="line">    <span class="keyword">return</span> node; Â  Â  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¯¥æ–¹æ³•ä¸»è¦æ˜¯å°†å½“å‰çº¿ç¨‹åŠ å…¥åˆ°Conditionæ¡ä»¶é˜Ÿåˆ—ä¸­ã€‚å½“ç„¶åœ¨åŠ å…¥åˆ°å°¾èŠ‚ç‚¹ä¹‹å‰ä¼šæ¸…é™¤æ‰€æœ‰çŠ¶æ€ä¸ä¸º Conditionçš„èŠ‚ç‚¹ã€‚<br>fullyRelease(Node node)ï¼Œè´Ÿè´£é‡Šæ”¾è¯¥çº¿ç¨‹æŒæœ‰çš„é”</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">int</span> <span class="title">fullyRelease</span><span class="params">(Node node)</span> </span>&#123; Â  Â  </span><br><span class="line">    <span class="keyword">boolean</span> failed = <span class="keyword">true</span>; Â  Â </span><br><span class="line">    <span class="keyword">try</span> &#123; Â  Â  Â  Â  Â  Â  Â  Â  </span><br><span class="line">        <span class="comment">// è·å–èŠ‚ç‚¹æŒæœ‰é”çš„æ•°é‡ Â  Â  Â  </span></span><br><span class="line">        <span class="keyword">int</span> savedState = getState(); Â  Â  Â  Â </span><br><span class="line">        <span class="comment">// é‡Šæ”¾é”ä¹Ÿå°±æ˜¯é‡Šæ”¾å…±äº«çŠ¶æ€ Â  Â  Â  </span></span><br><span class="line">        <span class="keyword">if</span> (release(savedState)) &#123; Â  Â  Â </span><br><span class="line">            failed = <span class="keyword">false</span>; Â  Â  Â  Â </span><br><span class="line">            <span class="keyword">return</span> savedState;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123; Â  Â  Â </span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalMonitorStateException(); </span><br><span class="line">        &#125; Â  Â  Â </span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123; Â </span><br><span class="line">        <span class="keyword">if</span> (failed) Â  Â  Â  </span><br><span class="line">            node.waitStatus = Node.CANCELLED; Â  </span><br><span class="line">    &#125; Â </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>isOnSyncQueue(Node node)ï¼šå¦‚æœä¸€ä¸ªèŠ‚ç‚¹åˆšå¼€å§‹åœ¨æ¡ä»¶é˜Ÿåˆ—ä¸Šï¼Œç°åœ¨åœ¨åŒæ­¥é˜Ÿåˆ—ä¸Šè·å–é”åˆ™è¿”å› trueã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">isOnSyncQueue</span><span class="params">(Node node)</span> </span>&#123; Â  Â </span><br><span class="line">	<span class="comment">// çŠ¶æ€ä¸ºCONDITION ã€å‰é©±èŠ‚ç‚¹ä¸ºç©ºï¼Œè¿”å›false Â  Â </span></span><br><span class="line">    <span class="keyword">if</span> (node.waitStatus == Node.CONDITION || node.prev == <span class="keyword">null</span>) Â  Â  Â  Â </span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>; Â  Â  Â  </span><br><span class="line">    <span class="comment">// å¦‚æœåç»§èŠ‚ç‚¹ä¸ä¸ºç©ºï¼Œåˆ™è¯´æ˜èŠ‚ç‚¹è‚¯å®šåœ¨åŒæ­¥é˜Ÿåˆ—ä¸­ Â  Â  Â  </span></span><br><span class="line">    <span class="keyword">if</span> (node.next != <span class="keyword">null</span>) </span><br><span class="line">        <span class="comment">// If has successor, it must be on queue Â  Â  Â  Â  Â  Â </span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>; Â  Â  </span><br><span class="line">    <span class="comment">/* Â  Â  Â  Â  </span></span><br><span class="line"><span class="comment">    * node.prev can be non-null, but not yet on queue because Â  Â </span></span><br><span class="line"><span class="comment">    * the CAS to place it on queue can fail. So we have to Â  Â  Â  Â  </span></span><br><span class="line"><span class="comment">    * traverse from tail to make sure it actually made it.  It Â  </span></span><br><span class="line"><span class="comment">    * will always be near the tail in calls to this method, and Â  Â </span></span><br><span class="line"><span class="comment">    * unless the CAS failed (which is unlikely), it will be Â  Â  </span></span><br><span class="line"><span class="comment">    * there, so we hardly ever traverse much. Â </span></span><br><span class="line"><span class="comment">    */</span> Â  Â  </span><br><span class="line">    <span class="keyword">return</span> findNodeFromTail(node); Â  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>unlinkCancelledWaiters()ï¼šè´Ÿè´£å°†æ¡ä»¶é˜Ÿåˆ—ä¸­çŠ¶æ€ä¸ä¸ºConditionçš„èŠ‚ç‚¹åˆ é™¤ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">unlinkCancelledWaiters</span><span class="params">()</span> </span>&#123; Â  Â  Â  </span><br><span class="line">    <span class="comment">// é¦–èŠ‚ç‚¹ Â  Â  Â  Â  Â  </span></span><br><span class="line">    Node t = firstWaiter; Â  Â  Â </span><br><span class="line">    Node trail = <span class="keyword">null</span>; Â  Â  Â </span><br><span class="line">    <span class="comment">// ä»å¤´å¼€å§‹æ¸…é™¤çŠ¶æ€ä¸ä¸ºCONDITIONçš„èŠ‚ç‚¹ Â  Â  Â  </span></span><br><span class="line">    <span class="keyword">while</span> (t != <span class="keyword">null</span>) &#123; Â  Â  Â  Â  Â </span><br><span class="line">        Node next = t.nextWaiter; Â  Â  Â  Â  Â </span><br><span class="line">        <span class="keyword">if</span> (t.waitStatus != Node.CONDITION) &#123; Â  </span><br><span class="line">            t.nextWaiter = <span class="keyword">null</span>; Â  Â  Â  </span><br><span class="line">            <span class="keyword">if</span> (trail == <span class="keyword">null</span>) Â  Â  Â  Â </span><br><span class="line">                firstWaiter = next; Â </span><br><span class="line">            <span class="keyword">else</span> Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â </span><br><span class="line">                trail.nextWaiter = next; Â  Â  Â </span><br><span class="line">            <span class="keyword">if</span> (next == <span class="keyword">null</span>) Â  Â  Â  </span><br><span class="line">                lastWaiter = trail; Â  Â  Â  Â </span><br><span class="line">        &#125; Â  Â  Â  Â  Â  Â  Â  </span><br><span class="line">        <span class="keyword">else</span> Â  Â  Â  Â  Â  Â  </span><br><span class="line">            trail = t; Â  Â  Â  </span><br><span class="line">        t = next;</span><br><span class="line">	&#125; Â  Â  Â  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>é€šçŸ¥</strong></p>
<p>è°ƒç”¨Conditionçš„signal()æ–¹æ³•ï¼Œå°†ä¼šå”¤é†’åœ¨ç­‰å¾…é˜Ÿåˆ—ä¸­ç­‰å¾…é•¿æ—¶é—´çš„èŠ‚ç‚¹ï¼ˆæ¡ä»¶é˜Ÿåˆ—é‡Œçš„é¦–èŠ‚ ç‚¹ï¼‰ï¼Œåœ¨å”¤é†’èŠ‚ç‚¹å‰ï¼Œä¼šå°†èŠ‚ç‚¹ç§»åˆ°åŒæ­¥é˜Ÿåˆ—ä¸­ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">signal</span><span class="params">()</span> </span>&#123;</span><br><span class="line"> Â  Â  Â  Â  Â  Â <span class="comment">// å¦‚æœåŒæ­¥æ˜¯ä»¥ç‹¬å æ–¹å¼è¿›è¡Œçš„ï¼Œåˆ™è¿”å› trueï¼›å…¶ä»–æƒ…å†µåˆ™è¿”å› false Â </span></span><br><span class="line">    <span class="keyword">if</span> (!isHeldExclusively()) Â  Â  Â  Â  Â  </span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalMonitorStateException(); Â  Â  Â  Â  </span><br><span class="line">    <span class="comment">// å”¤é†’é¦–èŠ‚ç‚¹ Â  Â  Â  Â  </span></span><br><span class="line">    Node first = firstWaiter; Â  Â  Â  Â  Â  Â  </span><br><span class="line">    <span class="keyword">if</span> (first != <span class="keyword">null</span>) Â  Â  Â  Â </span><br><span class="line">        doSignal(first); Â  Â  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¯¥æ–¹æ³•é¦–å…ˆä¼šåˆ¤æ–­å½“å‰çº¿ç¨‹æ˜¯å¦å·²ç»è·å¾—äº†é”ï¼Œè¿™æ˜¯å‰ç½®æ¡ä»¶ã€‚ç„¶åå”¤é†’æ¡ä»¶é˜Ÿåˆ—ä¸­çš„å¤´èŠ‚ç‚¹ã€‚<br>doSignal(Node first)ï¼šå”¤é†’å¤´èŠ‚ç‚¹</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">doSignal</span><span class="params">(Node first)</span> </span>&#123; Â  Â  Â  Â  </span><br><span class="line">    <span class="keyword">do</span> &#123; Â  Â  Â  Â  Â  Â  </span><br><span class="line">        <span class="comment">// ä¿®æ”¹å¤´èŠ‚ç‚¹ã€æ–¹ä¾¿ç§»é™¤ Â  Â  Â  Â  Â </span></span><br><span class="line">        <span class="keyword">if</span> ( (firstWaiter = first.nextWaiter) == <span class="keyword">null</span>) Â  Â  Â </span><br><span class="line">            lastWaiter = <span class="keyword">null</span>; Â  Â  Â  Â </span><br><span class="line">        first.nextWaiter = <span class="keyword">null</span>; Â  Â  Â  Â  Â  Â  Â </span><br><span class="line">        <span class="comment">// å°†è¯¥èŠ‚ç‚¹ç§»åˆ°åŒæ­¥é˜Ÿåˆ— Â  Â  Â </span></span><br><span class="line">    &#125; <span class="keyword">while</span> (!transferForSignal(first) &amp;&amp; Â  Â  </span><br><span class="line">             (first = firstWaiter) != <span class="keyword">null</span>); Â  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>doSignal(Node first)ä¸»è¦æ˜¯åšä¸¤ä»¶äº‹ï¼š</p>
<ul>
<li>ä¿®æ”¹å¤´èŠ‚ç‚¹ï¼›</li>
<li>è°ƒç”¨transferForSignal(Node first) æ–¹æ³•å°†èŠ‚ç‚¹ç§»åŠ¨åˆ°CLHåŒæ­¥é˜Ÿåˆ—ä¸­ã€‚</li>
</ul>
<p>æ•´ä¸ªé€šçŸ¥çš„æµç¨‹å¦‚ä¸‹ï¼š</p>
<ul>
<li>åˆ¤æ–­å½“å‰çº¿ç¨‹æ˜¯å¦å·²ç»è·å–äº†é”ï¼Œå¦‚æœæ²¡æœ‰è·å–åˆ™ç›´æ¥æŠ›å‡ºå¼‚å¸¸ï¼Œå› ä¸ºè·å–é”ä¸ºé€šçŸ¥çš„å‰ç½®æ¡ä»¶ã€‚ </li>
<li>å¦‚æœçº¿ç¨‹å·²ç»è·å–äº†é”ï¼Œåˆ™å°†å”¤é†’æ¡ä»¶é˜Ÿåˆ—çš„é¦–èŠ‚ç‚¹ã€‚ </li>
<li>å”¤é†’é¦–èŠ‚ç‚¹æ˜¯å…ˆå°†æ¡ä»¶é˜Ÿåˆ—ä¸­çš„å¤´èŠ‚ç‚¹ç§»å‡ºï¼Œç„¶åè°ƒç”¨AQSçš„enq(Node node)æ–¹æ³•å°†å…¶å®‰å…¨åœ°ç§» åˆ°CLHåŒæ­¥é˜Ÿåˆ—ä¸­ ã€‚ </li>
<li>æœ€ååˆ¤æ–­å¦‚æœè¯¥èŠ‚ç‚¹çš„åŒæ­¥çŠ¶æ€æ˜¯å¦ä¸ºCancelï¼Œæˆ–è€…ä¿®æ”¹çŠ¶æ€ä¸ºSignalå¤±è´¥æ—¶ï¼Œåˆ™ç›´æ¥è°ƒç”¨ LockSupportå”¤é†’è¯¥èŠ‚ç‚¹çš„çº¿ç¨‹ã€‚</li>
</ul>
<p>ä¸€ä¸ªçº¿ç¨‹è·å–é”åï¼Œé€šè¿‡è°ƒç”¨Conditionçš„await()æ–¹æ³•ï¼Œä¼šå°†å½“å‰çº¿ç¨‹å…ˆåŠ å…¥åˆ°æ¡ä»¶é˜Ÿåˆ—ä¸­ï¼Œç„¶åé‡Š æ”¾é”ï¼Œåé€šè¿‡isOnSyncQueue(Node node)æ–¹æ³•ä¸æ–­è‡ªæ£€çœ‹èŠ‚ç‚¹æ˜¯å¦å·²ç»åœ¨CLHåŒæ­¥é˜Ÿåˆ—äº†ï¼Œå¦‚æœæ˜¯ åˆ™å°è¯•è·å–é”ï¼Œå¦åˆ™ä¸€ç›´æŒ‚èµ·ã€‚<br>å½“çº¿ç¨‹è°ƒç”¨signal()æ–¹æ³•åï¼Œç¨‹åºé¦–å…ˆæ£€æŸ¥å½“å‰çº¿ç¨‹æ˜¯å¦è·å–äº†é”ï¼Œç„¶åé€šè¿‡doSignal(Node first)æ–¹æ³•å”¤é†’CLHåŒæ­¥é˜Ÿåˆ—çš„é¦–èŠ‚ç‚¹ã€‚è¢«å”¤é†’çš„çº¿ç¨‹ï¼Œå°†ä»await()æ–¹æ³•ä¸­çš„whileå¾ªç¯ä¸­é€€å‡ºæ¥ï¼Œ ç„¶åè°ƒç”¨acquireQueued()æ–¹æ³•ç«äº‰åŒæ­¥çŠ¶æ€ã€‚<br>æ —å­ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BoundedBuffer</span> </span>&#123; Â </span><br><span class="line">    <span class="keyword">final</span> Lock lock = <span class="keyword">new</span> ReentrantLock(); </span><br><span class="line">    <span class="keyword">final</span> Condition notFull Â = lock.newCondition();  </span><br><span class="line">    <span class="keyword">final</span> Condition notEmpty = lock.newCondition(); </span><br><span class="line">    </span><br><span class="line"> Â   <span class="keyword">final</span> Object[] items = <span class="keyword">new</span> Object[<span class="number">100</span>];</span><br><span class="line">    <span class="keyword">int</span> putptr, takeptr, count;</span><br><span class="line">    </span><br><span class="line"> Â   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">put</span><span class="params">(Object x)</span> <span class="keyword">throws</span> InterruptedException </span>&#123; </span><br><span class="line">        </span><br><span class="line">       lock.lock(); Â  Â  </span><br><span class="line">        <span class="keyword">try</span> &#123; Â  Â </span><br><span class="line">           <span class="keyword">while</span> (count == items.length) Â  Â </span><br><span class="line">               notFull.await(); Â  Â </span><br><span class="line">            items[putptr] = x; Â  Â </span><br><span class="line">            <span class="keyword">if</span> (++putptr == items.length) putptr = <span class="number">0</span>; Â  </span><br><span class="line">            ++count; Â  Â </span><br><span class="line">            notEmpty.signal(); </span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123; Â  Â  Â </span><br><span class="line">            lock.unlock(); Â  Â </span><br><span class="line">        &#125; </span><br><span class="line">    &#125;</span><br><span class="line"> Â  <span class="function"><span class="keyword">public</span> Object <span class="title">take</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123; </span><br><span class="line">       lock.lock(); Â  Â </span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line"> 			<span class="keyword">while</span> (count == <span class="number">0</span>) Â  </span><br><span class="line">                notEmpty.await(); </span><br><span class="line">           Object x = items[takeptr]; Â  </span><br><span class="line">           <span class="keyword">if</span> (++takeptr == items.length) takeptr = <span class="number">0</span>; </span><br><span class="line">           --count; Â  Â  Â </span><br><span class="line">           notFull.signal(); Â  Â  </span><br><span class="line">           <span class="keyword">return</span> x; Â </span><br><span class="line">       &#125; <span class="keyword">finally</span> &#123; </span><br><span class="line">           lock.unlock(); Â  </span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</div><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">æ–‡ç« ä½œè€…: </span><span class="post-copyright-info"><a href="mailto:undefined">Frosro</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">æ–‡ç« é“¾æ¥: </span><span class="post-copyright-info"><a href="https://frosro.github.io/2021/01/09/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%EF%BC%88%E4%B8%89%EF%BC%89/">https://frosro.github.io/2021/01/09/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%EF%BC%88%E4%B8%89%EF%BC%89/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">ç‰ˆæƒå£°æ˜: </span><span class="post-copyright-info">æœ¬åšå®¢æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ«å£°æ˜å¤–ï¼Œå‡é‡‡ç”¨ <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> è®¸å¯åè®®ã€‚è½¬è½½è¯·æ³¨æ˜æ¥è‡ª <a href="https://frosro.github.io" target="_blank">BETTER LATE THAN NEVER</a>ï¼</span></div></div><div class="tag_share"><div class="post-meta__tag-list"></div><div class="post_share"><div class="social-share" data-image="/img/post.jpg" data-sites="wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"/><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js"></script></div></div><div class="post-reward"><a class="reward-button button--primary button--animated"> <i class="fa fa-qrcode"></i> æ‰“èµ<div class="reward-main"><ul class="reward-all"><li class="reward-item"><img class="lazyload post-qr-code__img" src="/img/wechat.jpg" alt="å¾®ä¿¡"/><div class="post-qr-code__desc">å¾®ä¿¡</div></li><li class="reward-item"><img class="lazyload post-qr-code__img" src="/img/alipay.jpg" alt="æ”¯ä»˜å®"/><div class="post-qr-code__desc">æ”¯ä»˜å®</div></li></ul></div></a></div><nav class="pagination_post" id="pagination"><div class="next-post pull-full"><a href="/2021/01/08/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%EF%BC%88%E4%BA%8C%EF%BC%89/"><img class="next_cover lazyload" data-src="/img/post.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">ä¸‹ä¸€ç¯‡</div><div class="next_info">å¹¶å‘ç¼–ç¨‹ï¼ˆäºŒï¼‰</div></div></a></div></nav><hr><div id="post-comment"><div class="comment_headling"><i class="fa fa-comments fa-fw" aria-hidden="true"></i><span> è¯„è®º</span></div><div id="lv-container" data-id="city" data-uid="MTAyMC80OTMzNS8yNTgyNw=="><script>(function(d, s) {
    var j, e = d.getElementsByTagName(s)[0];
    if (typeof LivereTower === 'function') { return; }
    j = d.createElement(s);
    j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
    j.async = true;
    e.parentNode.insertBefore(j, e);
})(document, 'script');</script></div></div></article></main><footer id="footer" data-type="color"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2021 By Frosro</div><div class="framework-info"><span>é©±åŠ¨ </span><a href="https://hexo.io" target="_blank" rel="noopener"><span>Hexo</span></a><span class="footer-separator">|</span><span>ä¸»é¢˜ </span><a href="https://github.com/jerryc127/hexo-theme-butterfly" target="_blank" rel="noopener"><span>Butterfly</span></a></div><div class="footer_custom_text">-------------éå¸¸æ¬¢è¿ <i class="fa fa-paw"></i> æ¥åˆ°æˆ‘çš„åšå®¢-------------</div></div></footer></div><section class="rightside" id="rightside"><div id="rightside-config-hide"><i class="fa fa-book" id="readmode" title="é˜…è¯»æ¨¡å¼"></i><i class="fa fa-plus" id="font_plus" title="æ”¾å¤§å­—ä½“"></i><i class="fa fa-minus" id="font_minus" title="ç¼©å°å­—ä½“"></i><a class="translate_chn_to_cht" id="translateLink" href="javascript:translatePage();" title="ç®€ç¹è½¬æ¢" target="_self">ç¹</a></div><div id="rightside-config-show"><div id="rightside_config" title="è®¾ç½®"><i class="fa fa-cog" aria-hidden="true"></i></div><a id="to_comment" href="#post-comment" title="ç›´è¾¾è¯„è®º"><i class="scroll_to_comment fa fa-comments">  </i></a><i class="fa fa-list-ul close" id="mobile-toc-button" title="ç›®å½•" aria-hidden="true"></i><i class="fa fa-arrow-up" id="go-up" title="å›åˆ°é¡¶éƒ¨" aria-hidden="true"></i></div></section><div class="search-dialog" id="local-search"><div class="search-dialog__title" id="local-search-title">æœ¬åœ°æœç´¢</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="æœç´¢æ–‡ç« " type="text"/></div></div></div><hr/><div id="local-search-results"><div id="local-hits"></div><div id="local-stats"><div class="local-search-stats__hr" id="hr"><span>ç”±</span> <a href="https://github.com/wzpan/hexo-generator-search" target="_blank" rel="noopener" style="color:#49B1F5;">hexo-generator-search</a>
 <span>æä¾›æ”¯æŒ</span></div></div></div><span class="search-close-button"><i class="fa fa-times"></i></span></div><div class="search-mask"></div><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="/js/third-party/fireworks.js"></script><script id="ribbon_piao" mobile="false" src="/js/third-party/piao.js"></script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page@latest/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/lazysizes@latest/lazysizes.min.js" async=""></script><script src="/js/search/local-search.js"></script></body></html>